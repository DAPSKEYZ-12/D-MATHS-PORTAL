<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<meta name="theme-color" content="#060E1A"/>
<title>D-Maths Tuition Centre — Excellence in Mathematics</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Righteous&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600;1,700&family=Plus+Jakarta+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --navy:#0A1628;--navy-d:#060E1A;--navy-m:#132240;--navy-l:#1C3260;
  --gold:#D4A017;--gold-b:#F2BC3B;--gold-pale:#FDF6E3;--gold-dark:#A87C12;
  --cream:#FAF7F0;--bg:#F0F2F7;--white:#FFFFFF;
  --g50:#F8FAFC;--g100:#F1F5F9;--g200:#E2E8F0;--g300:#CBD5E1;
  --g400:#94A3B8;--g500:#64748B;--g700:#334155;--g900:#0F172A;
  --green:#059669;--green-bg:#D1FAE5;--green-t:#064E3B;
  --red:#DC2626;--red-bg:#FEE2E2;--red-t:#7F1D1D;
  --blue:#2563EB;--blue-bg:#DBEAFE;--blue-t:#1E3A8A;
  --amber:#D97706;--amber-bg:#FEF3C7;--amber-t:#78350F;
  --purple:#7C3AED;--purple-bg:#EDE9FE;
  --sh:0 1px 3px rgba(10,22,40,.08),0 4px 16px rgba(10,22,40,.05);
  --sh-m:0 6px 20px rgba(10,22,40,.12);--sh-l:0 12px 40px rgba(10,22,40,.16);
  --sh-xl:0 24px 80px rgba(10,22,40,.24);
  --r:10px;--r-l:16px;--r-xl:22px;
  --sidebar-w:260px;--topbar-h:62px;
  --font-logo:'Righteous',cursive;
  --font-display:'Cormorant Garamond',Georgia,serif;
  --font-body:'Plus Jakarta Sans',system-ui,sans-serif;
  --font-mono:'Fira Code',monospace;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{font-family:var(--font-body);background:var(--bg);color:var(--g900);-webkit-font-smoothing:antialiased;overflow-x:hidden}
a{color:inherit;text-decoration:none}
button{font-family:var(--font-body);cursor:pointer}
input,textarea,select{font-family:var(--font-body)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--g200);border-radius:99px}

/* ═══ ANIMATIONS ═══ */
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-16px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.65;transform:scale(.95)}}
@keyframes loadBar{from{width:0}to{width:100%}}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(212,160,23,.3)}50%{box-shadow:0 0 40px rgba(212,160,23,.6)}}
.fu{animation:fadeUp .55s cubic-bezier(.22,.68,0,1.15) both}
.fu1{animation:fadeUp .55s cubic-bezier(.22,.68,0,1.15) .1s both}
.fu2{animation:fadeUp .55s cubic-bezier(.22,.68,0,1.15) .2s both}
.fu3{animation:fadeUp .55s cubic-bezier(.22,.68,0,1.15) .3s both}
.fu4{animation:fadeUp .55s cubic-bezier(.22,.68,0,1.15) .4s both}
.fi{animation:fadeIn .35s ease both}
.si{animation:scaleIn .35s cubic-bezier(.22,.68,0,1.2) both}

/* ═══ VIEWS ═══ */
.view{display:none!important}.view.on{display:block!important}

/* ═══ BUTTONS ═══ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:var(--r);font-family:var(--font-body);font-weight:700;font-size:14.5px;cursor:pointer;white-space:nowrap;line-height:1;-webkit-tap-highlight-color:transparent;min-height:44px;padding:0 22px;transition:all .22s cubic-bezier(.22,.68,0,1.2);outline:none;letter-spacing:.01em}
.btn:active{transform:scale(.95)!important}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}
.btn-gold{background:linear-gradient(135deg,var(--gold),var(--gold-b));color:var(--navy-d);box-shadow:0 3px 12px rgba(212,160,23,.35)}
.btn-gold:hover{box-shadow:0 8px 24px rgba(212,160,23,.5);transform:translateY(-2px)}
.btn-navy{background:var(--navy);color:#fff}
.btn-navy:hover{background:var(--navy-m);box-shadow:0 8px 24px rgba(10,22,40,.35);transform:translateY(-2px)}
.btn-og{background:transparent;color:var(--gold);border:2px solid var(--gold)}
.btn-og:hover{background:var(--gold);color:var(--navy-d);transform:translateY(-2px)}
.btn-ow{background:transparent;color:#fff;border:2px solid rgba(255,255,255,.35)}
.btn-ow:hover{background:rgba(255,255,255,.1);border-color:#fff}
.btn-ghost{background:var(--g100);color:var(--g700);border:1.5px solid var(--g200)}
.btn-ghost:hover{background:var(--g200);color:var(--g900)}
.btn-ok{background:var(--green);color:#fff}.btn-ok:hover{background:#047857;transform:translateY(-1px)}
.btn-err{background:var(--red);color:#fff}.btn-err:hover{background:#b91c1c;transform:translateY(-1px)}
.btn-sm{min-height:36px;padding:0 16px;font-size:13px;border-radius:8px}
.btn-xs{min-height:30px;padding:0 10px;font-size:12px;border-radius:7px}
.btn-ico{min-height:36px;width:36px;padding:0;border-radius:9px;flex-shrink:0}
.btn-lg{min-height:54px;padding:0 32px;font-size:16px;border-radius:12px}
.btn-w{width:100%}

/* ═══ BADGES ═══ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:99px;font-size:11px;font-weight:800;letter-spacing:.03em}
.b-green{background:var(--green-bg);color:var(--green-t)}
.b-red{background:var(--red-bg);color:var(--red-t)}
.b-amber{background:var(--amber-bg);color:var(--amber-t)}
.b-blue{background:var(--blue-bg);color:var(--blue-t)}
.b-gray{background:var(--g100);color:var(--g500)}
.b-navy{background:var(--navy);color:#fff}
.b-gold{background:var(--gold-pale);color:var(--gold-dark)}
.b-purple{background:var(--purple-bg);color:var(--purple)}

/* ═══ CARDS ═══ */
.card{background:var(--white);border-radius:var(--r-l);box-shadow:var(--sh);overflow:hidden}
.cp{padding:22px}
@media(min-width:640px){.cp{padding:26px}}
.card-hov{transition:transform .22s,box-shadow .22s}
.card-hov:hover{transform:translateY(-3px);box-shadow:var(--sh-m)}

/* ═══ FORMS ═══ */
.fg{margin-bottom:18px}
.fl{display:block;font-size:13px;font-weight:700;color:var(--g700);margin-bottom:7px;letter-spacing:.01em}
.freq{color:var(--red);margin-left:3px}
.fi-el{border:1.5px solid var(--g200);border-radius:var(--r);padding:11px 16px;width:100%;background:var(--white);color:var(--g900);font-size:14px;transition:border-color .18s,box-shadow .18s;line-height:1.5;outline:none;font-family:var(--font-body)}
.fi-el::placeholder{color:var(--g400)}
.fi-el:focus{border-color:var(--gold);box-shadow:0 0 0 3.5px rgba(212,160,23,.15)}
textarea.fi-el{resize:vertical;min-height:96px}
select.fi-el{appearance:none;cursor:pointer;background:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394A3B8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 12px center/16px;padding-right:40px}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:500px){.frow{grid-template-columns:1fr}}

/* ═══ ALERTS & TOASTS ═══ */
.al{border-radius:var(--r);padding:12px 16px;margin-bottom:16px;display:flex;gap:10px;align-items:flex-start;font-size:13.5px;font-weight:600;line-height:1.5}
.al-i{background:var(--amber-bg);border:1px solid rgba(217,119,6,.22);color:var(--amber-t)}
.al-e{background:var(--red-bg);border:1px solid rgba(220,38,38,.22);color:var(--red-t)}
.al-s{background:var(--green-bg);border:1px solid rgba(5,150,105,.22);color:var(--green-t)}
.toast-host{position:fixed;top:18px;right:18px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;max-width:calc(100vw - 36px)}
.toast{background:var(--navy);color:#fff;padding:13px 18px;border-radius:var(--r);font-size:13.5px;font-weight:600;box-shadow:var(--sh-l);display:flex;align-items:center;gap:10px;animation:fadeUp .3s ease;min-width:260px;max-width:360px;pointer-events:all}
.toast-s{border-left:3px solid var(--green)}.toast-e{border-left:3px solid var(--red)}.toast-i{border-left:3px solid var(--gold)}

/* ═══ MODAL ═══ */
.ov{position:fixed;inset:0;background:rgba(6,14,26,.65);backdrop-filter:blur(10px);z-index:400;animation:fadeIn .22s ease;display:none;align-items:flex-end;justify-content:center}
.ov.open{display:flex}
@media(min-width:640px){.ov{align-items:center}}
.modal{background:var(--white);width:100%;max-width:540px;border-radius:var(--r-xl) var(--r-xl) 0 0;box-shadow:var(--sh-xl);max-height:92vh;overflow-y:auto;animation:slideUp .32s cubic-bezier(.22,.68,0,1.2)}
@media(min-width:640px){.modal{border-radius:var(--r-xl);max-height:88vh;animation-name:scaleIn}}
.modal.wide{max-width:660px}
.mhandle{width:40px;height:4px;background:var(--g200);border-radius:99px;margin:12px auto 0}
@media(min-width:640px){.mhandle{display:none}}
.mhdr{position:sticky;top:0;background:var(--white);padding:18px 24px 14px;border-bottom:1px solid var(--g100);display:flex;align-items:center;justify-content:space-between;z-index:1;border-radius:var(--r-xl) var(--r-xl) 0 0}
.mtitle{font-family:var(--font-display);font-weight:700;font-size:20px;color:var(--g900)}
.mbody{padding:20px 24px 28px}

/* ═══ MISC ═══ */
.div{height:1px;background:var(--g100);margin:14px 0}
.chip{display:inline-flex;align-items:center;gap:5px;background:var(--g100);color:var(--g700);border-radius:99px;padding:4px 12px;font-size:12px;font-weight:700}
.chip-gold{background:var(--gold-pale);color:var(--gold-dark)}
.chip-navy{background:var(--navy);color:#fff}
.pt{background:var(--g100);border-radius:99px;height:7px;overflow:hidden}
.pf{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--gold),var(--gold-b));transition:width 1.2s cubic-bezier(.22,.68,0,1.2)}
.spinner{width:18px;height:18px;border:2.5px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .65s linear infinite;flex-shrink:0}
.spd{border-color:rgba(10,22,40,.12);border-top-color:var(--navy)}
.av{border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;flex-shrink:0;font-family:var(--font-body);letter-spacing:.02em}

/* ═══ TABLES ═══ */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;min-width:560px}
th{text-align:left;padding:10px 14px;font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.08em;color:var(--g400);border-bottom:1.5px solid var(--g100);background:var(--g50);white-space:nowrap}
td{padding:13px 14px;font-size:13.5px;color:var(--g700);border-bottom:1px solid var(--g100);vertical-align:middle}
tr:last-child td{border-bottom:none}
tbody tr{transition:background .1s}
tbody tr:hover td{background:var(--g50)}

/* ═══ STAT CARD ═══ */
.sc{background:var(--white);border-radius:var(--r-l);padding:20px;box-shadow:var(--sh);transition:transform .22s,box-shadow .22s}
.sc:hover{transform:translateY(-3px);box-shadow:var(--sh-m)}

/* ═══ GRIDS ═══ */
.g2{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.gdash{display:grid;grid-template-columns:1.4fr 1fr;gap:20px}
.gprog{display:grid;grid-template-columns:1.5fr 1fr;gap:20px}
.gcls{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
.gsdet{display:grid;grid-template-columns:300px 1fr;gap:22px;align-items:start}
@media(max-width:1100px){.g4{grid-template-columns:repeat(2,1fr)}.gdash{grid-template-columns:1fr}}
@media(max-width:900px){.gprog{grid-template-columns:1fr}.g3{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.g2,.gcls{grid-template-columns:1fr}.g3{grid-template-columns:1fr}.g4{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){.g4{grid-template-columns:1fr}}
@media(max-width:1000px){.gsdet{grid-template-columns:1fr}}

/* ═══ LANDING NAV ═══ */
#lnav{position:fixed;top:0;left:0;right:0;z-index:900;padding:0 clamp(16px,4vw,72px);height:74px;display:flex;align-items:center;transition:all .3s}
#lnav.scrolled{background:rgba(6,14,26,.94);backdrop-filter:blur(24px);border-bottom:1px solid rgba(255,255,255,.06);box-shadow:0 4px 32px rgba(0,0,0,.2);height:64px}
.lnav-i{display:flex;align-items:center;justify-content:space-between;width:100%;max-width:1280px;margin:0 auto}
.llinks{display:flex;align-items:center;gap:2px}
@media(max-width:920px){.llinks{display:none}.lportal{display:none!important}}
.llink{color:rgba(255,255,255,.68);font-size:14px;font-weight:600;padding:8px 14px;border-radius:8px;cursor:pointer;border:none;background:none;font-family:var(--font-body);transition:all .16s;letter-spacing:.01em}
.llink:hover{color:#fff;background:rgba(255,255,255,.1)}

/* ═══ MOBILE DRAWER ═══ */
#mdrawer{position:fixed;inset:0;z-index:1000;background:var(--navy-d);transform:translateX(-100%);transition:transform .3s cubic-bezier(.22,.68,0,1.2);display:flex;flex-direction:column;overflow-y:auto}
#mdrawer.open{transform:translateX(0)}
.dlink{background:none;border:none;color:rgba(255,255,255,.7);font-family:var(--font-display);font-size:22px;font-weight:700;padding:16px 24px;text-align:left;width:100%;cursor:pointer;border-radius:var(--r);transition:all .15s}
.dlink:hover{background:rgba(255,255,255,.07);color:#fff}

/* ═══ HERO ═══ */
.hero{min-height:100vh;position:relative;overflow:hidden;background:var(--navy-d);display:flex;align-items:center;padding:0 clamp(16px,4vw,72px)}
.hero-grid{max-width:1280px;margin:0 auto;width:100%;display:grid;grid-template-columns:1fr 1fr;gap:60px;align-items:center;padding-top:90px;padding-bottom:40px}
@media(max-width:880px){.hero-grid{grid-template-columns:1fr;padding-top:110px;text-align:center;gap:40px}}
@media(max-width:880px){.hero-grid>div:last-child{display:none}}
.h1{font-family:var(--font-display);font-size:clamp(42px,5.5vw,80px);font-weight:800;line-height:1.04;color:#fff;letter-spacing:-.02em}
.h1 em{font-style:italic;color:var(--gold-b);font-family:var(--font-display)}
.msym{position:absolute;font-family:var(--font-mono);color:rgba(255,255,255,.04);font-weight:500;pointer-events:none;user-select:none;line-height:1}

/* ═══ SECTIONS ═══ */
.sec{padding:clamp(60px,8vw,120px) clamp(16px,4vw,72px)}
.sec-i{max-width:1280px;margin:0 auto}
.eyebrow{font-family:var(--font-mono);font-size:11.5px;font-weight:500;text-transform:uppercase;letter-spacing:.2em;color:var(--gold);display:flex;align-items:center;gap:10px;margin-bottom:14px}
.eyebrow::before{content:'';width:28px;height:2px;background:var(--gold);display:inline-block}
.stitle{font-family:var(--font-display);font-size:clamp(32px,4.5vw,56px);font-weight:800;line-height:1.1;color:var(--g900)}
.stitle.lt{color:#fff}
.ssub{font-size:clamp(15px,1.8vw,17px);color:var(--g500);line-height:1.8;max-width:600px}
.ssub.lt{color:rgba(255,255,255,.58)}
.sctr .eyebrow{justify-content:center}

/* ═══ SUBJECT CARD ═══ */
.scard{border-radius:var(--r-l);overflow:hidden;background:linear-gradient(145deg,var(--navy),var(--navy-m));padding:28px;border:1px solid rgba(255,255,255,.07);transition:all .3s;position:relative}
.scard:hover{transform:translateY(-6px);box-shadow:var(--sh-l);border-color:rgba(212,160,23,.25)}
.scard::after{content:'';position:absolute;bottom:-30px;right:-30px;width:130px;height:130px;border-radius:50%;background:radial-gradient(rgba(212,160,23,.14),transparent 70%)}

/* ═══ TESTIMONIAL CARD ═══ */
.tcard{background:var(--white);border-radius:var(--r-l);padding:28px;box-shadow:var(--sh);border:1px solid var(--g100);transition:all .25s;position:relative}
.tcard:hover{transform:translateY(-4px);box-shadow:var(--sh-m);border-color:rgba(212,160,23,.3)}
.tcard::before{content:'"';position:absolute;top:14px;right:20px;font-family:var(--font-display);font-size:88px;color:var(--g100);line-height:1;font-weight:800;pointer-events:none}

/* ═══ STAT COUNTER ═══ */
.scount{font-family:var(--font-display);font-size:clamp(38px,5vw,64px);font-weight:800;color:var(--gold-b);line-height:1}

/* ═══ GATEWAY ═══ */
.gw{min-height:100vh;background:var(--navy-d);display:flex;align-items:center;justify-content:center;padding:24px;position:relative;overflow:hidden}
.gwcard{background:var(--white);border-radius:var(--r-xl);box-shadow:var(--sh-xl);overflow:hidden;width:100%;max-width:480px;animation:scaleIn .38s cubic-bezier(.22,.68,0,1.2)}
.gwhdr{background:linear-gradient(145deg,var(--navy-d),var(--navy-m));padding:30px 28px;position:relative;overflow:hidden}

/* ═══ SIGNUP ═══ */
.suhdr{background:linear-gradient(135deg,var(--navy-d),var(--navy-m));padding:20px clamp(16px,4vw,60px);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}

/* ═══ PORTAL SIDEBAR ═══ */
#psidebar{position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);background:linear-gradient(180deg,var(--navy-d) 0%,#0d1e38 100%);display:flex;flex-direction:column;z-index:300;transition:transform .3s cubic-bezier(.22,.68,0,1.2);overflow-y:auto}
@media(max-width:1023px){#psidebar{transform:translateX(-100%)}#psidebar.open{transform:translateX(0);box-shadow:var(--sh-xl)}}
#ptopbar{display:none;position:fixed;top:0;left:0;right:0;height:var(--topbar-h);background:var(--navy-d);z-index:200;align-items:center;justify-content:space-between;padding:0 16px;border-bottom:1px solid rgba(255,255,255,.07)}
@media(max-width:1023px){#ptopbar{display:flex}}
#pmain{padding:20px 16px 100px}
@media(min-width:640px){#pmain{padding:28px 24px 100px}}
@media(min-width:1024px){#pmain{margin-left:var(--sidebar-w);padding:38px 36px 60px}}
.pmc{padding-top:calc(var(--topbar-h) + 20px)!important}
@media(min-width:1024px){.pmc{padding-top:38px!important}}
#sovl{display:none;position:fixed;inset:0;background:rgba(6,14,26,.58);backdrop-filter:blur(6px);z-index:299}
#sovl.open{display:block;animation:fadeIn .22s ease}
.nl{display:flex;align-items:center;gap:11px;padding:10px 14px;border-radius:var(--r);cursor:pointer;transition:all .16s;font-size:13.5px;font-weight:600;color:rgba(255,255,255,.5);border:none;background:none;width:100%;min-height:46px;font-family:var(--font-body);-webkit-tap-highlight-color:transparent;letter-spacing:.01em}
.nl:hover{background:rgba(255,255,255,.08);color:rgba(255,255,255,.9)}
.nl.act{background:linear-gradient(135deg,var(--gold),var(--gold-b));color:var(--navy-d);font-weight:800;box-shadow:0 3px 14px rgba(212,160,23,.35)}
.nbadge{background:var(--red);color:#fff;border-radius:99px;font-size:10px;font-weight:800;padding:1px 7px;min-width:18px;text-align:center}
#pbnav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--white);border-top:1.5px solid var(--g100);padding:6px 0 max(6px,env(safe-area-inset-bottom));z-index:200;justify-content:space-around;box-shadow:0 -6px 24px rgba(10,22,40,.1)}
@media(max-width:1023px){#pbnav{display:flex}}
.bni{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:5px 8px;border-radius:9px;color:var(--g400);transition:color .14s;-webkit-tap-highlight-color:transparent;min-width:48px;border:none;background:none;font-family:var(--font-body)}
.bni.act{color:var(--gold)}
.bni span{font-size:10px;font-weight:800;letter-spacing:.01em}

/* ═══ PORTAL PAGES ═══ */
.pg{display:none}.pg.on{display:block;animation:fadeIn .3s ease}
.phdr{display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px}
.ptitle{font-family:var(--font-display);font-size:clamp(20px,3vw,30px);font-weight:800;color:var(--g900)}
.psub{font-size:13.5px;color:var(--g400);margin-top:4px;font-weight:500}
.dhero{background:linear-gradient(145deg,var(--navy-d) 0%,var(--navy-m) 60%,var(--navy-l) 100%);border-radius:var(--r-xl);padding:clamp(22px,3.5vw,38px) clamp(20px,3.5vw,42px);position:relative;overflow:hidden;margin-bottom:24px;box-shadow:var(--sh-m)}

/* ═══ REQ CARD ═══ */
.rcard{background:var(--white);border-radius:var(--r-l);border:1.5px solid var(--g100);padding:20px;position:relative;overflow:hidden;margin-bottom:14px;transition:all .2s}
.rcard::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--amber)}
.rcard.approved::before{background:var(--green)}
.rcard.rejected::before{background:var(--red)}

/* ═══ LOADING ═══ */
#lov{position:fixed;inset:0;background:var(--navy-d);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998;opacity:1;transition:opacity .5s ease}
#lov.fade{opacity:0;pointer-events:none}

/* ═══ SYNC INDICATOR ═══ */
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;animation:pulse 2s infinite}
.sync-dot.syncing{background:var(--amber);animation:spin .8s linear infinite;border-radius:0;clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%)}

/* ═══ MOBILE OVERRIDES ═══ */
@media(max-width:480px){
  .gwcard{border-radius:var(--r-xl) var(--r-xl) 0 0;max-width:100%}
  .phdr{flex-direction:column;gap:10px}
  .phdr>*{width:100%}
  .phdr .btn{justify-content:center}
  .card-hov:hover{transform:none}
}

/* ══════════════════════════════════════════════════════════════
   D-MATHS ENHANCED LANDING — Royal Academy Edition
   Pure CSS upgrades — no logic changed
   ══════════════════════════════════════════════════════════════ */

/* ─── SCROLL PROGRESS BAR ─────────────────────────────────── */
#scroll-progress{
  position:fixed;top:0;left:0;height:3px;width:0%;z-index:9999;
  background:linear-gradient(90deg,var(--gold-dark),var(--gold),var(--gold-b),#FFF3A3);
  background-size:200% 100%;
  transition:width .1s linear;
  animation:shimmerBar 2.5s linear infinite;
  border-radius:0 3px 3px 0;
  box-shadow:0 0 12px rgba(212,160,23,.6);
}
@keyframes shimmerBar{0%{background-position:0% 50%}100%{background-position:200% 50%}}

/* ─── CUSTOM CURSOR GLOW (desktop only) ───────────────────── */
#cursor-glow{
  position:fixed;width:300px;height:300px;border-radius:50%;
  background:radial-gradient(circle,rgba(212,160,23,.06) 0%,transparent 70%);
  pointer-events:none;z-index:0;transform:translate(-50%,-50%);
  transition:opacity .3s;opacity:0;
}

/* ─── REVEAL ANIMATION SYSTEM ─────────────────────────────── */
.reveal{
  opacity:0;transform:translateY(40px);
  transition:opacity .75s cubic-bezier(.16,1,.3,1), transform .75s cubic-bezier(.16,1,.3,1);
}
.reveal.revealed{ opacity:1;transform:translateY(0); }
.reveal-left{
  opacity:0;transform:translateX(-50px);
  transition:opacity .8s cubic-bezier(.16,1,.3,1),transform .8s cubic-bezier(.16,1,.3,1);
}
.reveal-left.revealed{ opacity:1;transform:translateX(0); }
.reveal-right{
  opacity:0;transform:translateX(50px);
  transition:opacity .8s cubic-bezier(.16,1,.3,1),transform .8s cubic-bezier(.16,1,.3,1);
}
.reveal-right.revealed{ opacity:1;transform:translateX(0); }
.reveal-scale{
  opacity:0;transform:scale(.94);
  transition:opacity .7s ease,transform .7s cubic-bezier(.34,1.56,.64,1);
}
.reveal-scale.revealed{ opacity:1;transform:scale(1); }
.stagger-1{transition-delay:.08s!important}
.stagger-2{transition-delay:.16s!important}
.stagger-3{transition-delay:.24s!important}
.stagger-4{transition-delay:.32s!important}
.stagger-5{transition-delay:.40s!important}
.stagger-6{transition-delay:.48s!important}

/* ─── ENHANCED NAV ────────────────────────────────────────── */
#lnav{
  background:transparent;
  transition:background .4s ease,backdrop-filter .4s ease,box-shadow .4s ease;
}
#lnav.scrolled{
  background:rgba(6,14,26,.88)!important;
  backdrop-filter:blur(32px) saturate(150%)!important;
  -webkit-backdrop-filter:blur(32px) saturate(150%)!important;
  box-shadow:0 1px 0 rgba(212,160,23,.15),0 8px 40px rgba(0,0,0,.35)!important;
  border-bottom:1px solid rgba(212,160,23,.12)!important;
}
.llink{
  position:relative;
  transition:color .2s ease;
  font-weight:500;
  font-size:13.5px;
  letter-spacing:.01em;
}
.llink::after{
  content:'';position:absolute;bottom:-2px;left:50%;right:50%;
  height:1.5px;background:var(--gold);border-radius:2px;
  transition:left .25s ease,right .25s ease;
}
.llink:hover::after,.llink.active::after{left:12px;right:12px;}
.llink:hover{color:#fff!important}

/* ─── HERO SECTION ────────────────────────────────────────── */
.hero{
  overflow:hidden;
  background:var(--navy-d)!important;
}
/* aurora orbs */
.hero::before,.hero::after{content:'';}
#hero-aurora{
  position:absolute;inset:0;pointer-events:none;overflow:hidden;
}
#hero-aurora .orb{
  position:absolute;border-radius:50%;filter:blur(80px);
  animation:orbDrift 18s ease-in-out infinite alternate;
}
#hero-aurora .orb:nth-child(1){
  width:60vw;height:60vw;top:-20%;left:-15%;
  background:radial-gradient(circle,rgba(212,160,23,.1) 0%,transparent 65%);
  animation-duration:22s;
}
#hero-aurora .orb:nth-child(2){
  width:50vw;height:50vw;bottom:-25%;right:-10%;
  background:radial-gradient(circle,rgba(37,99,235,.1) 0%,transparent 65%);
  animation-duration:18s;animation-direction:alternate-reverse;
}
#hero-aurora .orb:nth-child(3){
  width:35vw;height:35vw;top:30%;left:35%;
  background:radial-gradient(circle,rgba(212,160,23,.06) 0%,transparent 65%);
  animation-duration:26s;
}
@keyframes orbDrift{
  0%{transform:translate(0,0) scale(1);}
  33%{transform:translate(3%,4%) scale(1.05);}
  66%{transform:translate(-2%,2%) scale(.97);}
  100%{transform:translate(2%,-3%) scale(1.03);}
}

/* enhanced hero grid */
.hero-grid{position:relative;z-index:2;}
.h1{
  font-size:clamp(44px,6vw,88px)!important;
  letter-spacing:-.03em!important;
  line-height:1.01!important;
  font-weight:700!important;
}
.h1 em{
  font-style:italic;
  background:linear-gradient(135deg,var(--gold-b) 0%,#FFE580 50%,var(--gold) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
  font-size:1.05em;
}

/* hero card (score preview) */
.hero-grid > div:last-child > div > div:first-child{
  background:rgba(255,255,255,.05)!important;
  border:1px solid rgba(255,255,255,.1)!important;
  backdrop-filter:blur(40px) saturate(180%)!important;
  -webkit-backdrop-filter:blur(40px) saturate(180%)!important;
  box-shadow:0 32px 80px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.1)!important;
  border-radius:24px!important;
}

/* floating math symbols — more visible, more dramatic */
.msym{
  color:rgba(212,160,23,.08)!important;
  font-weight:400!important;
  text-shadow:0 0 40px rgba(212,160,23,.15);
  will-change:transform;
}

/* ─── EYEBROW / SECTION TITLES ────────────────────────────── */
.eyebrow{
  font-family:var(--font-mono)!important;
  font-size:11px!important;
  letter-spacing:.28em!important;
  font-weight:500!important;
  color:var(--gold)!important;
  text-transform:uppercase!important;
}
.eyebrow::before{
  width:32px!important;height:1.5px!important;
  background:linear-gradient(90deg,var(--gold),rgba(212,160,23,.3))!important;
}

.stitle{
  font-size:clamp(30px,4vw,54px)!important;
  font-weight:700!important;
  letter-spacing:-.02em!important;
  line-height:1.08!important;
}
.stitle.lt{color:#fff!important}

/* ─── ABOUT SECTION ───────────────────────────────────────── */
#about{background:var(--cream)!important}
#about-grid > div:first-child p{
  font-size:16.5px!important;
  line-height:1.9!important;
  color:var(--g500)!important;
}

/* founder card */
#about-grid > div:last-child > div{
  background:linear-gradient(145deg,#0A1628 0%,#132240 60%,#1a2e55 100%)!important;
  border-radius:28px!important;
  box-shadow:0 32px 80px rgba(10,22,40,.35)!important;
  position:relative;overflow:hidden;
}
#about-grid > div:last-child > div::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,160,23,.4),transparent);
}
#about-grid > div:last-child > div p:first-child{
  font-size:clamp(17px,2vw,20px)!important;
  font-style:italic!important;
  line-height:1.75!important;
  color:rgba(255,255,255,.82)!important;
}

/* about feature cards */
#afeat > div{
  border-radius:16px!important;
  padding:18px!important;
  border:1px solid var(--g100)!important;
  transition:transform .25s ease,box-shadow .25s ease,border-color .25s ease!important;
  background:var(--white)!important;
}
#afeat > div:hover{
  transform:translateY(-4px)!important;
  box-shadow:0 12px 36px rgba(10,22,40,.1)!important;
  border-color:rgba(212,160,23,.25)!important;
}

/* ─── SUBJECTS SECTION ────────────────────────────────────── */
section#services{
  background:var(--navy)!important;
  position:relative;overflow:hidden;
}
section#services::before{
  content:'';position:absolute;top:-40%;left:-20%;
  width:80%;height:80%;border-radius:50%;
  background:radial-gradient(circle,rgba(212,160,23,.07) 0%,transparent 65%);
  pointer-events:none;
}

/* subject cards */
.g3 > div,.g3 > a{
  border-radius:20px!important;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1),box-shadow .3s ease,border-color .3s ease!important;
  border:1px solid rgba(255,255,255,.06)!important;
  background:rgba(255,255,255,.04)!important;
  overflow:hidden;
  position:relative;
}
.g3 > div::before,.g3 > a::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(212,160,23,.06) 0%,transparent 50%);
  opacity:0;transition:opacity .3s ease;
}
.g3 > div:hover,.g3 > a:hover{
  transform:translateY(-8px) scale(1.01)!important;
  box-shadow:0 24px 60px rgba(0,0,0,.5),0 0 0 1px rgba(212,160,23,.25)!important;
}
.g3 > div:hover::before,.g3 > a:hover::before{opacity:1;}

/* ─── HOW IT WORKS ────────────────────────────────────────── */
section#how-it-works{background:var(--cream)!important;}
.g4 > div{
  border-radius:20px!important;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1),box-shadow .3s ease!important;
}
.g4 > div:hover{
  transform:translateY(-6px)!important;
  box-shadow:0 20px 50px rgba(10,22,40,.12)!important;
}

/* ─── STATS SECTION ───────────────────────────────────────── */
#stats-grid > div{
  position:relative;padding:40px 24px!important;
  border-radius:20px;
  border:1px solid rgba(255,255,255,.06);
  background:rgba(255,255,255,.02);
  transition:background .3s ease,border-color .3s ease;
}
#stats-grid > div::before{
  content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);
  width:60%;height:1px;
  background:linear-gradient(90deg,transparent,rgba(212,160,23,.4),transparent);
}
#stats-grid > div:hover{
  background:rgba(212,160,23,.04);
  border-color:rgba(212,160,23,.2);
}
.scount{
  font-family:var(--font-display)!important;
  font-size:clamp(52px,6vw,80px)!important;
  font-weight:700!important;
  background:linear-gradient(135deg,var(--gold-b),#FFE580,var(--gold))!important;
  -webkit-background-clip:text!important;-webkit-text-fill-color:transparent!important;
  background-clip:text!important;
  line-height:1!important;
  display:block;
}

/* ─── TESTIMONIALS ────────────────────────────────────────── */
section#testimonials{background:var(--bg)!important}
#test-grid > div{
  border-radius:22px!important;
  border:1.5px solid var(--g200)!important;
  background:var(--white)!important;
  padding:28px!important;
  position:relative;
  transition:transform .3s cubic-bezier(.34,1.56,.64,1),box-shadow .3s ease,border-color .3s ease!important;
  overflow:hidden;
}
#test-grid > div::before{
  content:'"';
  position:absolute;top:-10px;right:20px;
  font-family:var(--font-display);font-size:120px;font-weight:700;
  color:rgba(212,160,23,.08);line-height:1;pointer-events:none;
}
#test-grid > div:hover{
  transform:translateY(-6px)!important;
  box-shadow:0 24px 60px rgba(10,22,40,.12)!important;
  border-color:rgba(212,160,23,.3)!important;
}

/* ─── PROGRAMS SECTION ────────────────────────────────────── */
section#programs{background:var(--cream)!important}
#programs-grid article{
  border-radius:22px!important;
  border:1.5px solid var(--g100)!important;
  overflow:hidden;
  transition:transform .35s cubic-bezier(.34,1.56,.64,1),box-shadow .35s ease!important;
}
#programs-grid article:hover{
  transform:translateY(-10px)!important;
  box-shadow:0 32px 80px rgba(10,22,40,.2)!important;
}
#programs-grid article img{
  transition:transform .6s cubic-bezier(.25,.46,.45,.94)!important;
}
#programs-grid article:hover img{transform:scale(1.08)!important}

/* ─── CONTACT SECTION ─────────────────────────────────────── */
section#contact{background:var(--cream)!important}
#contact-grid .card{
  border-radius:24px!important;
  border:1.5px solid var(--g100)!important;
  box-shadow:0 8px 40px rgba(10,22,40,.08),inset 0 1px 0 rgba(255,255,255,.8)!important;
  padding:36px!important;
  transition:box-shadow .3s ease!important;
}
#contact-grid .card:hover{
  box-shadow:0 24px 60px rgba(10,22,40,.14),inset 0 1px 0 rgba(255,255,255,.8)!important;
}
.fi-el{
  border-radius:12px!important;
  border:1.5px solid var(--g200)!important;
  transition:border-color .2s ease,box-shadow .2s ease!important;
  font-family:var(--font-body)!important;
}
.fi-el:focus{
  border-color:var(--gold)!important;
  box-shadow:0 0 0 3px rgba(212,160,23,.15)!important;
}
#cinfo > div{
  border-radius:16px!important;
  transition:transform .25s ease,background .25s ease!important;
}
#cinfo > div:hover{
  transform:translateX(6px)!important;
  background:rgba(212,160,23,.06)!important;
}

/* ─── BUTTONS ─────────────────────────────────────────────── */
.btn-gold{
  background:linear-gradient(135deg,var(--gold-dark),var(--gold),var(--gold-b))!important;
  background-size:200% 100%!important;
  background-position:100% 0!important;
  box-shadow:0 4px 20px rgba(212,160,23,.35)!important;
  transition:background-position .4s ease,box-shadow .3s ease,transform .2s ease!important;
  font-weight:700!important;
  letter-spacing:.01em!important;
  position:relative;overflow:hidden;
}
.btn-gold::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.15),transparent 60%);
  opacity:0;transition:opacity .3s;
}
.btn-gold:hover{
  background-position:0% 0!important;
  box-shadow:0 8px 32px rgba(212,160,23,.55)!important;
  transform:translateY(-2px)!important;
}
.btn-gold:hover::before{opacity:1;}
.btn-gold:active{transform:translateY(0)!important}

.btn-ow{
  background:transparent!important;
  border:1.5px solid rgba(255,255,255,.2)!important;
  color:#fff!important;
  backdrop-filter:blur(8px)!important;
  transition:border-color .25s,background .25s,transform .2s!important;
}
.btn-ow:hover{
  border-color:rgba(255,255,255,.5)!important;
  background:rgba(255,255,255,.08)!important;
  transform:translateY(-2px)!important;
}

/* ─── FOOTER ─────────────────────────────────────────────── */
footer{
  position:relative;overflow:hidden;
}
footer::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent 0%,rgba(212,160,23,.3) 50%,transparent 100%);
}
footer #footer-g > div{
  transition:opacity .3s ease;
}

/* ─── MOBILE DRAWER ──────────────────────────────────────── */
#mdrawer{
  background:rgba(6,14,26,.97)!important;
  backdrop-filter:blur(40px)!important;
  -webkit-backdrop-filter:blur(40px)!important;
  border-left:1px solid rgba(212,160,23,.1)!important;
}
.dlink{
  border-radius:12px!important;
  transition:background .2s,color .2s,padding-left .2s!important;
  font-weight:500!important;
}
.dlink:hover{
  background:rgba(212,160,23,.1)!important;
  color:var(--gold-b)!important;
  padding-left:20px!important;
}

/* ─── ENHANCED SECTION DIVIDER EFFECT ─────────────────────── */
.sec{position:relative;}

/* ─── LOADING OVERLAY ENHANCEMENT ────────────────────────── */
#lov{
  background:linear-gradient(135deg,var(--navy-d) 0%,#060c18 100%)!important;
}
#lov > div:first-child{
  font-size:52px!important;
  background:linear-gradient(135deg,var(--gold-b),#FFE580)!important;
  -webkit-background-clip:text!important;-webkit-text-fill-color:transparent!important;
  background-clip:text!important;
  letter-spacing:.05em!important;
}

/* ─── CHIP ENHANCEMENTS ────────────────────────────────────── */
.chip-gold{
  background:rgba(212,160,23,.1)!important;
  border:1px solid rgba(212,160,23,.25)!important;
  color:var(--gold-dark)!important;
  border-radius:99px!important;
  font-weight:600!important;
  transition:background .2s,transform .2s!important;
}
.chip-gold:hover{
  background:rgba(212,160,23,.18)!important;
  transform:translateY(-2px)!important;
}

/* ─── SCROLL-TO-TOP BUTTON ────────────────────────────────── */
#scroll-top{
  position:fixed;bottom:32px;right:32px;z-index:888;
  width:48px;height:48px;border-radius:50%;
  background:linear-gradient(135deg,var(--gold-dark),var(--gold));
  border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 24px rgba(212,160,23,.4);
  opacity:0;transform:translateY(20px) scale(.8);
  transition:opacity .3s ease,transform .3s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;
}
#scroll-top.visible{opacity:1;transform:translateY(0) scale(1);pointer-events:auto;}
#scroll-top:hover{transform:translateY(-4px) scale(1.1)!important;box-shadow:0 14px 36px rgba(212,160,23,.5)!important;}
#scroll-top svg{transform:translateY(1px)}

/* ─── SECTION HEADER LINE ENHANCEMENT ─────────────────────── */
.sctr{text-align:center}
.sctr .eyebrow{justify-content:center}
.sctr .ssub{margin:0 auto}

/* ─── RESPONSIVE POLISH ────────────────────────────────────── */
@media(max-width:768px){
  .h1{font-size:clamp(40px,9vw,58px)!important;}
  #about-grid{grid-template-columns:1fr!important;}
  #contact-grid{grid-template-columns:1fr!important;}
  #scroll-top{bottom:88px;right:18px;}
}
@media(max-width:480px){
  .h1{font-size:clamp(36px,10vw,50px)!important;}
  .stitle{font-size:clamp(26px,7vw,38px)!important;}
  #hero-aurora .orb{filter:blur(60px)!important;}
}

/* ─── REDUCED MOTION RESPECT ───────────────────────────────── */
@media(prefers-reduced-motion:reduce){
  .reveal,.reveal-left,.reveal-right,.reveal-scale{
    opacity:1!important;transform:none!important;transition:none!important;
  }
  .orb,.msym{animation:none!important;}
  .btn-gold,.btn-ow{transition:none!important;}
}

/* ══ DARK MODE ════════════════════════════════════════════════ */
[data-theme="dark"]{
  --bg:#0F1923;--white:#1A2535;--cream:#141E2C;
  --g50:#1C2A3A;--g100:#243044;--g200:#2E3E54;--g300:#3D5068;
  --g400:#6B84A0;--g500:#8DA3BC;--g700:#B8CCE0;--g900:#E8F0F8;
  --sh:0 1px 3px rgba(0,0,0,.3),0 4px 16px rgba(0,0,0,.2);
  --sh-m:0 6px 20px rgba(0,0,0,.35);--sh-l:0 12px 40px rgba(0,0,0,.45);
}
[data-theme="dark"] .card{background:var(--white);border:1px solid var(--g100)}
[data-theme="dark"] .fi-el{background:var(--g50);border-color:var(--g200);color:var(--g900)}
[data-theme="dark"] .fi-el:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(212,160,23,.2)}
[data-theme="dark"] #pmain{background:var(--bg)}
[data-theme="dark"] #ptopbar{background:rgba(15,25,35,.97);border-color:rgba(255,255,255,.06)}
[data-theme="dark"] .tw table{background:var(--white)}
[data-theme="dark"] thead{background:var(--g50)!important}
[data-theme="dark"] tbody tr:hover{background:var(--g50)!important}
[data-theme="dark"] th,td{border-color:var(--g100)!important;color:var(--g700)}
[data-theme="dark"] .dhero{background:linear-gradient(135deg,var(--navy) 0%,var(--navy-m) 100%)!important}
[data-theme="dark"] select.fi-el option{background:var(--g50)}

/* dark mode toggle button */
#dm-toggle{
  display:none;width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;
  background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);
  align-items:center;justify-content:center;flex-shrink:0;
  transition:background .2s,transform .3s;font-size:16px;
}
#dm-toggle:hover{background:rgba(255,255,255,.16);transform:rotate(20deg)}

/* ══ NOTIFICATION BELL ════════════════════════════════════════ */
#bell-wrap{display:none;position:relative;flex-shrink:0}
#bell-btn{
  width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;
  background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);
  display:flex;align-items:center;justify-content:center;
  position:relative;transition:background .2s;
}
#bell-btn:hover{background:rgba(255,255,255,.16)}
#bell-badge{
  position:absolute;top:-4px;right:-4px;
  background:var(--red);color:#fff;border-radius:99px;
  font-size:9px;font-weight:800;padding:1px 5px;
  min-width:16px;text-align:center;display:none;
  border:2px solid var(--navy-d);
}
#bell-drop{
  position:absolute;top:calc(100% + 10px);right:-8px;
  width:320px;background:var(--white);border-radius:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.25),0 0 0 1px rgba(255,255,255,.08);
  z-index:9000;overflow:hidden;display:none;
  animation:dropIn .2s cubic-bezier(.16,1,.3,1);
}
@keyframes dropIn{from{opacity:0;transform:translateY(-8px) scale(.97)}to{opacity:1;transform:none}}
#bell-drop.open{display:block}
#bell-drop-hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid var(--g100);
}
#bell-drop-list{max-height:320px;overflow-y:auto;}
.bell-item{padding:12px 16px;border-bottom:1px solid var(--g100);cursor:pointer;transition:background .15s}
.bell-item:hover{background:var(--g50)}
.bell-item.unread{background:rgba(212,160,23,.05);border-left:3px solid var(--gold)}
.bell-item.unread:hover{background:rgba(212,160,23,.1)}
.bell-item-title{font-size:13px;font-weight:700;color:var(--g900);margin-bottom:3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bell-item-msg{font-size:12px;color:var(--g500);line-height:1.5;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.bell-item-date{font-size:11px;color:var(--g300);margin-top:4px;font-weight:500}

/* ══ GLOBAL SEARCH ════════════════════════════════════════════ */
#search-btn{
  display:none;width:36px;height:36px;border-radius:50%;border:none;cursor:pointer;
  background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);
  align-items:center;justify-content:center;transition:background .2s;
}
#search-btn:hover{background:rgba(255,255,255,.16)}
#search-overlay{
  display:none;position:fixed;inset:0;z-index:8000;
  background:rgba(6,14,26,.7);backdrop-filter:blur(8px);
  align-items:flex-start;justify-content:center;padding-top:80px;
}
#search-overlay.open{display:flex}
#search-box{
  width:100%;max-width:640px;background:var(--white);border-radius:20px;
  box-shadow:0 32px 80px rgba(0,0,0,.4);overflow:hidden;
  animation:dropIn .22s cubic-bezier(.16,1,.3,1);
}
#search-input-wrap{display:flex;align-items:center;padding:16px 20px;gap:12px;border-bottom:1px solid var(--g100)}
#search-input{
  flex:1;border:none;outline:none;font-size:16px;font-family:var(--font-body);
  background:transparent;color:var(--g900);font-weight:500;
}
#search-input::placeholder{color:var(--g300)}
#search-results{max-height:420px;overflow-y:auto;padding:8px 0}
.sr-section{padding:6px 16px 2px;font-size:11px;font-weight:700;color:var(--g400);letter-spacing:.1em;text-transform:uppercase}
.sr-item{
  display:flex;align-items:center;gap:12px;padding:10px 16px;
  cursor:pointer;transition:background .14s;
}
.sr-item:hover{background:var(--g50)}
.sr-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px}
.sr-name{font-size:14px;font-weight:600;color:var(--g900)}
.sr-sub{font-size:12px;color:var(--g400);margin-top:1px}
#search-empty{padding:36px;text-align:center;color:var(--g400);font-size:14px;font-weight:500}

/* ══ SUBJECT FILTER TABS ══════════════════════════════════════ */
#sa-filter-wrap{
  display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;
  padding-bottom:16px;border-bottom:1px solid var(--g100);
}
.sa-tab{
  padding:6px 14px;border-radius:99px;font-size:12.5px;font-weight:700;
  border:1.5px solid var(--g200);background:transparent;cursor:pointer;
  color:var(--g500);transition:all .18s;white-space:nowrap;
}
.sa-tab:hover{border-color:var(--gold);color:var(--gold-dark)}
.sa-tab.active{background:var(--gold);border-color:var(--gold);color:var(--navy-d)}

/* ══ ACHIEVEMENT BADGES ═══════════════════════════════════════ */
#badges-section{margin-top:16px}
.badge-grid{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
.achv-badge{
  display:flex;align-items:center;gap:9px;
  padding:10px 14px;border-radius:14px;border:1.5px solid;
  transition:transform .2s,box-shadow .2s;cursor:default;
}
.achv-badge:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,.1)}
.achv-badge.gold{background:rgba(212,160,23,.1);border-color:rgba(212,160,23,.35);color:var(--gold-dark)}
.achv-badge.green{background:var(--green-bg);border-color:rgba(5,150,105,.3);color:var(--green-t)}
.achv-badge.blue{background:var(--blue-bg);border-color:rgba(37,99,235,.3);color:var(--blue-t)}
.achv-badge.purple{background:var(--purple-bg);border-color:rgba(124,58,237,.3);color:#5B21B6}
.achv-badge.amber{background:var(--amber-bg);border-color:rgba(217,119,6,.3);color:var(--amber-t)}
.achv-badge.navy{background:rgba(10,22,40,.08);border-color:rgba(10,22,40,.2);color:var(--navy)}
.achv-badge-icon{font-size:20px;line-height:1}
.achv-badge-name{font-size:12.5px;font-weight:700}
.achv-badge-desc{font-size:11px;opacity:.75;margin-top:1px}
.achv-lock{opacity:.35;filter:grayscale(1)}

/* ══ CLASS CALENDAR VIEW ══════════════════════════════════════ */
.cal-view-toggle{display:flex;gap:4px;background:var(--g100);border-radius:8px;padding:3px}
.cal-view-btn{padding:5px 12px;border-radius:6px;border:none;cursor:pointer;font-size:12px;font-weight:700;color:var(--g500);background:transparent;transition:all .16s}
.cal-view-btn.active{background:var(--white);color:var(--g900);box-shadow:var(--sh)}
#cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.cal-day-col{min-height:180px;}
.cal-day-hdr{font-size:11px;font-weight:800;letter-spacing:.08em;text-transform:uppercase;
  color:var(--g400);padding:6px 4px;text-align:center;margin-bottom:6px}
.cal-day-hdr.today{color:var(--gold-dark)}
.cal-cls-chip{
  background:linear-gradient(135deg,var(--navy),var(--navy-m));
  border-radius:10px;padding:8px 10px;margin-bottom:6px;cursor:pointer;
  transition:transform .2s,box-shadow .2s;
}
.cal-cls-chip:hover{transform:translateY(-2px);box-shadow:var(--sh-m)}
.cal-cls-chip-subj{font-size:12px;font-weight:700;color:var(--gold-b);margin-bottom:2px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cal-cls-chip-time{font-size:11px;color:rgba(255,255,255,.55);font-weight:500}
.cal-empty{font-size:11px;color:var(--g300);text-align:center;padding:12px 4px;font-weight:500}
@media(max-width:600px){#cal-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:400px){#cal-grid{grid-template-columns:repeat(2,1fr)}}

/* ══ CBT COUNTDOWN ════════════════════════════════════════════ */
.cbt-countdown{
  display:flex;align-items:center;gap:10px;margin-top:12px;
  padding:12px 16px;background:var(--amber-bg);border-radius:var(--r);
  border-left:3px solid var(--amber);
}
.cbt-countdown-inner{display:flex;gap:10px}
.cbt-cd-unit{text-align:center}
.cbt-cd-num{
  font-family:var(--font-mono);font-size:22px;font-weight:700;
  color:var(--amber-t);display:block;line-height:1;
  min-width:36px;
}
.cbt-cd-label{font-size:9px;font-weight:700;color:var(--amber);letter-spacing:.12em;text-transform:uppercase}
.cbt-cd-sep{font-size:20px;font-weight:700;color:var(--amber);align-self:flex-start;padding-top:2px}
.cbt-live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);
  animation:pulse 1.5s ease-in-out infinite;flex-shrink:0}

/* ══ COMMENT / NOTES THREAD ═══════════════════════════════════ */
.notes-thread{margin-top:14px;border-top:1px solid var(--g100);padding-top:14px}
.notes-thread-hdr{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;cursor:pointer;user-select:none;
}
.notes-thread-hdr h5{font-size:13px;font-weight:700;color:var(--g700);display:flex;align-items:center;gap:7px}
.notes-list{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
.note-bubble{
  max-width:85%;padding:9px 13px;border-radius:14px;font-size:13px;line-height:1.55;
  position:relative;
}
.note-bubble.student{
  background:var(--blue-bg);color:var(--blue-t);border-radius:14px 14px 14px 4px;
  align-self:flex-start;border:1px solid rgba(37,99,235,.15);
}
.note-bubble.admin{
  background:linear-gradient(135deg,var(--navy),var(--navy-m));color:rgba(255,255,255,.9);
  border-radius:14px 14px 4px 14px;align-self:flex-end;
}
.note-bubble-meta{font-size:10.5px;opacity:.6;margin-top:4px;font-weight:600}
.notes-list-wrap{display:flex;flex-direction:column;gap:0}
.note-input-row{display:flex;gap:8px;align-items:flex-end}
.note-input-row textarea{
  flex:1;border:1.5px solid var(--g200);border-radius:12px;padding:8px 12px;
  font-family:var(--font-body);font-size:13px;resize:none;line-height:1.5;
  background:var(--g50);color:var(--g900);outline:none;
  transition:border-color .2s;max-height:80px;
}
.note-input-row textarea:focus{border-color:var(--gold)}
.note-input-row button{
  flex-shrink:0;height:38px;padding:0 14px;border-radius:10px;
  font-size:13px;font-weight:700;cursor:pointer;border:none;
  background:var(--gold);color:var(--navy-d);transition:opacity .2s;
}
.note-input-row button:hover{opacity:.85}

/* ══ PRINT STYLES ═════════════════════════════════════════════ */
@media print{
  #psidebar,#ptopbar,#pbnav,#bell-wrap,#search-btn,#dm-toggle,
  #scroll-progress,#scroll-top,.phdr button,.btn,nav{display:none!important}
  body{background:#fff!important}
  #pmain{margin:0!important;padding:16px!important}
  .card{box-shadow:none!important;border:1px solid #ddd!important}
  @page{margin:1cm}
  .pg{display:block!important}
  #portal-pages{animation:none!important}
}
</style>
</head>
<body>
<div id="scroll-progress"></div>
<div id="cursor-glow"></div>
<button id="scroll-top" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="Back to top"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#0A1628" stroke-width="2.5"><path d="M18 15l-6-6-6 6"/></svg></button>


<!-- ═══ LOADING ═══ -->
<div id="lov">
  <div style="font-family:var(--font-logo);font-size:42px;color:var(--gold-b);letter-spacing:.02em">D-Maths</div>
  <div style="font-family:var(--font-mono);font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:rgba(255,255,255,.3);margin-top:8px">Tuition Centre</div>
  <div style="width:180px;height:3px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden;margin-top:32px"><div style="height:100%;background:linear-gradient(90deg,var(--gold),var(--gold-b));border-radius:99px;animation:loadBar 1.4s ease-in-out forwards"></div></div>
</div>

<!-- ═══ TOASTS ═══ -->
<div class="toast-host" id="toast-host"></div>

<!-- ═══ MODAL ═══ -->
<div class="ov" id="ov" onclick="if(event.target===this)closeModal()">
  <div class="modal" id="modal">
    <div class="mhandle"></div>
    <div class="mhdr">
      <h3 class="mtitle" id="mtitle"></h3>
      <button class="btn btn-ghost btn-ico" onclick="closeModal()" aria-label="Close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div class="mbody" id="mbody"></div>
  </div>
</div>

<!-- ═══════════════════════════════════════ -->
<!--  LANDING PAGE                          -->
<!-- ═══════════════════════════════════════ -->
<div id="vl" class="view on">
  <nav id="lnav">
    <div class="lnav-i">
      <div id="logo-l" onclick="scrollTo0('home')" style="cursor:pointer"></div>
      <div class="llinks" id="llinks"></div>
      <div style="display:flex;align-items:center;gap:10px">
        <button class="btn btn-gold btn-sm lportal" onclick="goGateway()">Enter Portal</button>
        <button class="btn btn-ghost btn-ico" id="hbtn" style="background:rgba(255,255,255,.1);color:#fff;border-color:transparent" aria-label="Menu" onclick="openDrawer()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
        </button>
      </div>
    </div>
  </nav>

  <!-- Mobile Drawer -->
  <div id="mdrawer">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid rgba(255,255,255,.08)">
      <div id="logo-d"></div>
      <button class="btn btn-ghost btn-ico" style="background:rgba(255,255,255,.08);color:#fff;border-color:transparent" onclick="closeDrawer()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
      </button>
    </div>
    <div style="flex:1;padding:24px 20px;display:flex;flex-direction:column;gap:4px" id="dlinks"></div>
    <div style="padding:24px;border-top:1px solid rgba(255,255,255,.08)">
      <button class="btn btn-gold btn-lg btn-w" onclick="goGateway();closeDrawer()">Enter Student Portal →</button>
    </div>
  </div>

  <!-- HERO -->
  <section id="home" class="hero">
  <div id="hero-aurora"><div class="orb"></div><div class="orb"></div><div class="orb"></div></div>
  
    <div id="msyms" aria-hidden="true"></div>
    <div style="position:absolute;top:-5%;left:20%;width:70%;height:80%;background:radial-gradient(ellipse,rgba(212,160,23,.055) 0%,transparent 70%);pointer-events:none"></div>
    <div style="position:absolute;bottom:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(212,160,23,.2),transparent)"></div>
    <div class="hero-grid">
      <div>
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:22px" class="fu">
          <div style="width:36px;height:2px;background:linear-gradient(90deg,var(--gold),transparent)"></div>
          <span style="font-family:var(--font-mono);font-size:11.5px;font-weight:500;letter-spacing:.2em;text-transform:uppercase;color:var(--gold)">Excellence in Mathematics</span>
        </div>
        <h1 class="h1 fu1">Where Numbers<br><em>Come Alive</em><br>&amp; Students Thrive</h1>
        <p style="font-size:clamp(15px,1.8vw,18px);color:rgba(255,255,255,.6);line-height:1.8;margin:24px 0 38px;max-width:480px;font-weight:400" class="fu2">D-Maths delivers world-class online mathematics education at the secondary and primary levels — through expert tutors, personalised pathways, and a portal built for results.</p>
        <div style="display:flex;flex-wrap:wrap;gap:14px" class="fu3">
          <button class="btn btn-gold btn-lg" onclick="goGateway()">Enter Student Portal <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
          <button class="btn btn-ow btn-lg" onclick="scrollTo0('about')">Learn More</button>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:28px;margin-top:44px" class="fu4" id="hstats"></div>
      </div>
      <div style="display:flex;justify-content:center;align-items:center" class="fu2">
        <div style="width:100%;max-width:400px;position:relative">
          <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);border-radius:20px;padding:28px;backdrop-filter:blur(20px)">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:22px;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,.08)">
              <div style="width:44px;height:44px;border-radius:13px;background:linear-gradient(135deg,var(--gold),var(--gold-b));display:flex;align-items:center;justify-content:center;animation:glow 3s ease-in-out infinite">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#0A1628" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
              </div>
              <div><div style="color:#fff;font-weight:700;font-size:15px;font-family:var(--font-body)">Student Progress Report</div><div style="color:rgba(255,255,255,.42);font-size:12px">This Week's Overview</div></div>
            </div>
            <div id="hbars"></div>
            <div style="margin-top:18px;padding:12px 16px;background:rgba(212,160,23,.12);border-radius:10px;border:1px solid rgba(212,160,23,.25)">
              <div style="font-size:12.5px;color:var(--gold-b);font-weight:700">🏆 Top students excelling this term!</div>
            </div>
          </div>
          <div style="position:absolute;top:-20px;right:-20px;width:64px;height:64px;border-radius:50%;background:rgba(212,160,23,.18);filter:blur(22px)"></div>
          <div style="position:absolute;bottom:-24px;left:-24px;width:88px;height:88px;border-radius:50%;background:rgba(37,99,235,.14);filter:blur(26px)"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="sec" style="background:var(--cream)">
    <div class="sec-i">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:clamp(36px,6vw,100px);align-items:center" id="about-grid">
        <div>
          <div class="eyebrow">About D-Maths</div>
          <h2 class="stitle" style="margin-bottom:20px">Nigeria's Premier Online Mathematics Tuition Centre</h2>
          <p style="font-size:16px;color:var(--g500);line-height:1.85;margin-bottom:18px">D-Maths Tuition Centre was founded with a single mission: to make exceptional mathematics education accessible to every student. Our expert tutors combine rigorous academic instruction with modern technology to deliver results that speak for themselves.</p>
          <p style="font-size:16px;color:var(--g500);line-height:1.85;margin-bottom:32px">Every student receives a personalised learning path, real-time progress tracking, and direct tutor support — all through our state-of-the-art online portal.</p>
          <div class="g2" id="afeat" style="gap:14px;margin-bottom:28px"></div>
          <div style="display:flex;flex-wrap:wrap;gap:8px" id="achips"></div>
        </div>
        <div>
          <div style="background:linear-gradient(145deg,var(--navy),var(--navy-m));border-radius:var(--r-xl);padding:38px;color:#fff">
            <p style="font-family:var(--font-display);font-size:clamp(17px,2.2vw,22px);font-weight:700;font-style:italic;color:rgba(255,255,255,.85);line-height:1.7;margin-bottom:28px">"Mathematics is not just a subject — it is the language of the universe. Our mission is to make every student fluent."</p>
            <div style="display:flex;align-items:center;gap:14px;margin-bottom:28px">
              <!-- ══ FOUNDER PHOTO ══
                   HOW TO ADD PHOTO:
                   1. Save your photo as "founder.jpg" (or .png / .webp)
                   2. Put it in the SAME folder as this HTML file
                   3. Change src="" below to src="founder.jpg"
                   Photo should be at least 200×200px, square works best.
              ══════════════════════════════ -->
              <div style="width:64px;height:64px;border-radius:50%;flex-shrink:0;overflow:hidden;border:2.5px solid rgba(255,255,255,.25);background:linear-gradient(135deg,var(--gold),var(--gold-b))">
                <img
                  src="IMAGE 3.jpg"
                  alt="Mr. Oladapo Bakare — Founder"
                  id="founder-photo"
                  style="width:100%;height:100%;object-fit:cover;object-position:center top;display:block"
                  onerror="this.style.display='none';this.parentElement.innerHTML='<div style=\'width:100%;height:100%;display:flex;align-items:center;justify-content:center\'><span style=\'font-family:var(--font-logo);font-weight:700;font-size:22px;color:var(--navy-d)\'>D</span></div>'"
                />
              </div>
              <div><div style="font-weight:700;font-size:16px">Mr. Oladapo Bakare</div><div style="font-size:13px;color:rgba(255,255,255,.45);margin-top:2px">Founder &amp; Lead Tutor</div></div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;padding-top:24px;border-top:1px solid rgba(255,255,255,.1)">
              <div style="text-align:center"><div class="scount" style="font-size:clamp(26px,3vw,38px)">10+</div><div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:4px;font-weight:600">Years Teaching</div></div>
              <div style="text-align:center"><div class="scount" style="font-size:clamp(26px,3vw,38px)">500+</div><div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:4px;font-weight:600">Students Taught</div></div>
              <div style="text-align:center"><div class="scount" style="font-size:clamp(26px,3vw,38px)">98%</div><div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:4px;font-weight:600">Success Rate</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SUBJECTS -->
  <section id="services" class="sec" style="background:var(--navy);position:relative;overflow:hidden">
    <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(212,160,23,.06) 1px,transparent 1px);background-size:40px 40px;pointer-events:none"></div>
    <div class="sec-i" style="position:relative;z-index:1">
      <div style="text-align:center;margin-bottom:54px">
        <div class="eyebrow" style="justify-content:center">What We Teach</div>
        <h2 class="stitle lt" style="margin-bottom:14px">Our Subject Offerings</h2>
        <p class="ssub lt" style="margin:0 auto">Comprehensive curricula aligned with Nigeria Education Service standards and international best practices.</p>
      </div>
      <div class="g3" id="subs-grid"></div>
    </div>
  </section>

  <!-- HOW IT WORKS -->
  <section id="how-it-works" class="sec" style="background:var(--cream)">
    <div class="sec-i">
      <div style="text-align:center;margin-bottom:54px">
        <div class="eyebrow" style="justify-content:center">The Process</div>
        <h2 class="stitle" style="margin-bottom:14px">How It Works</h2>
        <p class="ssub" style="margin:0 auto">Four simple steps to begin your mathematics journey with D-Maths.</p>
      </div>
      <div class="g4" id="steps-grid"></div>
    </div>
  </section>

  <!-- STATS -->
  <section class="sec" style="background:var(--navy);position:relative;overflow:hidden">
    <div style="position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(212,160,23,.3),transparent)"></div>
    <div class="sec-i">
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:32px;text-align:center" id="stats-grid"></div>
    </div>
  </section>

  <!-- TESTIMONIALS -->
  <section id="testimonials" class="sec" style="background:var(--bg)">
    <div class="sec-i">
      <div style="text-align:center;margin-bottom:50px">
        <div class="eyebrow" style="justify-content:center">Student Stories</div>
        <h2 class="stitle" style="margin-bottom:14px">What Our Students Say</h2>
        <p class="ssub" style="margin:0 auto">Real results from real students across Nigeria.</p>
      </div>
      <div class="g2" id="test-grid" style="gap:20px"></div>
    </div>
  </section>

  <!-- PROGRAMS HOSTED ══════════════════════════════════════════════
       HOW TO ADD PROGRAM PHOTOS:
       ─────────────────────────────────────────────────────────────
       Each program card below has an <img> tag with a src="" attribute.
       To add a photo to a card:
         1. Save your photo (JPG, PNG, or WEBP) — any size, landscape preferred
         2. Put the photo in the SAME folder as this HTML file
         3. Find the card by its data-program attribute (e.g. data-program="bootcamp")
         4. Set src="your-filename.jpg" on that card's <img> tag

       Example:  src="" → src="bootcamp-2024.jpg"

       TIP: Ideal image size is 800×500px (16:9 landscape).
            Images are automatically cropped to fill the frame.
       ══════════════════════════════════════════════════════════════ -->
  <section id="programs" class="sec" style="background:var(--cream);position:relative;overflow:hidden">

    <!-- subtle dot grid background -->
    <div style="position:absolute;inset:0;background-image:radial-gradient(rgba(29,94,199,.07) 1px,transparent 1px);background-size:34px 34px;pointer-events:none"></div>

    <div class="sec-i" style="position:relative;z-index:1">

      <!-- Section header -->
      <div style="text-align:center;margin-bottom:54px">
        <div class="eyebrow" style="justify-content:center">Our Track Record</div>
        <h2 class="stitle" style="margin-bottom:14px">Programs We've Hosted</h2>
        <p class="ssub" style="margin:0 auto;max-width:580px">From intensive boot camps to open maths competitions — here's a look at the live events and programmes D-Maths has organised for students across Nigeria.</p>
      </div>

      <!-- Program cards grid -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:24px" id="programs-grid">

        <!-- ─── PROGRAM CARD 1 ─── -->
        <!-- Change src="" to src="your-photo.jpg" to add a photo -->
        <article data-program="bootcamp" style="background:var(--white);border-radius:var(--r-xl);overflow:hidden;box-shadow:var(--sh);border:1.5px solid var(--g100);transition:transform .25s,box-shadow .25s" onmouseover="this.style.transform='translateY(-6px)';this.style.boxShadow='0 16px 44px rgba(9,26,86,.14)'" onmouseout="this.style.transform='none';this.style.boxShadow='var(--sh)'">
          <!-- Photo area: replace src="" with your image path -->
          <div style="position:relative;width:100%;aspect-ratio:16/9;background:linear-gradient(135deg,#0F2970 0%,#1D5EC7 100%);overflow:hidden">
            <img src="7256 (1).jpg" alt="WASSCE/UTME SUCCESS HACKS PROGRAM" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block;transition:transform .4s ease" onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='scale(1)'" onerror="this.style.display='none'"/>
            <!-- Placeholder shown when no photo is set -->
            <div id="ph-bootcamp" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px">
              <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              <span style="font-family:var(--font-mono);font-size:10px;letter-spacing:.15em;color:rgba(255,255,255,.3);text-transform:uppercase">Add Photo</span>
            </div>
            <div style="position:absolute;top:12px;left:12px;background:rgba(245,166,35,.9);border-radius:99px;padding:3px 11px;font-size:11px;font-weight:800;color:#fff;letter-spacing:.04em">2024</div>
          </div>
          <div style="padding:20px 22px 22px">
            <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px">
              <span style="width:8px;height:8px;border-radius:50%;background:var(--brand);flex-shrink:0"></span>
              <span style="font-size:11.5px;font-weight:700;color:var(--brand);letter-spacing:.08em;text-transform:uppercase">Success Hacks Program</span>
            </div>
            <h3 style="font-family:var(--font-display);font-size:18px;font-weight:700;color:var(--g900);margin-bottom:8px;line-height:1.3">Maths Boot Camp 2024</h3>
            <p style="font-size:13.5px;color:var(--g500);line-height:1.7;margin-bottom:16px">An intensive 5-days intensive success hacks training program for UTME/SSCE  — with 100+ students from across different states in Nigeria featuring Mr.Leecrown, the best Teacher recipent award in Nigeria (2024)</p>
            <div style="display:flex;flex-wrap:wrap;gap:8px;padding-top:14px;border-top:1px solid var(--g100)">
              <span style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--g400);font-weight:600">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                100+ Students
              </span>
              <span style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--g400);font-weight:600">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                February 2024 · 5 Days
              </span>
            </div>
          </div>
        </article>

        <!-- ─── PROGRAM CARD 2 ─── -->
        <article data-program="competition" style="background:var(--white);border-radius:var(--r-xl);overflow:hidden;box-shadow:var(--sh);border:1.5px solid var(--g100);transition:transform .25s,box-shadow .25s" onmouseover="this.style.transform='translateY(-6px)';this.style.boxShadow='0 16px 44px rgba(9,26,86,.14)'" onmouseout="this.style.transform='none';this.style.boxShadow='var(--sh)'">
          <div style="position:relative;width:100%;aspect-ratio:16/9;background:linear-gradient(135deg,#091A56 0%,#0F2970 60%,#1a4ab5 100%);overflow:hidden">
            <img src="39095 (1).jpg" alt="Inter-School Maths Challenge programme photo" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block;transition:transform .4s ease" onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='scale(1)'" onerror="this.style.display='none'"/>
            <div id="ph-competition" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px">
              <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              <span style="font-family:var(--font-mono);font-size:10px;letter-spacing:.15em;color:rgba(255,255,255,.3);text-transform:uppercase">Add Photo</span>
            </div>
            <div style="position:absolute;top:12px;left:12px;background:rgba(245,166,35,.9);border-radius:99px;padding:3px 11px;font-size:11px;font-weight:800;color:#fff;letter-spacing:.04em">2023</div>
          </div>
          <div style="padding:20px 22px 22px">
            <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px">
              <span style="width:8px;height:8px;border-radius:50%;background:#F5A623;flex-shrink:0"></span>
              <span style="font-size:11.5px;font-weight:700;color:#C47813;letter-spacing:.08em;text-transform:uppercase">D-Maths Acadmia Club</span>
            </div>
            <h3 style="font-family:var(--font-display);font-size:18px;font-weight:700;color:var(--g900);margin-bottom:8px;line-height:1.3">Maths Club</h3>
            <p style="font-size:13.5px;color:var(--g500);line-height:1.7;margin-bottom:16px">A Maths Club with rigorous training in Mathematics and post exams, Career Guide, Tech guide, e.t.c </p>
            <div style="display:flex;flex-wrap:wrap;gap:8px;padding-top:14px;border-top:1px solid var(--g100)">
              <span style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--g400);font-weight:600">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                A MATHS CLUB
              </span>
              <span style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--g400);font-weight:600">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                still on
              </span>
            </div>
          </div>
        </article>

        <!-- ─── PROGRAM CARD 3 ─── -->
        <article data-program="workshop" style="background:var(--white);border-radius:var(--r-xl);overflow:hidden;box-shadow:var(--sh);border:1.5px solid var(--g100);transition:transform .25s,box-shadow .25s" onmouseover="this.style.transform='translateY(-6px)';this.style.boxShadow='0 16px 44px rgba(9,26,86,.14)'" onmouseout="this.style.transform='none';this.style.boxShadow='var(--sh)'">
          <div style="position:relative;width:100%;aspect-ratio:16/9;background:linear-gradient(135deg,#163585 0%,#1D5EC7 100%);overflow:hidden">
            <img src="45431.jpg" alt="Parents & Students WAEC Workshop programme photo" style="width:100%;height:100%;object-fit:cover;object-position:center;display:block;transition:transform .4s ease" onmouseover="this.style.transform='scale(1.04)'" onmouseout="this.style.transform='scale(1)'" onerror="this.style.display='none'"/>
            <div id="ph-workshop" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px">
              <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
              <span style="font-family:var(--font-mono);font-size:10px;letter-spacing:.15em;color:rgba(255,255,255,.3);text-transform:uppercase">Add Photo</span>
            </div>
            <div style="position:absolute;top:12px;left:12px;background:rgba(245,166,35,.9);border-radius:99px;padding:3px 11px;font-size:11px;font-weight:800;color:#fff;letter-spacing:.04em">2023</div>
          </div>
          <div style="padding:20px 22px 22px">
            <div style="display:flex;align-items:center;gap:7px;margin-bottom:8px">
              <span style="width:8px;height:8px;border-radius:50%;background:#059669;flex-shrink:0"></span>
              <span style="font-size:11.5px;font-weight:700;color:#047857;letter-spacing:.08em;text-transform:uppercase">Workshop</span>
            </div>
            <h3 style="font-family:var(--font-display);font-size:18px;font-weight:700;color:var(--g900);margin-bottom:8px;line-height:1.3">Educators &amp; Students WAEC Workshop</h3>
            <p style="font-size:13.5px;color:var(--g500);line-height:1.7;margin-bottom:16px">A two days free workshop equipping Educators on using A.I </p>
            <div style="display:flex;flex-wrap:wrap;gap:8px;padding-top:14px;border-top:1px solid var(--g100)">
              <span style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--g400);font-weight:600">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                50+ Attendees
              </span>
              <span style="display:flex;align-items:center;gap:5px;font-size:12px;color:var(--g400);font-weight:600">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                February 2026
              </span>
            </div>
          </div>
        </article>

      </div><!-- /programs-grid -->

      <!-- Responsive grid collapse -->
      <style>
        @media(max-width:900px){#programs-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:580px){#programs-grid{grid-template-columns:1fr}}
      
/* ═══ ENHANCED MOBILE RESPONSIVENESS ═══ */
@media(max-width:480px){
  .phdr{flex-direction:column;align-items:flex-start}
  .phdr>div:last-child{width:100%;display:flex;gap:6px;flex-wrap:wrap}
  .gdash,.gprog{grid-template-columns:1fr}
  .gsdet{grid-template-columns:1fr}
  .g2,.gcls{grid-template-columns:1fr}
  .gw{padding:16px;align-items:flex-end}
  .gwcard{border-radius:16px}
  .hero{padding:0 14px}
  .hero-grid{padding-top:82px;padding-bottom:24px}
  .suhdr{padding:12px 14px}
}
@media(max-width:400px){
  :root{--topbar-h:56px}
  #pmain{padding:12px 10px 90px}
  .pmc{padding-top:calc(var(--topbar-h)+12px)!important}
  .cp{padding:14px 12px}
  .g4{grid-template-columns:repeat(2,1fr)}
  .frow{grid-template-columns:1fr}
  .btn{font-size:13.5px}
}
@media(max-width:360px){
  .g4{grid-template-columns:1fr}
  .bni{min-width:36px;padding:4px 2px}
  .bni span{font-size:9px}
}
@media(max-width:600px){th,td{padding:10px 9px;font-size:12px}}
@media(pointer:coarse){
  .btn,.nl{min-height:46px}
  .fi-el{min-height:46px;font-size:15px}
  .bni{min-height:50px}
  .btn-xs{min-height:34px}
}
body{overflow-x:hidden}
.card,.sc,.gwcard,.tcard{max-width:100%}
</style>

    </div>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="sec" style="background:var(--cream)">
    <div class="sec-i">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:clamp(32px,6vw,80px);align-items:start" id="contact-grid">
        <div>
          <div class="eyebrow">Get In Touch</div>
          <h2 class="stitle" style="margin-bottom:16px">We'd Love to Hear From You</h2>
          <p style="font-size:16px;color:var(--g500);line-height:1.8;margin-bottom:30px">Whether you have questions about enrolment, curriculum, or fees — our team is ready to help.</p>
          <div id="cinfo"></div>
        </div>
        <div class="card cp si">
          <h3 style="font-family:var(--font-display);font-weight:700;font-size:22px;color:var(--g900);margin-bottom:20px">Send a Message</h3>
          <div class="frow">
            <div class="fg"><label class="fl">Full Name <span class="freq">*</span></label><input class="fi-el" id="cn" placeholder="Your full name"></div>
            <div class="fg"><label class="fl">Email <span class="freq">*</span></label><input class="fi-el" id="ce" type="email" placeholder="your@email.com"></div>
          </div>
          <div class="frow">
            <div class="fg"><label class="fl">Phone</label><input class="fi-el" id="cp" placeholder=" +234 XX XXX XXXX"></div>
            <div class="fg"><label class="fl">Subject</label><select class="fi-el" id="cs"><option>Enrolment Enquiry</option><option>Fees &amp; Payment</option><option>Curriculum Info</option><option>Technical Support</option><option>Other</option></select></div>
          </div>
          <div class="fg"><label class="fl">Message <span class="freq">*</span></label><textarea class="fi-el" id="cm" rows="4" placeholder="How can we help?"></textarea></div>
          <button class="btn btn-gold btn-w" style="min-height:50px;font-size:15px" onclick="sendContact()">Send Message →</button>
        </div>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer style="background:var(--navy-d);padding:clamp(48px,7vw,80px) clamp(16px,4vw,72px) 32px;border-top:1px solid rgba(255,255,255,.06)">
    <div style="max-width:1280px;margin:0 auto">
      <div id="footer-g" style="display:grid;grid-template-columns:1.8fr 1fr 1fr 1.2fr;gap:40px;margin-bottom:48px"></div>
      <div style="border-top:1px solid rgba(255,255,255,.07);padding-top:24px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <p style="font-size:13px;color:rgba(255,255,255,.28);font-weight:500">© <span id="yr"></span> D-Maths Tuition Centre. All rights reserved.</p>
        <p style="font-size:13px;color:rgba(255,255,255,.28);font-weight:500">Designed with ♥ for learners in Nigeria</p>
      </div>
    </div>
  </footer>
</div>

<!-- ═══════════════════════════════════════ -->
<!--  GATEWAY                               -->
<!-- ═══════════════════════════════════════ -->
<div id="vg" class="view">
  <div class="gw">
    <div style="position:absolute;top:-10%;left:-5%;width:50vw;height:50vw;border-radius:50%;background:radial-gradient(rgba(212,160,23,.07),transparent 70%);pointer-events:none"></div>
    <div style="position:absolute;bottom:-5%;right:-5%;width:40vw;height:40vw;border-radius:50%;background:radial-gradient(rgba(10,22,40,.8),transparent 70%);pointer-events:none"></div>
    <div style="position:relative;z-index:1;width:100%;max-width:500px">
      <button onclick="goLanding()" style="background:none;border:none;color:rgba(255,255,255,.45);cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13.5px;font-weight:600;margin-bottom:28px;font-family:var(--font-body);transition:color .15s" onmouseover="this.style.color='rgba(255,255,255,.8)'" onmouseout="this.style.color='rgba(255,255,255,.45)'">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>Back to D-Maths
      </button>
      <div id="gw-content"></div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════ -->
<!--  SIGNUP                                -->
<!-- ═══════════════════════════════════════ -->
<div id="vs" class="view">
  <div style="min-height:100vh;background:var(--cream)">
    <div class="suhdr">
      <div id="logo-s"></div>
      <button onclick="goGateway()" style="background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:var(--r);color:rgba(255,255,255,.7);padding:8px 18px;cursor:pointer;font-size:13.5px;display:flex;align-items:center;gap:7px;font-family:var(--font-body);font-weight:600">← Back</button>
    </div>
    <div style="background:var(--white);border-bottom:1px solid var(--g100);padding:20px clamp(16px,4vw,60px)">
      <div style="max-width:760px;margin:0 auto" id="stepbar"></div>
    </div>
    <div style="max-width:760px;margin:0 auto;padding:32px clamp(16px,4vw,0px)">
      <div class="card cp si" id="sucard"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;gap:14px;margin-top:0">
        <button class="btn btn-ghost" id="prev-btn" style="min-height:46px;display:none" onclick="suPrev()">← Previous</button>
        <div></div>
        <button class="btn btn-gold" id="next-btn" style="min-height:46px" onclick="suNext()">Next Step →</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════ -->
<!--  PENDING                               -->
<!-- ═══════════════════════════════════════ -->
<div id="vp" class="view">
  <div style="min-height:100vh;background:var(--bg);display:flex;align-items:center;justify-content:center;padding:24px">
    <div style="width:100%;max-width:540px" id="pend-content"></div>
  </div>
</div>

<!-- ═══════════════════════════════════════ -->
<!--  PORTAL                                -->
<!-- ═══════════════════════════════════════ -->
<div id="vpt" class="view">
  <nav id="psidebar">
    <div style="padding:20px 16px 16px;border-bottom:1px solid rgba(255,255,255,.07);margin-bottom:8px">
      <div id="sb-logo"></div>
      <div style="display:flex;align-items:center;gap:8px;margin-top:10px">
        <div class="sync-dot" id="sync-dot"></div>
        <span style="font-family:var(--font-mono);font-size:10px;color:rgba(255,255,255,.3);font-weight:500;letter-spacing:.08em" id="sb-role"></span>
      </div>
    </div>
    <div style="flex:1;padding:6px 10px;overflow-y:auto" id="sb-nav"></div>
    <div style="padding:12px 10px 20px;border-top:1px solid rgba(255,255,255,.07)">
      <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:rgba(255,255,255,.04);border-radius:var(--r);margin-bottom:6px" id="sb-user"></div>
      <button class="nl" style="color:rgba(255,255,255,.36)" onclick="logout()">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/></svg>Sign Out
      </button>
    </div>
  </nav>
  <div id="sovl" onclick="closeSB()"></div>
  <header id="ptopbar">
    <button class="btn btn-ghost btn-ico" style="background:rgba(255,255,255,.08);color:#fff;border-color:transparent" onclick="toggleSB()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
    </button>
    <div id="tb-logo"></div>
    <div style="display:flex;align-items:center;gap:8px;margin-left:auto">
      <button id="search-btn" title="Search" onclick="openSearch()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      </button>
      <div id="bell-wrap">
        <button id="bell-btn" onclick="toggleBell()" title="Notifications">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span id="bell-badge"></span>
        </button>
        <div id="bell-drop">
          <div id="bell-drop-hdr">
            <span style="font-size:13px;font-weight:700;color:var(--g900)">Notifications</span>
            <button onclick="markAllRead()" style="font-size:12px;font-weight:700;color:var(--gold-dark);background:none;border:none;cursor:pointer">Mark all read</button>
          </div>
          <div id="bell-drop-list"></div>
        </div>
      </div>
      <button id="dm-toggle" title="Toggle dark mode" onclick="toggleDarkMode()">🌙</button>
    </div>
    <div id="tb-av" style="flex-shrink:0"></div>
  </header>
  <main id="pmain">
    <div id="portal-pages"></div>
  </main>
  <nav id="pbnav"></nav>
</div>


<script>
// ════════════════════════════════════════════════════════════════
//  CONFIG
// ════════════════════════════════════════════════════════════════
const SHEET_API = "https://script.google.com/macros/s/AKfycbxOxqmGz3_MiqbSOfHUR8_VyRB5E9lp3BgTWbsgDQrccHnLVOYvNfxVFmyaL5CCm6WX/exec";

const S = { token:null,
  user:null,role:null,gwMode:'choose',suStep:1,suData:{subjects:[]},
  activePg:'dashboard',appFilter:'all',selStudent:null,
  charts:{},
  apps:[],students:[],classes:[],assignments:[],notices:[],
  pollTimer:null
};

// ════════════════════════════════════════════════════════════════
//  SECURITY HELPERS
// ════════════════════════════════════════════════════════════════
// Escape HTML to prevent XSS when inserting user content
const sanitize = s => String(s||'')
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;').replace(/'/g,'&#x27;').replace(/`/g,'&#x60;');

// Login rate limiter — max 5 attempts per 5 minutes per type
const _loginAttempts = {student:{count:0,lockedUntil:0}, admin:{count:0,lockedUntil:0}};
function checkLoginRate(type){
  const rec=_loginAttempts[type];
  if(Date.now()<rec.lockedUntil) return Math.ceil((rec.lockedUntil-Date.now())/1000);
  return 0; // 0 = not locked
}
function recordLoginFail(type){
  const rec=_loginAttempts[type];
  rec.count++;
  if(rec.count>=5){ rec.lockedUntil=Date.now()+5*60*1000; rec.count=0; }
}
function clearLoginFail(type){ _loginAttempts[type].count=0; _loginAttempts[type].lockedUntil=0; }

// Input length validator
const MAX_LENS = {name:80, id:20, email:100, password:128, text:500, url:2048, note:2000};
function validateLen(val, type='text'){
  const max=MAX_LENS[type]||500;
  if(!val) return '';
  return String(val).slice(0,max);
}

// Role guard — call at top of any admin-only render function
function requireAdmin(){
  if(S.role!=='admin'){ toast('Access denied.','e'); navTo('dashboard'); return false; }
  return true;
}
function requireStudent(){
  if(S.role!=='student'){ toast('Access denied.','e'); navTo('dashboard'); return false; }
  return true;
}


// ════════════════════════════════════════════════════════════════
//  API LAYER
// ════════════════════════════════════════════════════════════════
const API = {
  async call(action, params={}) {
    try {
      const url = new URL(SHEET_API);
      url.searchParams.set('action', action);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, typeof v==='object'?JSON.stringify(v):String(v)));
      const r = await fetch(url.toString());
      if(!r.ok) throw new Error('HTTP '+r.status);
      return await r.json();
    } catch(e) { console.warn('API GET error:', action, e.message); return null; }
  },
  async post(action, data={}) {
    try {
      await fetch(SHEET_API, {
        method:'POST', mode:'no-cors',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({action,...data})
      });
      return {success:true};
    } catch(e) { console.warn('API POST error:', action, e.message); return null; }
  },
  async studentLogin(id, pw)  { const r=await this.call('studentLogin',{studentId:id,password:pw}); return r?.success?r.student:null; },
  async studentLoginFull(id,pw){ return await this.call('studentLogin',{studentId:id,password:pw}); },
  async adminLogin(em, pw)    { const r=await this.call('adminLogin',{email:em,password:pw}); return r?.success?r.admin:null; },
  async adminLoginFull(em,pw)  { return await this.call('adminLogin',{email:em,password:pw}); },
  async getApps()             { const r=await this.call('getApplications');  return Array.isArray(r?.data)?r.data:[]; },
  async getStudents()         { const r=await this.call('getStudents');       return Array.isArray(r?.data)?r.data:[]; },
  async getClasses()          { const r=await this.call('getClasses');        return Array.isArray(r?.data)?r.data:[]; },
  async getAssignments()      { const r=await this.call('getAssignments');    return Array.isArray(r?.data)?r.data:[]; },
  async getNotices()          { const r=await this.call('getNotices');        return Array.isArray(r?.data)?r.data:[]; },
  async getNotes(sid)         { const r=await this.call('getNotes',{studentId:sid}); return Array.isArray(r?.data)?r.data:[]; },
  async submitApp(d)          { return await this.post('submitApplication',d); },
  async approveApp(id)        { return await this.post('approveApplication',{id}); },
  async rejectApp(id)         { return await this.post('rejectApplication',{id}); },
  async addClass(d)           { return await this.post('addClass',d); },
  async addAssignment(d)      { return await this.post('addAssignment',d); },
  async gradeAssignment(d)    { return await this.post('gradeAssignment',d); },
  async addNotice(d)          { return await this.post('addNotice',d); },
  async deleteNotice(id)      { return await this.post('deleteNotice',{id}); },
  async saveNote(sid,note)    { return await this.post('saveNote',{studentId:sid,note,date:new Date().toLocaleDateString()}); },
  async sendContact(d)        { return await this.post('sendContact',d); },
  async updateStudent(d)      { return await this.post('updateStudent',d); },
  async addStudent(d)         { return await this.post('addStudent',d); },
  async updatePassword(d)     { return await this.post('updatePassword',d); },
  async markAttendance(d)     { return await this.post('markAttendance',d); },
  async resetPassword(d)      { return await this.post('resetPassword',d); },
};

// ════════════════════════════════════════════════════════════════
//  REAL-TIME SYNC
// ════════════════════════════════════════════════════════════════
function startPolling() {
  stopPolling();
  S.pollTimer = setInterval(syncFromSheets, 45000);
}
function stopPolling() {
  if(S.pollTimer){ clearInterval(S.pollTimer); S.pollTimer=null; }
}
async function syncFromSheets() {
  const dot=$id('sync-dot');
  if(dot) dot.className='sync-dot syncing';
  try {
    const [apps,students,classes,assignments,notices] = await Promise.all([
      API.getApps(),API.getStudents(),API.getClasses(),API.getAssignments(),API.getNotices()
    ]);
    const prevNotices = S.notices.length;
    S.apps=apps; S.students=students; S.classes=classes;
    S.assignments=assignments; S.notices=notices;
    if(S.role==='student'&&S.user){
      const fresh=S.students.find(x=>x.id===S.user.id);
      if(fresh) S.user=fresh;
    }
    if(S.notices.length > prevNotices) toast('New announcement posted!','i');
    renderPage(S.activePg);
    if(S.role==='admin') refreshNavBadges();
  } catch(e){ console.warn('Sync error:',e.message); }
  if(dot) dot.className='sync-dot';
}
function refreshNavBadges(){
  const pend=S.apps.filter(a=>a.status==='pending').length;
  document.querySelectorAll('#sb-nav .nl').forEach(el=>{
    if((el.getAttribute('onclick')||'').includes("'applications'")){
      let b=el.querySelector('.nbadge');
      if(pend){ if(!b){b=document.createElement('span');b.className='nbadge';el.appendChild(b);} b.textContent=pend; }
      else if(b) b.remove();
    }
  });
}

// ════════════════════════════════════════════════════════════════
//  ICONS
// ════════════════════════════════════════════════════════════════
const IC = {
  home:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
  users:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  video:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>`,
  file:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`,
  trend:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>`,
  bell:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
  user:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
  shield:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
  chart:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
  uc:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>`,
  eye:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`,
  edit:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
  trash:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>`,
  plus:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
  send:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>`,
  ar:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>`,
  al:`<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>`,
  chk:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`,
  x:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>`,
  refresh:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>`,
  lock:`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>`,
  warn:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
  clock:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
  cal:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
  mail:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22 6 12 13 2 6"/></svg>`,
  phone:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 13.5a19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 3.64 2.88h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 10.1a16 16 0 0 0 5.91 5.91l.82-.82a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
  map:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
  star:`<svg width="14" height="14" viewBox="0 0 24 24" fill="var(--gold)" stroke="var(--gold)" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
  calc:`<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="12" y2="14"/><line x1="8" y1="18" x2="12" y2="18"/><line x1="16" y1="14" x2="16" y2="18"/></svg>`,
  card:`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>`,
};

// ════════════════════════════════════════════════════════════════
//  UTILS
// ════════════════════════════════════════════════════════════════
const $id = id => document.getElementById(id);
const html = (id,h) => { const e=$id(id); if(e) e.innerHTML=h; };
const safeArr = v => Array.isArray(v)?v:typeof v==='string'&&v?v.split(',').map(x=>x.trim()).filter(Boolean):[];

const logo = (lt=false, sz=34) =>
  `<div style="display:flex;align-items:center;gap:10px">
    <div style="width:${sz}px;height:${sz}px;border-radius:${Math.round(sz*.29)}px;background:linear-gradient(135deg,var(--gold),var(--gold-b));display:flex;align-items:center;justify-content:center;box-shadow:0 3px 12px rgba(212,160,23,.4);flex-shrink:0">${IC.calc.replace('stroke="currentColor"','stroke="#0A1628"')}</div>
    <div><div style="font-family:var(--font-logo);font-size:${Math.round(sz*.62)}px;color:${lt?'#fff':'var(--g900)'};line-height:1;letter-spacing:.02em">D-Maths</div>
    <div style="font-family:var(--font-mono);font-size:8px;color:${lt?'rgba(255,255,255,.3)':'var(--g400)'};letter-spacing:.14em;text-transform:uppercase;margin-top:1px">Tuition Centre</div></div>
  </div>`;

const av = (name, sz=36) => { name=sanitize(name);
  const init=(name||'U').split(' ').map(n=>n[0]||'').join('').slice(0,2).toUpperCase()||'U';
  const pal=['#D4A017','#0A1628','#059669','#2563EB','#EC4899','#7C3AED','#F97316','#0891B2'];
  const bg=pal[((name||'U').charCodeAt(0))%pal.length];
  const dark=['#D4A017','#059669','#F97316'].includes(bg);
  return `<div class="av" style="width:${sz}px;height:${sz}px;font-size:${Math.round(sz*.36)}px;background:${bg};color:${dark?'#060E1A':'#fff'}">${init}</div>`;
};

const bdg = st => {
  const m={Graded:'b-green',Submitted:'b-blue',Pending:'b-amber',Active:'b-green',Inactive:'b-red',
    Zoom:'b-blue','Google Meet':'b-green',Teams:'b-purple',pending:'b-amber',approved:'b-green',rejected:'b-red'};
  return `<span class="badge ${m[st]||'b-gray'}">${st}</span>`;
};

const infoRow = (icon,label,val) =>
  `<div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:12px">
    <div style="width:32px;height:32px;border-radius:9px;background:var(--g50);border:1px solid var(--g100);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--g400)">${icon}</div>
    <div><div style="font-size:11px;color:var(--g400);font-weight:700;text-transform:uppercase;letter-spacing:.06em;margin-bottom:1px">${label}</div>
    <div style="font-size:13.5px;color:var(--g700);font-weight:600">${val||'—'}</div></div>
  </div>`;

const statCard = (emoji,label,value,trend,color) =>
  `<div class="sc">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <span style="font-size:11px;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:var(--g400)">${label}</span>
      <div style="width:42px;height:42px;border-radius:12px;background:${color}18;display:flex;align-items:center;justify-content:center;font-size:20px">${emoji}</div>
    </div>
    <div style="font-family:var(--font-display);font-size:clamp(22px,3vw,32px);font-weight:800;color:var(--g900);margin-top:10px;line-height:1">${value}</div>
    ${trend?`<div style="font-size:12px;color:var(--green);margin-top:6px;font-weight:700">${trend}</div>`:''}
  </div>`;

// ════════════════════════════════════════════════════════════════
//  TOAST
// ════════════════════════════════════════════════════════════════
function toast(msg, type='i') {
  const host=$id('toast-host'); if(!host) return;
  const el=document.createElement('div');
  const icons={s:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`,
    e:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`,
    i:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`};
  el.className=`toast toast-${type}`;
  const _ti=document.createElement('span');_ti.innerHTML=icons[type]||icons.i;
  const _tm=document.createElement('span');_tm.textContent=msg;
  el.appendChild(_ti);el.appendChild(_tm);
  host.appendChild(el);
  setTimeout(()=>{el.style.cssText='opacity:0;transform:translateX(16px);transition:all .3s';setTimeout(()=>el.remove(),320);}, 3500);
}

// ════════════════════════════════════════════════════════════════
//  MODAL
// ════════════════════════════════════════════════════════════════
function openModal(title,content,wide=false){
  $id('mtitle').textContent=title;
  $id('mbody').innerHTML=content;
  $id('modal').classList.toggle('wide',wide);
  $id('ov').classList.add('open');
}
function closeModal(){ $id('ov').classList.remove('open'); }

// ════════════════════════════════════════════════════════════════
//  VIEW SWITCH
// ════════════════════════════════════════════════════════════════
function show(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  const el=$id(id); if(el) el.classList.add('on');
  window.scrollTo(0,0);
}
function goLanding(){ stopPolling(); show('vl'); }
function goGateway(){ stopPolling(); show('vg'); renderGW('choose'); }
function goSignup(){ show('vs'); initSignup(); }
function logout(){ stopPolling(); S.user=null; S.role=null; try{sessionStorage.removeItem('dm_sess');sessionStorage.removeItem('dm_pg');}catch(e){} goLanding(); }

window.addEventListener('scroll',()=>{
  const nav=$id('lnav');
  if(nav) nav.classList.toggle('scrolled', window.scrollY>40);
},{passive:true});

function scrollTo0(id){ document.getElementById(id)?.scrollIntoView({behavior:'smooth'}); closeDrawer(); }
function openDrawer(){ $id('mdrawer')?.classList.add('open'); }
function closeDrawer(){ $id('mdrawer')?.classList.remove('open'); }
function toggleSB(){ $id('psidebar')?.classList.toggle('open'); $id('sovl')?.classList.toggle('open'); }
function closeSB(){ $id('psidebar')?.classList.remove('open'); $id('sovl')?.classList.remove('open'); }

// ════════════════════════════════════════════════════════════════
//  LANDING
// ════════════════════════════════════════════════════════════════
function initLanding(){
  try {
    html('logo-l', logo(true));
    html('logo-d', logo(true));
    const yr=$id('yr'); if(yr) yr.textContent=new Date().getFullYear();

    const navs=[['home','Home'],['about','About'],['services','Subjects'],['how-it-works','How It Works'],['testimonials','Results'],['contact','Contact']];
    html('llinks', navs.map(([id,l])=>`<button class="llink" onclick="scrollTo0('${id}')">${l}</button>`).join(''));
    html('dlinks', navs.map(([id,l])=>`<button class="dlink" onclick="scrollTo0('${id}')">${l}</button>`).join(''));

    // Floating maths symbols
    const syms=['∑','∫','√','π','∞','∂','∆','θ','λ','Ω','≈','∇'];
    const pos=[{top:'8%',left:'3%',s:52},{top:'20%',right:'4%',s:60},{top:'55%',left:'2%',s:36},{top:'74%',right:'6%',s:44},{top:'88%',left:'14%',s:30},{top:'38%',right:'2%',s:54},{top:'28%',left:'7%',s:28},{bottom:'12%',right:'18%',s:40}];
    html('msyms', pos.map((p,i)=>{
      const cs=Object.entries(p).filter(([k])=>k!=='s').map(([k,v])=>`${k}:${v}`).join(';');
      return `<div class="msym" style="${cs};font-size:${p.s}px;animation:float ${3.5+i*.65}s ease-in-out ${i*.5}s infinite">${syms[i%syms.length]}</div>`;
    }).join(''));

    // Hero quick stats
    html('hstats', [['200+','Students'],['98%','Pass Rate'],['6','Expert Tutors'],['Est.2023','Founded']].map(([v,l])=>
      `<div><div style="font-family:var(--font-display);font-size:28px;font-weight:800;color:var(--gold-b)">${v}</div><div style="font-size:12px;color:rgba(255,255,255,.4);margin-top:2px;font-weight:600">${l}</div></div>`
    ).join(''));

    // Hero score preview bars
    html('hbars',[['Algebra','87',87,'#F2BC3B'],['Calculus','90',90,'#60A5FA'],['Statistics','92',92,'#34D399'],['Geometry','84',84,'#F472B6']].map(([s,p,v,c])=>
      `<div style="margin-bottom:14px"><div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-size:13px;color:rgba(255,255,255,.7);font-weight:600">${s}</span><span style="font-size:13px;font-weight:800;color:${c}">${p}%</span></div><div style="background:rgba(255,255,255,.08);border-radius:99px;height:6px;overflow:hidden"><div style="width:${v}%;height:100%;background:${c};border-radius:99px"></div></div></div>`
    ).join(''));

    // About features
    html('afeat',[['✦','Expert Tutors','BSc & MSc qualified maths teachers with proven exam results'],['◎','Personalised Paths','Curriculum tailored to each student\'s current level and goals'],['↗','Live Analytics','Real-time scores and progress visible in your portal'],['⊕','Study Anywhere','Join live classes from any phone, tablet, or laptop']].map(([i,t,d])=>
      `<div style="display:flex;gap:12px;align-items:flex-start;padding:16px;background:var(--white);border-radius:var(--r-l);box-shadow:var(--sh)"><div style="width:36px;height:36px;border-radius:10px;background:rgba(212,160,23,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px;color:var(--gold)">${i}</div><div><div style="font-weight:800;font-size:14px;color:var(--g900);margin-bottom:3px">${t}</div><div style="font-size:12.5px;color:var(--g500);line-height:1.55">${d}</div></div></div>`
    ).join(''));
    html('achips',['WAEC Syllabus','BECE Prep','WASSCE Prep','University Entrance','Core Maths'].map(t=>`<span class="chip chip-gold">${t}</span>`).join(''));

    // Subjects grid
    html('subs-grid',[
      {t:'Algebra & Pre-Calculus',d:'Linear equations, polynomials, quadratics, functions, and inequalities for all levels.',l:'JSS 1–SSS 2',c:'#F2BC3B',e:'✕'},
      {t:'Calculus & Analysis',d:'Differential and integral calculus, limits, derivatives, and real-world problem solving.',l:'SSS 2–3',c:'#60A5FA',e:'∫'},
      {t:'Statistics & Probability',d:'Data analysis, probability distributions, regression, and hypothesis testing.',l:'JSS 3–SSS 3',c:'#34D399',e:'σ'},
      {t:'Geometry & Trigonometry',d:'Euclidean geometry, circle theorems, trigonometric identities, coordinate geometry.',l:'JSS 1–SSS 2',c:'#F472B6',e:'△'},
      {t:'Further Mathematics',d:'Complex numbers, matrices, vectors, and advanced topics for university entrance.',l:'SSS 3+',c:'#A78BFA',e:'∑'},
      {t:'Core Maths Revision',d:'Intensive BECE & WASSCE revision covering the complete core curriculum.',l:'All Levels',c:'#F2BC3B',e:'π'},
      {t:'Physics',d:'Mechanics, waves, electricity, magnetism and modern physics for exam success.',l:'SSS 1–3',c:'#22D3EE',e:'⚡'},
      {t:'JavaScript',d:'Web development fundamentals, DOM manipulation and modern ES6+ techniques.',l:'All Levels',c:'#FDE68A',e:'{}'},
      {t:'Python',d:'Data structures, algorithms, automation and data science basics with Python.',l:'All Levels',c:'#86EFAC',e:'🐍'}
    ].map(s=>`<div class="scard"><div style="width:50px;height:50px;border-radius:14px;background:${s.c}22;border:1px solid ${s.c}35;display:flex;align-items:center;justify-content:center;margin-bottom:18px;font-family:var(--font-mono);font-size:24px;color:${s.c};font-weight:600">${s.e}</div><h3 style="font-family:var(--font-display);font-size:20px;font-weight:700;color:#fff;margin-bottom:10px">${s.t}</h3><p style="font-size:13.5px;color:rgba(255,255,255,.52);line-height:1.72;margin-bottom:16px">${s.d}</p><span class="chip chip-navy" style="font-size:11px">${s.l}</span></div>`).join(''));

    // How it works steps
    html('steps-grid',[{t:'Register & Pay',d:'Submit your registration form and complete payment via Mobile Money or bank transfer.',e:'💳'},{t:'Admin Verification',d:'Our admin team verifies your payment and details within 24 hours.',e:'🔍'},{t:'Portal Access',d:'Receive your unique Student ID and password via email.',e:'🎓'},{t:'Start Learning',d:'Join live classes, submit assignments, and track your academic progress.',e:'📚'}].map((s,i)=>
      `<div class="card cp" style="text-align:center;position:relative"><div style="position:absolute;top:14px;right:18px;width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-b));display:flex;align-items:center;justify-content:center;font-family:var(--font-display);font-weight:800;font-size:13px;color:var(--navy-d)">${i+1}</div><div style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-b));display:flex;align-items:center;justify-content:center;margin:0 auto 18px;box-shadow:0 8px 24px rgba(212,160,23,.38);font-size:28px">${s.e}</div><h4 style="font-family:var(--font-display);font-size:20px;font-weight:700;color:var(--g900);margin-bottom:10px">${s.t}</h4><p style="font-size:13.5px;color:var(--g500);line-height:1.72">${s.d}</p></div>`
    ).join(''));

    // Stats counter
    html('stats-grid',[['98%','Student Pass Rate','BECE & WASSCE'],['200+','Active Students','JSS & SSS'],['6','Expert Tutors','MSc & BSc qualified'],['3yrs','Excellence','est. 2023'],['24h','Tutor Response','guaranteed'],['4','Core Subjects','full curriculum']].map(([v,l,s])=>
      `<div style="text-align:center"><div class="scount">${v}</div><div style="font-weight:800;font-size:14px;color:#fff;margin-top:8px">${l}</div><div style="font-size:12px;color:rgba(255,255,255,.35);margin-top:4px;font-weight:500">${s}</div></div>`
    ).join(''));

    // Testimonials
    html('test-grid',[
      {n:'Joseph Victor',r:'SSS 2 Student',t:'D-Maths transformed my understanding of calculus completely. I went from failing to scoring 91% in just 3 months.'},
      {n:' Mrs Adetunji',r:'Parent',t:"My daughter's confidence in mathematics has improved remarkably. The personalised feedback from each tutor is incredible."},
      {n:' Alli Abdulsamod',r:'Federal University of Abeokuta',t:'D-Maths prepared me exceptionally well for my university entrance exams. I credit them entirely for my distinction.'},
      {n:'Dr. Lookman Ayobami',r:'Parent & STEM Advocate',t:'The quality of instruction here rivals any international institution. Truly exceptional educators who care.'}
    ].map(t=>`<div class="tcard fu"><div style="display:flex;gap:3px;margin-bottom:14px">${IC.star.repeat(5)}</div><p style="font-size:14.5px;color:var(--g700);line-height:1.82;margin-bottom:20px;font-style:italic">"${t.t}"</p><div style="display:flex;align-items:center;gap:12px;padding-top:16px;border-top:1px solid var(--g100)"><div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--navy),var(--navy-m));display:flex;align-items:center;justify-content:center;flex-shrink:0"><span style="font-family:var(--font-display);font-weight:700;font-size:17px;color:var(--gold-b)">${t.n[0]+t.n.split(' ')[1][0]}</span></div><div><div style="font-weight:800;font-size:14px;color:var(--g900)">${t.n}</div><div style="font-size:12px;color:var(--g400);margin-top:1px">${t.r}</div></div></div></div>`).join(''));

    // Contact info
    html('cinfo',[
      [IC.mail,'Email Us','dmathstuition@gmail.com','oladembak@gmail.com'],
      [IC.phone,'WhatsApp / Call',' +234 7025674894',' +234 8071667406'],
      [IC.map,'Location','Asaba, Delta','Asaba, Nigeria'],
      [IC.clock,'Office Hours','Mon–Fri: 8AM – 8PM','Saturday: 9AM – 5PM']
    ].map(([icon,l,l1,l2])=>`<div style="display:flex;gap:16px;align-items:flex-start;margin-bottom:22px"><div style="width:44px;height:44px;border-radius:12px;background:rgba(212,160,23,.12);border:1px solid rgba(212,160,23,.22);display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--gold)">${icon}</div><div><div style="font-size:12px;color:var(--g400);font-weight:700;text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">${l}</div><div style="font-size:14px;color:var(--g900);font-weight:700">${l1}</div><div style="font-size:13.5px;color:var(--g500);margin-top:2px">${l2}</div></div></div>`).join(''));

    // Footer grid
    html('footer-g',`<div>${logo(true)}<p style="font-size:13.5px;color:rgba(255,255,255,.38);line-height:1.8;margin-top:16px;max-width:270px;font-weight:400">Delivering world-class online mathematics education to JSS and SSS students across Nigeria and beyond.</p></div>
    <div><h4 style="font-family:var(--font-display);font-size:17px;font-weight:700;color:#fff;margin-bottom:18px">Quick Links</h4><div style="display:flex;flex-direction:column;gap:10px">${['Home','About','Subjects','How It Works','Results','Contact'].map(l=>`<button onclick="scrollTo0('${l.toLowerCase().replace(/\s+/g,'-')}')" style="background:none;border:none;font-size:13.5px;color:rgba(255,255,255,.4);cursor:pointer;text-align:left;font-family:var(--font-body);font-weight:500;padding:0;transition:color .15s" onmouseover="this.style.color='rgba(255,255,255,.8)'" onmouseout="this.style.color='rgba(255,255,255,.4)'">${l}</button>`).join('')}</div></div>
    <div><h4 style="font-family:var(--font-display);font-size:17px;font-weight:700;color:#fff;margin-bottom:18px">Subjects</h4><div style="display:flex;flex-direction:column;gap:10px">${['Algebra','Calculus','Statistics','Geometry','Further Maths','Core Revision'].map(l=>`<span style="font-size:13.5px;color:rgba(255,255,255,.4);font-weight:500">${l}</span>`).join('')}</div></div>
    <div><h4 style="font-family:var(--font-display);font-size:17px;font-weight:700;color:#fff;margin-bottom:18px">Student Portal</h4><p style="font-size:13.5px;color:rgba(255,255,255,.4);line-height:1.7;margin-bottom:18px;font-weight:400">Already enrolled? Access your personalised learning dashboard.</p><button class="btn btn-gold btn-w" onclick="goGateway()">Enter Portal →</button></div>`);

    // Responsive grid adjustments
    const w=window.innerWidth;
    const ag=$id('about-grid'); if(ag) ag.style.gridTemplateColumns=w<860?'1fr':'1fr 1fr';
    const cg=$id('contact-grid'); if(cg) cg.style.gridTemplateColumns=w<860?'1fr':'1fr 1fr';
    const fg=$id('footer-g'); if(fg) fg.style.gridTemplateColumns=w<540?'1fr':w<860?'repeat(2,1fr)':'1.8fr 1fr 1fr 1.2fr';
    const sg=$id('stats-grid'); if(sg) sg.style.gridTemplateColumns=w<600?'repeat(2,1fr)':'repeat(3,1fr)';

  } catch(err) { console.error('initLanding error:', err); }
}

async function sendContact(){
  const n=$id('cn')?.value.trim(), e=$id('ce')?.value.trim(), m=$id('cm')?.value.trim();
  if(!n||!e||!m){ toast('Please fill in all required fields.','e'); return; }
  const btn=document.querySelector('#contact .btn-gold');
  if(btn){ btn.disabled=true; btn.innerHTML='<div class="spinner spd"></div> Sending...'; }
  await API.sendContact({name:n,email:e,phone:$id('cp')?.value||'',subject:$id('cs')?.value||'',message:m});
  toast('Message sent! We\'ll get back to you within 24 hours. 🎉','s');
  ['cn','ce','cp','cm'].forEach(id=>{ const el=$id(id); if(el) el.value=''; });
  if(btn){ btn.disabled=false; btn.innerHTML='Send Message →'; }
}

// ════════════════════════════════════════════════════════════════
//  GATEWAY
// ════════════════════════════════════════════════════════════════
function renderGW(mode){
  S.gwMode=mode;
  const host=$id('gw-content'); if(!host) return;
  if(mode==='choose'){
    host.innerHTML=`<div class="gwcard"><div class="gwhdr"><div style="position:absolute;top:-40px;right:-40px;width:160px;height:160px;border-radius:50%;background:rgba(212,160,23,.1)"></div>${logo(true)}<p style="color:rgba(255,255,255,.45);font-size:14px;margin-top:12px;font-weight:500">Welcome back — choose your portal to continue</p></div><div style="padding:28px;display:flex;flex-direction:column;gap:12px"><button class="btn btn-gold btn-w" style="min-height:52px;font-size:15px" onclick="renderGW('student')">${IC.user} Student Login</button><button class="btn btn-navy btn-w" style="min-height:52px;border:1px solid rgba(255,255,255,.1);font-size:15px" onclick="renderGW('admin')">${IC.shield} Administrator Login</button><div class="div"></div><p style="text-align:center;font-size:14px;color:var(--g500);font-weight:500">New to D-Maths?</p><button class="btn btn-og btn-w" style="min-height:48px" onclick="goSignup()">${IC.plus} Apply for Enrolment</button></div></div>`;
    return;
  }
  if(mode==='student'){
    host.innerHTML=`<div class="gwcard"><div class="gwhdr"><div style="position:absolute;top:-40px;right:-40px;width:160px;height:160px;border-radius:50%;background:rgba(212,160,23,.1)"></div><div style="display:flex;align-items:center;justify-content:space-between">${logo(true)}<span class="badge b-gold">Student Portal</span></div></div><div style="padding:28px"><div id="gw-err"></div><div class="fg"><label class="fl">Student ID <span class="freq">*</span></label><input class="fi-el" id="gw-id" placeholder="e.g. DM-2024-0001" oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')doSLogin()"></div><div class="fg"><label class="fl">Password <span class="freq">*</span></label><div style="position:relative"><input class="fi-el" id="gw-pw" type="password" placeholder="Enter your password" style="padding-right:52px" onkeydown="if(event.key==='Enter')doSLogin()"><button onclick="tpw('gw-pw',this)" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--g400);font-size:12px;font-weight:700;font-family:var(--font-body)">Show</button></div></div><div style="display:flex;justify-content:space-between;margin:-6px 0 22px"><button onclick="renderGW('choose')" style="background:none;border:none;color:var(--g400);font-size:13px;cursor:pointer;font-family:var(--font-body);font-weight:600">← Back</button><button style="background:none;border:none;color:var(--gold);font-size:13px;font-weight:700;cursor:pointer;font-family:var(--font-body)" onclick="toast('Contact admin: dmathstuition@gmail.com','i')">Forgot password?</button></div><button class="btn btn-gold btn-w" style="min-height:50px;font-size:15px" id="gw-sb" onclick="doSLogin()">Sign In ${IC.ar}</button><p style="text-align:center;margin-top:18px;font-size:13px;color:var(--g400);font-weight:500">Not enrolled? <button onclick="goSignup()" style="background:none;border:none;color:var(--gold);font-weight:700;cursor:pointer;font-size:13px;font-family:var(--font-body)">Apply here →</button></p></div></div>`;
    return;
  }
  host.innerHTML=`<div class="gwcard"><div style="background:linear-gradient(145deg,var(--navy-d),var(--navy-l));padding:28px;position:relative;overflow:hidden"><div style="position:absolute;top:-40px;right:-40px;width:140px;height:140px;border-radius:50%;background:rgba(212,160,23,.1)"></div><div style="display:flex;align-items:center;justify-content:space-between">${logo(true)}<div style="display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.08);padding:4px 12px;border-radius:99px">${IC.shield}<span style="font-size:11px;color:rgba(255,255,255,.6);font-weight:800;letter-spacing:.08em">ADMIN</span></div></div></div><div style="padding:28px"><div id="gw-aerr"></div><div class="fg"><label class="fl">Admin Email</label><input class="fi-el" id="gw-aem" type="email" placeholder="admin@dmaths.edu.gh" onkeydown="if(event.key==='Enter')doALogin()"></div><div class="fg"><label class="fl">Password</label><input class="fi-el" id="gw-apw" type="password" placeholder="Admin password" onkeydown="if(event.key==='Enter')doALogin()"></div><div style="margin-bottom:20px"><button onclick="renderGW('choose')" style="background:none;border:none;color:var(--g400);font-size:13px;cursor:pointer;font-family:var(--font-body);font-weight:600">← Back</button></div><button class="btn btn-navy btn-w" style="min-height:50px;font-size:15px;border:1px solid rgba(255,255,255,.1)" id="gw-ab" onclick="doALogin()">${IC.shield} Access Dashboard</button></div></div>`;
}

function tpw(id,btn){ const el=$id(id); if(!el)return; el.type=el.type==='password'?'text':'password'; btn.textContent=el.type==='password'?'Show':'Hide'; }
function gwErr(id,msg){ const el=$id(id); if(el) el.innerHTML=`<div class="al al-e">${IC.warn} ${msg}</div>`; }

async function doSLogin(){
  const sid=$id('gw-id')?.value.trim(), pw=$id('gw-pw')?.value;
  if(!sid||!pw){ gwErr('gw-err','Please enter your Student ID and password.'); return; }
  const lockSecs=checkLoginRate('student');
  if(lockSecs>0){ gwErr('gw-err',`Too many attempts. Please wait ${lockSecs} seconds.`); return; }
  const btn=$id('gw-sb'); if(btn){ btn.disabled=true; btn.innerHTML='<div class="spinner"></div> Signing in...'; }
  const sr=await API.studentLoginFull(validateLen(sid,'id'),validateLen(pw,'password'));
  const student=sr?.student||null;
  if(student){ clearLoginFail('student'); S.user=student; S.role='student'; S.token=sr.token||null;
    try{sessionStorage.setItem('dm_sess',JSON.stringify({user:student,role:'student',token:sr.token||null,ts:Date.now()}));}catch(e){}
    show('vpt'); await initPortal(); }
  else { recordLoginFail('student'); if(btn){ btn.disabled=false; btn.innerHTML=`Sign In ${IC.ar}`; } gwErr('gw-err','Invalid Student ID or password. Please check your credentials.'); }
}

async function doALogin(){
  const em=$id('gw-aem')?.value.trim(), pw=$id('gw-apw')?.value;
  if(!em||!pw){ gwErr('gw-aerr','Please enter your credentials.'); return; }
  const lockSecs=checkLoginRate('admin');
  if(lockSecs>0){ gwErr('gw-aerr',`Too many attempts. Please wait ${lockSecs} seconds.`); return; }
  const btn=$id('gw-ab'); if(btn){ btn.disabled=true; btn.innerHTML='<div class="spinner spd"></div>'; }
  const ar=await API.adminLoginFull(validateLen(em,'email'),validateLen(pw,'password'));
  const admin=ar?.admin||null;
  if(admin){ clearLoginFail('admin'); S.user=admin; S.role='admin'; S.token=ar.token||null;
    try{sessionStorage.setItem('dm_sess',JSON.stringify({user:admin,role:'admin',token:ar.token||null,ts:Date.now()}));}catch(e){}
    show('vpt'); await initPortal(); }
  else { recordLoginFail('admin'); if(btn){ btn.disabled=false; btn.innerHTML=`${IC.shield} Access Dashboard`; } gwErr('gw-aerr','Invalid credentials. Please try again.'); }
}

// ════════════════════════════════════════════════════════════════
//  SIGNUP
// ════════════════════════════════════════════════════════════════
function initSignup(){ S.suStep=1; S.suData={subjects:[]}; html('logo-s',logo(true)); renderSUStep(); }

function renderSUBar(){
  const titles=['Personal Info','Academic Details','Payment Info'];
  html('stepbar',`<div style="display:flex;align-items:center">${titles.map((t,i)=>{
    const n=i+1, done=S.suStep>n, act=S.suStep===n;
    return `<div style="display:flex;align-items:center;${i<titles.length-1?'flex:1':''}"><div style="display:flex;align-items:center;gap:10px"><div style="width:32px;height:32px;border-radius:50%;background:${done?'var(--green)':act?'var(--gold)':'var(--g200)'};display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:${act?'var(--navy-d)':'#fff'};flex-shrink:0;transition:all .3s">${done?IC.chk:n}</div><div><div style="font-size:11px;color:${act?'var(--gold)':'var(--g400)'};font-weight:700;text-transform:uppercase;letter-spacing:.07em">Step ${n}</div><div style="font-size:13px;font-weight:700;color:${act?'var(--g900)':'var(--g400)'}">${t}</div></div></div>${i<titles.length-1?`<div style="flex:1;height:2px;background:${done?'var(--green)':'var(--g200)'};margin:0 12px;transition:background .3s"></div>`:''}</div>`;
  }).join('')}</div>`);
}

function renderSUStep(){
  renderSUBar();
  const d=S.suData, prev=$id('prev-btn'), nxt=$id('next-btn');
  if(prev) prev.style.display=S.suStep>1?'inline-flex':'none';
  if(nxt) nxt.innerHTML=S.suStep<3?`Next Step ${IC.ar}`:`${IC.send} Submit Application`;
  const subs=['Algebra', 'Calculus', 'Statistics', 'Geometry', 'Further Mathematics', 'Core Maths Revision', 'Physics', 'JavaScript', 'Python', 'External Examinations'];
  let content='';
  if(S.suStep===1){
    content=`<h2 style="font-family:var(--font-display);font-size:26px;font-weight:700;color:var(--g900);margin-bottom:6px">Personal Information</h2><p style="color:var(--g400);font-size:14px;margin-bottom:24px;font-weight:500">Provide your personal details to begin.</p><div class="frow"><div class="fg"><label class="fl">First Name <span class="freq">*</span></label><input class="fi-el" id="su-fn" placeholder="e.g. Akosua" value="${d.firstName||''}"></div><div class="fg"><label class="fl">Last Name <span class="freq">*</span></label><input class="fi-el" id="su-ln" placeholder="e.g. Bakare" value="${d.lastName||''}"></div></div><div class="frow"><div class="fg"><label class="fl">Email <span class="freq">*</span></label><input class="fi-el" id="su-em" type="email" placeholder="student@email.com" value="${d.email||''}"></div><div class="fg"><label class="fl">Phone <span class="freq">*</span></label><input class="fi-el" id="su-ph" type="tel" placeholder="+234 XX XXX XXXX" value="${d.phone||''}"></div></div><div class="frow"><div class="fg"><label class="fl">Date of Birth</label><input class="fi-el" id="su-dob" type="date" value="${d.dob||''}"></div><div class="fg"><label class="fl">Town / Area</label><input class="fi-el" id="su-addr" placeholder="e.g. East Legon, Accra" value="${d.address||''}"></div></div>`;
  } else if(S.suStep===2){
    content=`<h2 style="font-family:var(--font-display);font-size:26px;font-weight:700;color:var(--g900);margin-bottom:6px">Academic Details</h2><p style="color:var(--g400);font-size:14px;margin-bottom:24px;font-weight:500">Tell us about your current level and goals.</p><div class="frow"><div class="fg"><label class="fl">Current Level <span class="freq">*</span></label><select class="fi-el" id="su-lvl">${['JSS 1','JSS 2','JSS 3','SSS 1','SSS 2','SSS 3'].map(l=>`<option ${d.level===l?'selected':''}>${l}</option>`).join('')}</select></div><div class="fg"><label class="fl">Guardian Name <span class="freq">*</span></label><input class="fi-el" id="su-gn" placeholder="Parent/Guardian full name" value="${d.guardian||''}"></div></div><div class="fg"><label class="fl">Guardian Contact <span class="freq">*</span></label><input class="fi-el" id="su-gc" type="tel" placeholder="+234 XX XXX XXXX" value="${d.guardianContact||''}"></div><div class="fg"><label class="fl">Subjects Needed <span class="freq">*</span></label><div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">${subs.map(s=>{const ck=(d.subjects||[]).includes(s);return`<label style="display:flex;align-items:center;gap:7px;padding:8px 14px;border:1.5px solid ${ck?'var(--gold)':'var(--g200)'};border-radius:99px;cursor:pointer;font-size:13px;font-weight:600;background:${ck?'var(--gold-pale)':'#fff'};transition:all .18s"><input type="checkbox" value="${s}" ${ck?'checked':''} onchange="toggleSubject('${s}',this.checked)" style="display:none">${s}</label>`;}).join('')}</div></div><div class="fg"><label class="fl">Notes / Goals</label><textarea class="fi-el" id="su-notes" rows="3" placeholder="e.g. Preparing for BECE, weak in integration...">${d.notes||''}</textarea></div>`;
  } else {
    content=`<h2 style="font-family:var(--font-display);font-size:26px;font-weight:700;color:var(--g900);margin-bottom:6px">Payment Information</h2><p style="color:var(--g400);font-size:14px;margin-bottom:20px;font-weight:500">Provide payment details for enrolment fee verification.</p><div class="al al-i">${IC.warn} Send payment to: <strong>Opay: 7025674894</strong> or <strong>Access bank: 1534530227</strong>. Use your full name as reference.</div><div class="frow"><div class="fg"><label class="fl">Payment Reference <span class="freq">*</span></label><input class="fi-el" id="su-ref" placeholder="e.g. PAY-8821 or transaction ID" value="${d.paymentRef||''}"></div><div class="fg"><label class="fl">Payment Method <span class="freq">*</span></label><select class="fi-el" id="su-pm">${[ 'Access Bank Transfer','Opay Bank Transfer','Cash'].map(m=>`<option value="${m}" ${d.paymentMethod===m?'selected':''}>${m||'Select method'}</option>`).join('')}</select></div></div><div class="frow"><div class="fg"><label class="fl">Amount Paid(Naira) <span class="freq">*</span></label><input class="fi-el" id="su-amt" type="number" placeholder="e.g. 450" value="${d.paymentAmt||''}"></div><div class="fg"><label class="fl">Payment Date <span class="freq">*</span></label><input class="fi-el" id="su-pd" type="date" value="${d.paymentDate||''}"></div></div><div style="background:var(--gold-pale);border:1px solid rgba(212,160,23,.28);border-radius:var(--r-l);padding:18px 20px"><p style="font-size:13.5px;color:var(--gold-dark);font-weight:700;margin-bottom:6px">📋 What happens next?</p><p style="font-size:13px;color:var(--gold-dark);line-height:1.7;font-weight:400">After submission, admin verifies payment within <strong>24 hours</strong>. You\'ll receive your Student ID and password by email.</p></div>`;
  }
  html('sucard',content);
}

function toggleSubject(s,checked){
  if(!S.suData.subjects) S.suData.subjects=[];
  if(checked){ if(!S.suData.subjects.includes(s)) S.suData.subjects.push(s); }
  else { S.suData.subjects=S.suData.subjects.filter(x=>x!==s); }
}
function suPrev(){ if(S.suStep>1){ S.suStep--; renderSUStep(); } }

async function suNext(){
  const d=S.suData;
  if(S.suStep===1){
    d.firstName=$id('su-fn')?.value.trim(); d.lastName=$id('su-ln')?.value.trim();
    d.email=$id('su-em')?.value.trim(); d.phone=$id('su-ph')?.value.trim();
    d.dob=$id('su-dob')?.value||''; d.address=$id('su-addr')?.value.trim()||'';
    if(!d.firstName||!d.lastName||!d.email||!d.phone){ toast('Please fill in all required fields.','e'); return; }
    S.suStep=2; renderSUStep(); return;
  }
  if(S.suStep===2){
    d.level=$id('su-lvl')?.value||''; d.guardian=$id('su-gn')?.value.trim()||'';
    d.guardianContact=$id('su-gc')?.value.trim()||''; d.notes=$id('su-notes')?.value.trim()||'';
    if(!(d.subjects||[]).length){ toast('Please select at least one subject.','e'); return; }
    if(!d.guardian||!d.guardianContact){ toast('Please provide guardian details.','e'); return; }
    S.suStep=3; renderSUStep(); return;
  }
  d.paymentRef=$id('su-ref')?.value.trim()||''; d.paymentMethod=$id('su-pm')?.value||'';
  d.paymentAmt=$id('su-amt')?.value.trim()||''; d.paymentDate=$id('su-pd')?.value||'';
  if(!d.paymentRef||!d.paymentMethod||!d.paymentAmt){ toast('Please fill in all payment details.','e'); return; }
  const btn=$id('next-btn'); if(btn){ btn.disabled=true; btn.innerHTML='<div class="spinner spd"></div> Submitting...'; }
  const payload={...d,id:'REQ-'+Date.now(),status:'pending',applied:new Date().toISOString().split('T')[0]};
  await API.submitApp(payload);
  renderPending(payload);
  show('vp');
}

function renderPending(app){
  html('pend-content',`<div class="gwcard"><div style="background:linear-gradient(145deg,var(--navy-d),var(--navy-m));padding:36px;text-align:center;position:relative;overflow:hidden"><div style="position:absolute;top:-40px;left:-40px;width:160px;height:160px;border-radius:50%;background:rgba(212,160,23,.1)"></div><div style="width:76px;height:76px;border-radius:50%;background:var(--amber-bg);display:flex;align-items:center;justify-content:center;margin:0 auto 18px;animation:pulse 2s infinite;font-size:34px">⏳</div><h2 style="font-family:var(--font-display);font-weight:700;font-size:28px;color:#fff;margin-bottom:8px">Application Submitted!</h2><p style="color:rgba(255,255,255,.5);font-size:14px;font-weight:500">Your enrolment request is under review</p></div><div style="padding:28px"><div class="al al-i">${IC.clock} Awaiting admin verification within <strong>24 hours</strong>. Watch your email at <strong>${app.email}</strong>.</div><div style="display:flex;flex-direction:column;gap:8px;margin-bottom:22px">${[['Applicant',`${app.firstName} ${app.lastName}`],['Reference',app.paymentRef],['Amount',` Naira ${app.paymentAmt}`],['Submitted',app.applied],['Status','Pending Review']].map(([l,v])=>`<div style="display:flex;justify-content:space-between;padding:10px 14px;background:var(--g50);border-radius:var(--r)"><span style="font-size:13px;color:var(--g500);font-weight:600">${l}</span><span style="font-size:13.5px;font-weight:800;color:${l==='Status'?'var(--amber)':'var(--g900)'}">${v}</span></div>`).join('')}</div><button class="btn btn-navy btn-w" onclick="goLanding()" style="margin-bottom:12px">${IC.home} Return to D-Maths</button><p style="text-align:center;font-size:13px;color:var(--g400);font-weight:500">Questions? Email <strong style="color:var(--gold)">dmathstuition@gmail.com</strong></p></div></div>`);
}

// ════════════════════════════════════════════════════════════════
//  PORTAL INIT
// ════════════════════════════════════════════════════════════════
async function initPortal(){
  html('portal-pages','<div style="display:flex;align-items:center;justify-content:center;height:50vh"><div style="text-align:center"><div class="spinner spd" style="width:36px;height:36px;margin:0 auto 16px"></div><p style="color:var(--g400);font-size:14px;font-weight:600">Loading your portal...</p></div></div>');
  try {
    const [apps,students,classes,assignments,notices]=await Promise.all([API.getApps(),API.getStudents(),API.getClasses(),API.getAssignments(),API.getNotices()]);
    S.apps=apps; S.students=students; S.classes=classes; S.assignments=assignments; S.notices=notices;
    if(S.role==='student'&&S.user){ const fresh=S.students.find(x=>x.id===S.user.id); if(fresh) S.user=fresh; }
  } catch(e){ console.warn('Portal data load error:', e.message); }

  const isAdmin=S.role==='admin', u=S.user;
  const name=isAdmin?u.name:`${u.firstName} ${u.lastName}`;

  html('sb-logo',logo(true)); html('tb-logo',logo(true));
  const roleEl=$id('sb-role'); if(roleEl) roleEl.textContent=isAdmin?'ADMINISTRATOR':'STUDENT PORTAL';
  html('sb-user',`${isAdmin?`<div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-b));display:flex;align-items:center;justify-content:center;flex-shrink:0">${IC.shield.replace('stroke="currentColor"','stroke="var(--navy-d)"')}</div>`:av(name,38)}<div style="overflow:hidden;flex:1"><div style="color:#fff;font-size:13px;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div><div style="color:rgba(255,255,255,.35);font-size:11px;font-weight:500">${isAdmin?u.email:u.id}</div></div>`);
  html('tb-av',av(name,32));
  const pmain=$id('pmain'); if(pmain) pmain.classList.add('pmc');

  const pend=S.apps.filter(a=>a.status==='pending').length;
  const pendA=isAdmin?0:S.assignments.filter(a=>a.status==='Pending').length;
  const navItems=isAdmin?[
    {id:'dashboard',ic:IC.home,label:'Dashboard'},
    {id:'applications',ic:IC.uc,label:'Applications',badge:pend},
    {id:'students',ic:IC.users,label:'Students'},
    {id:'classes',ic:IC.video,label:'Classes'},
    {id:'assignments',ic:IC.file,label:'Assignments'},
    {id:'notices',ic:IC.bell,label:'Announcements'},
    {id:'reports',ic:IC.chart,label:'Reports'},
  ]:[
    {id:'dashboard',ic:IC.home,label:'Dashboard'},
    {id:'classes',ic:IC.video,label:'My Classes'},
    {id:'assignments',ic:IC.file,label:'Assignments',badge:pendA},
    {id:'progress',ic:IC.trend,label:'Progress'},
    {id:'notices',ic:IC.bell,label:'Notices'},
    {id:'profile',ic:IC.user,label:'Profile'},
  ];

  html('sb-nav',navItems.map(n=>`<button class="nl${S.activePg===n.id?' act':''}" onclick="navTo('${n.id}')">${n.ic}<span style="flex:1">${n.label}</span>${n.badge?`<span class="nbadge">${n.badge}</span>`:''}</button>`).join(''));
  const bItems=isAdmin?[{id:'dashboard',ic:IC.home,label:'Home'},{id:'applications',ic:IC.uc,label:'Apps'},{id:'students',ic:IC.users,label:'Students'},{id:'classes',ic:IC.video,label:'Classes'},{id:'reports',ic:IC.chart,label:'Reports'}]:[{id:'dashboard',ic:IC.home,label:'Home'},{id:'classes',ic:IC.video,label:'Classes'},{id:'assignments',ic:IC.file,label:'Tasks'},{id:'progress',ic:IC.trend,label:'Progress'},{id:'profile',ic:IC.user,label:'Profile'}];
  html('pbnav',bItems.map(n=>`<button class="bni${S.activePg===n.id?' act':''}" onclick="navTo('${n.id}')">${n.ic.replace('width="16" height="16"','width="20" height="20"')}<span>${n.label}</span></button>`).join(''));

  renderPage(S.activePg);
  startPolling();
}

function navTo(pageId){
  S.activePg=pageId; S.selStudent=null;
  try{sessionStorage.setItem('dm_pg',pageId);}catch(e){}
  document.querySelectorAll('#sb-nav .nl').forEach(el=>el.classList.toggle('act',(el.getAttribute('onclick')||'').includes(`'${pageId}'`)));
  document.querySelectorAll('#pbnav .bni').forEach(el=>el.classList.toggle('act',(el.getAttribute('onclick')||'').includes(`'${pageId}'`)));
  closeSB(); renderPage(pageId);
}

function renderPage(id){
  const isAdmin=S.role==='admin';
  const adminOnly=['applications','students','reports'];
  if(adminOnly.includes(id)&&!isAdmin){ toast('Access denied.','e'); navTo('dashboard'); return; }
  const studentOnly=['progress','profile'];
  if(studentOnly.includes(id)&&isAdmin){ navTo('dashboard'); return; }
  const pages={
    dashboard:isAdmin?renderADash:renderSDash,
    applications:renderAApps, students:renderAStudents,
    classes:isAdmin?renderAClasses:renderSClasses,
    assignments:isAdmin?renderAAssignments:renderSAssignments,
    notices:renderNotices, reports:renderReports,
    progress:renderSProgress, profile:renderSProfile,
    search:renderSearch,
  };
  const fn=pages[id]; if(fn) fn();
}

// ════════════════════════════════════════════════════════════════
//  STUDENT PAGES
// ════════════════════════════════════════════════════════════════
function renderSDash(){ if(!requireStudent()) return;
  const u=S.user;
  const myClasses=S.classes.filter(c=>safeArr(c.students).includes(u.id));
  const myAssigns=S.assignments.filter(a=>safeArr(a.assignedTo).length===0||safeArr(a.assignedTo).includes(u.id));
  const pending=myAssigns.filter(a=>a.status==='Pending').length;
  const recent=S.notices.slice(0,3);
  html('portal-pages',`<div class="pg on fi">
    <div class="dhero">
      <div style="position:absolute;right:-20px;top:-20px;width:200px;height:200px;border-radius:50%;background:radial-gradient(rgba(212,160,23,.2),transparent 70%)"></div>
      <span class="chip chip-gold" style="margin-bottom:12px;font-size:11px;position:relative;z-index:1">🎓 ${u.level||'Student'}</span>
      <h1 style="font-family:var(--font-display);font-size:clamp(20px,4vw,32px);font-weight:800;color:#fff;margin-bottom:6px;position:relative;z-index:1">Welcome back, ${u.firstName||u.name}! 👋</h1>
      <p style="color:rgba(255,255,255,.48);font-size:14px;position:relative;z-index:1;font-weight:500">ID: <strong style="color:rgba(255,255,255,.75);font-family:var(--font-mono)">${u.id}</strong>&nbsp;·&nbsp;Last sync: <span id="last-sync-txt">just now</span></p>
    </div>
    <div class="g4" style="margin-bottom:24px">
      ${statCard('🎬','My Classes',myClasses.length,null,'var(--blue)')}
      ${statCard('📝','Pending Tasks',pending,pending>0?'Action needed':null,'var(--amber)')}
      ${statCard('⭐','Avg Score',(u.avgScore||0)+'%',null,'var(--green)')}
      ${statCard('✅','Attendance',(u.attendance||0)+'%',null,'var(--purple)')}
    </div>
    <div>
      <div class="card cp">
        <h3 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900);margin-bottom:16px">Latest Notices</h3>
        ${recent.length?recent.map(n=>`<div style="display:flex;gap:11px;align-items:flex-start;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--g100)"><div style="width:36px;height:36px;border-radius:10px;background:rgba(212,160,23,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px">🔔</div><div><p style="font-size:13px;color:var(--g700);font-weight:700;line-height:1.4">${n.title}</p><p style="font-size:11px;color:var(--g400);margin-top:2px;font-weight:500">${n.date||''}</p></div></div>`).join(''):'<p style="font-size:13.5px;color:var(--g400);text-align:center;padding:20px 0;font-weight:500">No recent notices</p>'}
        <button class="btn btn-ghost btn-sm btn-w" onclick="navTo('notices')" style="margin-top:4px">View All Notices</button>
      </div>
    </div>
  </div>`);

}

function renderSClasses(){ if(!requireStudent()) return;
  const u=S.user;
  const myClasses=S.classes.filter(c=>safeArr(c.students).includes(u.id));
  const isCalView=(window._calView||'list')==='cal';
  const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const today=days[new Date().getDay()===0?6:new Date().getDay()-1]||'';

  const calHtml=()=>{
    const byDay={};
    days.forEach(d=>{byDay[d]=myClasses.filter(c=>c.day===d)});
    return `<div id="cal-grid">${days.map(d=>`<div class="cal-day-col">
      <div class="cal-day-hdr${d===today?' today':''}">${d.slice(0,3)}</div>
      ${byDay[d].length?byDay[d].map(cls=>`<div class="cal-cls-chip" onclick="window.open('${cls.link||'#'}','_blank')">
        <div class="cal-cls-chip-subj">${cls.subject}</div>
        <div class="cal-cls-chip-time">${cls.time||'—'}</div>
      </div>`).join(''):`<div class="cal-empty">—</div>`}
    </div>`).join('')}</div>`;
  };

  const listHtml=()=>myClasses.length?`<div class="gcls">${myClasses.map(cls=>`<div class="card fu"><div style="height:4px;background:linear-gradient(90deg,var(--gold),var(--gold-b))"></div><div class="cp"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px"><div><h3 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900);margin-bottom:4px">${cls.subject}</h3><p style="font-size:13px;color:var(--g400);font-weight:500">with ${cls.tutor}</p></div>${bdg(cls.platform||'Online')}</div>${infoRow(IC.cal,'Schedule',`${cls.day} at ${cls.time}`)}${infoRow(IC.clock,'Duration',cls.duration)}${cls.link&&cls.link!=='#'?infoRow(IC.video,'Class Link',`<a href="${cls.link}" target="_blank" style="color:var(--blue);text-decoration:underline">Join Now →</a>`):''}
        <div class="div"></div>
        <button class="btn btn-gold btn-w" onclick="${cls.link&&cls.link!=='#'?`window.open('${cls.link}','_blank')`:`toast('Class link not yet available. Check back soon.','i')`}">${IC.video} Join Class</button></div></div>`).join('')}</div>`
    :`<div class="card cp" style="text-align:center;padding:48px"><div style="font-size:48px;margin-bottom:16px">📚</div><h3 style="font-family:var(--font-display);font-weight:700;color:var(--g700);margin-bottom:8px">No Classes Yet</h3><p style="color:var(--g400);font-size:14px;font-weight:500">Classes will appear here once admin assigns you to subjects.</p></div>`;

  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">My Classes</h2><p class="psub">${myClasses.length} enrolled class${myClasses.length!==1?'es':''}</p></div>
      <div style="display:flex;gap:8px;align-items:center">
        ${myClasses.length?`<div class="cal-view-toggle"><button class="cal-view-btn${!isCalView?' active':''}" onclick="window._calView='list';renderSClasses()">≡ List</button><button class="cal-view-btn${isCalView?' active':''}" onclick="window._calView='cal';renderSClasses()">📅 Week</button></div>`:''}
        <button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderSClasses)">${IC.refresh} Refresh</button>
      </div>
    </div>
    ${myClasses.length?`<div class="card cp" style="margin-bottom:18px;background:linear-gradient(135deg,var(--navy),var(--navy-m));color:#fff;border:none"><div style="display:flex;align-items:center;gap:12px"><div style="font-size:28px">📅</div><div><div style="font-weight:700;font-size:15px">Today is ${today}</div><div style="font-size:13px;opacity:.55;margin-top:2px">${(myClasses.filter(c=>c.day===today)).length} class${(myClasses.filter(c=>c.day===today)).length!==1?'es':''} scheduled today</div></div></div></div>`:''}
    ${isCalView?calHtml():listHtml()}
  </div>`);
}

function cbtButtonHtml(a){
  if(a.type!=='CBT') return '';
  if(!a.cbtLink) return '<div style="margin-top:14px;padding:12px 16px;background:var(--blue-bg);border-radius:var(--r);text-align:center;font-size:13px;color:var(--blue-t);font-weight:700">🖥️ CBT Test — Link coming soon</div>';
  const now=new Date();
  const hasStart=a.cbtStart&&a.cbtStart!=='';
  const hasEnd=a.cbtEnd&&a.cbtEnd!=='';
  const afterStart=!hasStart||(now>=new Date(a.cbtStart));
  const beforeEnd=!hasEnd||(now<=new Date(a.cbtEnd));
  const available=afterStart&&beforeEnd;
  if(!available){
    let msg='🕐 CBT Test — ';
    if(hasStart&&!afterStart){
      const d=new Date(a.cbtStart);
      msg+='Opens '+d.toLocaleDateString()+' at '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    } else if(hasEnd&&!beforeEnd){
      msg+='Closed on '+new Date(a.cbtEnd).toLocaleDateString();
    } else { msg+='Not available right now'; }
    return '<div style="margin-top:14px;padding:12px 16px;background:var(--amber-bg);border-radius:var(--r);text-align:center;font-size:13px;color:var(--amber-t);font-weight:700">'+msg+'</div>';
  }
  let timeNote='';
  if(hasEnd){ const d=new Date(a.cbtEnd); timeNote='<p style="font-size:11px;color:var(--blue-t);opacity:.7;margin-top:4px;text-align:center">Closes '+d.toLocaleDateString()+' at '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+'</p>'; }
  return '<div style="margin-top:14px"><a href="'+a.cbtLink+'" target="_blank" rel="noopener noreferrer" style="display:flex;align-items:center;justify-content:center;gap:10px;min-height:48px;background:linear-gradient(135deg,#2563EB,#1E3A8A);color:#fff;border-radius:var(--r);font-size:14px;font-weight:700;font-family:var(--font-body);text-decoration:none;cursor:pointer">🖥️ Start CBT Test</a>'+timeNote+'</div>';
}

function renderSAssignments(){ if(!requireStudent()) return;
  const u=S.user;
  const myAssigns=S.assignments.filter(a=>safeArr(a.assignedTo).length===0||safeArr(a.assignedTo).includes(u.id));
  const subjects=['all',...new Set(myAssigns.map(a=>a.subject).filter(Boolean))];
  const filt=window._saFilter||'all';
  const shown=filt==='all'?myAssigns:myAssigns.filter(a=>a.subject===filt);

  const tabsHtml=subjects.length>1
    ?'<div id="sa-filter-wrap">'+subjects.map(s=>'<button class="sa-tab'+(((window._saFilter||'all')===s)?' active':'')+'" onclick="window._saFilter=\''+s+'\';renderSAssignments()">'+( s==='all'?'All Subjects':s)+'</button>').join('')+'</div>'
    :'';

  const cardsHtml=shown.map(function(a){
    const nc=getNotes(a.id).length;
    const noteItems=getNotes(a.id).map(function(n){
      return '<div style="display:flex;flex-direction:column;margin-bottom:4px"><div class="note-bubble student">'+sanitize(n.text)+'<div class="note-bubble-meta">'+new Date(n.ts).toLocaleString()+'</div></div></div>';
    }).join('');
    const gradeBlock=a.status==='Graded'
      ?'<div style="margin-top:12px;padding:12px 16px;background:var(--green-bg);border-radius:var(--r);border-left:3px solid var(--green)"><p style="font-size:13px;font-weight:800;color:var(--green-t);margin-bottom:4px">Grade: '+a.grade+'/100</p><p style="font-size:13px;color:var(--green-t);opacity:.85;font-weight:400">'+(a.feedback||'')+'</p></div>'
      :'';
    const submitBtn=a.status==='Pending'
      ?'<button class="btn btn-gold btn-sm" style="margin-top:12px" onclick="submitAssignmentStudent(\''+a.id+'\')">'+IC.send+' Mark as Submitted</button>'
      :'';
    const iconBg=a.status==='Graded'?'var(--green-bg)':a.status==='Submitted'?'var(--blue-bg)':'var(--amber-bg)';
    return '<div class="card cp fu" data-aid="'+a.id+'">'
      +'<div style="display:flex;gap:14px;align-items:flex-start">'
      +'<div style="width:48px;height:48px;border-radius:12px;background:'+iconBg+';display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:22px">📝</div>'
      +'<div style="flex:1;min-width:0">'
      +'<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap">'
      +'<div><h4 style="font-size:15px;font-weight:700;color:var(--g900);margin-bottom:3px">'+sanitize(a.title)+'</h4>'
      +'<p style="font-size:13px;color:var(--g400);font-weight:500">'+sanitize(a.subject)+' · Due '+(a.dueDate||'TBD')+'</p></div>'
      +bdg(a.status||'Pending')
      +(a.type==='CBT'?'<span class="badge b-blue" style="font-size:10px">🖥️ CBT</span>':'')
      +'</div>'
      +'<p style="font-size:13.5px;color:var(--g500);margin-top:10px;line-height:1.65;font-weight:400">'+(a.instructions||'')+'</p>'
      +gradeBlock
      +cbtButtonHtml(a)
      +submitBtn
      +'<div class="notes-thread">'
      +'<div class="notes-thread-hdr" onclick="toggleNotes(\''+a.id+'\')">'
      +'<h5>💬 Notes <span id="nc-'+a.id+'" style="background:var(--g100);border-radius:99px;padding:1px 8px;font-size:11px;color:var(--g500)">'+nc+'</span></h5>'
      +'<svg id="nc-arr-'+a.id+'" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--g400)" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>'
      +'</div>'
      +'<div id="notes-body-'+a.id+'" style="display:none;flex-direction:column">'
      +'<div class="notes-list">'+noteItems+'</div>'
      +'<div class="note-input-row"><textarea id="ni-'+a.id+'" placeholder="Add a note…" rows="1" onkeydown="if(event.key===\'Enter\'&&!event.shiftKey){event.preventDefault();addNote(\''+a.id+'\')}"></textarea>'
      +'<button onclick="addNote(\''+a.id+'\')">Add</button></div>'
      +'</div></div>'
      +'</div></div></div>';
  }).join('');

  const emptyHtml='<div class="card cp" style="text-align:center;padding:48px">'
    +'<div style="font-size:48px;margin-bottom:16px">✅</div>'
    +'<h3 style="font-family:var(--font-display);font-weight:700;color:var(--g700);margin-bottom:8px">No Assignments'+(filt!=='all'?' for '+filt:' Yet')+'</h3>'
    +'<p style="color:var(--g400);font-size:14px;font-weight:500">'+(filt!=='all'?'Try switching the subject filter.':'Your assignments will appear here once posted by your tutor.')+'</p></div>';

  html('portal-pages','<div class="pg on fi">'
    +'<div class="phdr"><div><h2 class="ptitle">Assignments</h2><p class="psub">Track and submit your work</p></div>'
    +'<button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderSAssignments)">'+IC.refresh+'</button></div>'
    +tabsHtml
    +(shown.length?'<div style="display:flex;flex-direction:column;gap:14px">'+cardsHtml+'</div>':emptyHtml)
    +'</div>');
  setTimeout(startCBTCountdowns, 50);
}

async function submitAssignmentStudent(aid){
  if(!confirm('Mark this assignment as submitted?')) return;
  await API.post('submitAssignment',{assignmentId:aid,studentId:S.user.id,submittedAt:new Date().toISOString()});
  toast('Assignment marked as submitted! ✅','s');
  S.assignments=await API.getAssignments();
  renderSAssignments();
}

function renderSProgress(){ if(!requireStudent()) return;
  const u=S.user;
  const mySubjects=safeArr(u.subjects);
  const subColors={'Algebra':'#F2BC3B','Calculus':'#60A5FA','Statistics':'#34D399','Geometry':'#F472B6','Further Mathematics':'#A78BFA','Core Maths Revision':'#FB923C','Physics':'#22D3EE','JavaScript':'#FDE68A','Python':'#86EFAC','External Examinations':'#FDA4AF'};
  const circumference=2*Math.PI*58;
  const score=+(u.avgScore||0);
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">Progress Tracker</h2><p class="psub">Your academic journey at a glance</p></div>
      <div style="display:flex;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="printProgress()" title="Print / Export PDF">🖨️ Print</button>
      <button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(()=>{const f=S.students.find(x=>x.id===S.user.id);if(f)S.user=f;renderSProgress();})">${IC.refresh} Refresh</button></div>
    </div>
    <div class="card cp" style="margin-bottom:20px">
      <h3 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900);margin-bottom:16px">📋 My Activity Log</h3>
      ${(()=>{
        const allAssigns=S.assignments.filter(a=>safeArr(a.assignedTo).length===0||safeArr(a.assignedTo).includes(u.id));
        if(!allAssigns.length) return '<p style="color:var(--g400);font-size:13.5px;font-weight:500;padding:8px 0">No activity yet — your assignment history will appear here.</p>';
        return allAssigns.slice().reverse().map(a=>{
          const statusColor=a.status==='Graded'?'var(--green)':a.status==='Submitted'?'var(--blue)':'var(--amber)';
          const statusBg=a.status==='Graded'?'var(--green-bg)':a.status==='Submitted'?'var(--blue-bg)':'var(--amber-bg)';
          const icon=a.status==='Graded'?'✅':a.status==='Submitted'?'📤':'📝';
          const typeTag=a.type==='CBT'?'<span class="badge b-blue" style="font-size:10px;margin-left:6px">🖥️ CBT</span>':'';
          const gradeTag=a.status==='Graded'?`<span style="font-family:var(--font-mono);font-size:13px;font-weight:800;color:${(+a.grade||0)>=80?'var(--green)':(+a.grade||0)>=60?'var(--gold)':'var(--red)'}">${a.grade}/100</span>`:'';
          return `<div style="display:flex;gap:12px;align-items:flex-start;padding:12px 0;border-bottom:1px solid var(--g100)">
            <div style="width:36px;height:36px;border-radius:10px;background:${statusBg};display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px">${icon}</div>
            <div style="flex:1;min-width:0">
              <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:4px">
                <span style="font-size:13.5px;font-weight:700;color:var(--g900)">${a.title}${typeTag}</span>
                ${gradeTag}
              </div>
              <div style="display:flex;align-items:center;gap:10px;margin-top:4px;flex-wrap:wrap">
                <span style="font-size:12px;color:var(--g400);font-weight:500">${a.subject}</span>
                <span style="font-size:12px;color:var(--g400)">·</span>
                <span style="font-size:12px;color:var(--g400);font-weight:500">Due: ${a.dueDate||'TBD'}</span>
                <span style="font-size:11px;font-weight:800;color:${statusColor};background:${statusBg};padding:2px 8px;border-radius:99px">${a.status}</span>
              </div>
              ${a.status==='Graded'&&a.feedback?`<p style="font-size:12px;color:var(--g500);margin-top:5px;font-style:italic;line-height:1.5">"${a.feedback}"</p>`:''}
            </div>
          </div>`;
        }).join('');
      })()}
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
      ${mySubjects.length?mySubjects.map(sub=>{
        const c=subColors[sub]||'var(--gold)';
        const subAssigns=S.assignments.filter(a=>a.subject===sub&&a.status==='Graded');
        const avg=subAssigns.length?Math.round(subAssigns.reduce((s,a)=>s+(+a.grade||0),0)/subAssigns.length):(score||0);
        return `<div class="card cp"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><h4 style="font-weight:800;color:var(--g900);font-size:14px">${sub}</h4><span style="font-family:var(--font-display);font-weight:800;font-size:22px;color:${c}">${avg}%</span></div><div class="pt"><div class="pf" style="width:${avg}%;background:linear-gradient(90deg,${c}aa,${c})"></div></div><p style="font-size:12px;color:var(--g400);margin-top:8px;font-weight:500">${subAssigns.length} graded</p></div>`;}).join(''):'<div class="card cp" style="grid-column:1/-1;text-align:center;padding:32px"><p style="color:var(--g400);font-weight:500">No subject data yet — check back after your first graded assignment.</p></div>'}
    </div>
  </div>`);

}

function renderSProfile(){ if(!requireStudent()) return;
  const u=S.user;
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">My Profile</h2></div>
      <button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(()=>{const f=S.students.find(x=>x.id===S.user.id);if(f)S.user=f;renderSProfile();})">${IC.refresh}</button>
    </div>
    <div class="gsdet">
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card cp" style="text-align:center">
          ${av(`${u.firstName} ${u.lastName}`,80).replace('class="av"','class="av" style="margin:0 auto 16px"')}
          <h3 style="font-family:var(--font-display);font-weight:700;font-size:22px;color:var(--g900)">${u.firstName} ${u.lastName}</h3>
          <p style="font-size:13px;color:var(--g400);margin-bottom:8px;font-family:var(--font-mono)">${u.id}</p>
          <span class="chip chip-gold" style="font-size:11px">${u.level}</span>
          <div class="div"></div>
          <div style="display:flex;justify-content:space-around">
            <div style="text-align:center"><div style="font-family:var(--font-display);font-size:26px;font-weight:800;color:var(--green)">${u.avgScore||0}%</div><div style="font-size:11px;color:var(--g400);margin-top:2px;font-weight:600">Avg Score</div></div>
            <div style="text-align:center"><div style="font-family:var(--font-display);font-size:26px;font-weight:800;color:var(--blue)">${u.attendance||0}%</div><div style="font-size:11px;color:var(--g400);margin-top:2px;font-weight:600">Attendance</div></div>
          </div>
          <div class="div"></div>
          <div style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center">${safeArr(u.subjects).map(s=>`<span class="badge b-blue">${s}</span>`).join('')||'<span style="color:var(--g400);font-size:13px;font-weight:500">No subjects assigned</span>'}</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card cp">
          <h4 style="font-family:var(--font-display);font-weight:700;color:var(--g900);margin-bottom:16px;font-size:18px">Personal Details</h4>
          ${infoRow(IC.mail,'Email',u.email)}
          ${infoRow(IC.phone,'Phone',u.phone)}
          ${infoRow(IC.user,'Guardian',u.guardian)}
          ${infoRow(IC.phone,'Guardian Contact',u.guardianContact)}
          ${infoRow(IC.cal,'Date of Birth',u.dob||'—')}
        </div>
        <div class="card cp">
          <h4 style="font-family:var(--font-display);font-weight:700;color:var(--g900);margin-bottom:16px;font-size:18px">Change Password</h4>
          <div class="fg"><label class="fl">Current Password</label><input class="fi-el" type="password" id="pw-cur" placeholder="••••••••"></div>
          <div class="frow"><div class="fg"><label class="fl">New Password</label><input class="fi-el" type="password" id="pw-new" placeholder="Min 6 characters"></div><div class="fg"><label class="fl">Confirm New</label><input class="fi-el" type="password" id="pw-con" placeholder="Repeat password"></div></div>
          <button class="btn btn-gold" onclick="changeStudentPassword()">Update Password</button>
        </div>
        <div class="card cp" id="badges-section">
          <h4 style="font-family:var(--font-display);font-weight:700;color:var(--g900);margin-bottom:4px;font-size:18px">🏅 Achievement Badges</h4>
          <p style="font-size:12.5px;color:var(--g500);margin-bottom:14px">Earned from your performance and activity</p>
          <div class="badge-grid">${computeBadges(u).map(b=>b.earned?'<div class="achv-badge '+b.color+'" title="'+b.desc+'"><span class="achv-badge-icon">'+b.icon+'</span><div><div class="achv-badge-name">'+b.name+'</div><div class="achv-badge-desc">'+b.desc+'</div></div></div>':'<div class="achv-badge navy achv-lock" title="Not yet earned: '+b.hint+'"><span class="achv-badge-icon">🔒</span><div><div class="achv-badge-name">'+b.name+'</div><div class="achv-badge-desc">'+b.hint+'</div></div></div>').join('')}</div>
        </div>
      </div>
    </div>
  </div>`);
}

async function changeStudentPassword(){
  const cur=$id('pw-cur')?.value, nw=$id('pw-new')?.value, con=$id('pw-con')?.value;
  if(!cur||!nw||!con){ toast('Please fill in all fields','e'); return; }
  if(nw!==con){ toast('New passwords do not match','e'); return; }
  if(nw.length<6){ toast('Password must be at least 6 characters','e'); return; }
  await API.updatePassword({studentId:S.user.id,currentPassword:cur,newPassword:nw});
  toast('Password updated successfully! ✅','s');
  ['pw-cur','pw-new','pw-con'].forEach(id=>{ const el=$id(id); if(el) el.value=''; });
}

function renderNotices(){
  const isAdmin=S.role==='admin';
  const notices=isAdmin?S.notices:S.notices.filter(n=>n.target==='all'||safeArr(S.user?.subjects).includes(n.target));
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">${isAdmin?'Announcements':'Notices'}</h2><p class="psub">${notices.length} notice${notices.length!==1?'s':''}</p></div>
      ${isAdmin?`<div style="display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderNotices)">${IC.refresh}</button><button class="btn btn-gold" onclick="openAddNoticeModal()">${IC.send} Post Notice</button></div>`:''}
    </div>
    ${notices.length?`<div style="display:flex;flex-direction:column;gap:14px">${notices.map((n,i)=>`<div class="card fu" style="border-left:4px solid var(--gold)"><div class="cp"><div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex-wrap:wrap;margin-bottom:10px"><div style="display:flex;gap:12px;align-items:flex-start"><div style="width:40px;height:40px;border-radius:11px;background:rgba(212,160,23,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px">🔔</div><div><h3 style="font-weight:800;font-size:15px;color:var(--g900)">${n.title}</h3><p style="font-size:12px;color:var(--g400);margin-top:2px;font-weight:500">Posted ${n.date||''} · <strong>${n.target==='all'?'All Students':n.target}</strong></p></div></div><div style="display:flex;gap:8px;align-items:center"><span class="badge ${n.target==='all'?'b-navy':'b-blue'}">${n.target==='all'?'All':n.target}</span>${isAdmin?`<button class="btn btn-ghost btn-ico btn-xs" style="color:var(--red)" onclick="deleteNotice('${n.id||i}')">${IC.trash}</button>`:''}</div></div><p style="font-size:14px;color:var(--g500);line-height:1.72;font-weight:400">${n.body}</p></div></div>`).join('')}</div>`:
    `<div class="card cp" style="text-align:center;padding:48px"><div style="font-size:48px;margin-bottom:16px">📢</div><h3 style="font-family:var(--font-display);font-weight:700;color:var(--g700);margin-bottom:8px">No Notices Yet</h3><p style="color:var(--g400);font-size:14px;font-weight:500">Announcements from your tutors will appear here.</p></div>`}
  </div>`);
}

async function deleteNotice(id){
  if(!confirm('Delete this notice?')) return;
  await API.deleteNotice(id);
  S.notices=await API.getNotices();
  renderNotices();
  toast('Notice deleted','s');
}

// ════════════════════════════════════════════════════════════════
//  ADMIN PAGES
// ════════════════════════════════════════════════════════════════
function renderADash(){ if(!requireAdmin()) return;
  const pend=S.apps.filter(a=>a.status==='pending').length;
  const activeS=S.students.filter(s=>s.isActive===true||s.isActive==='true'||s.isActive===1).length;
  const avgScore=S.students.length?Math.round(S.students.reduce((s,st)=>s+(+st.avgScore||0),0)/S.students.length):0;
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h1 class="ptitle">Admin Dashboard</h1><p class="psub">D-Maths Tuition Centre — Control Panel</p></div>
      <button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderADash)">${IC.refresh} Sync Now</button>
    </div>
    ${pend?`<div style="background:var(--amber-bg);border:1px solid rgba(217,119,6,.28);border-radius:var(--r-l);padding:14px 20px;margin-bottom:22px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">${IC.warn}<p style="flex:1;font-size:14px;color:var(--amber-t);font-weight:700">You have <strong>${pend} pending application${pend>1?'s':''}</strong> awaiting payment verification.</p><button class="btn btn-gold btn-sm" onclick="navTo('applications')">Review Now</button></div>`:''}
    <div class="g4" style="margin-bottom:24px">
      ${statCard('👥','Total Students',S.students.length,null,'var(--blue)')}
      ${statCard('📋','Pending Apps',pend,null,'var(--amber)')}
      ${statCard('🎬','Active Classes',S.classes.length,null,'var(--gold)')}
      ${statCard('📈','Class Average',avgScore+'%',null,'var(--green)')}
    </div>
    <div style="margin-bottom:22px">
      <div class="card cp">
        <h3 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900);margin-bottom:16px">Quick Actions</h3>
        <div style="display:flex;flex-direction:column;gap:8px">
          ${[['Review Applications','📋','applications',pend],['Manage Students','👥','students',0],['Manage Classes','🎬','classes',0],['Post Announcement','🔔','notices',0],['View Reports','📊','reports',0]].map(([l,e,pg,badge])=>`<button class="btn btn-ghost" style="justify-content:flex-start;padding:10px 14px;min-height:44px;text-align:left" onclick="navTo('${pg}')"><span style="font-size:18px">${e}</span><span style="flex:1;text-align:left;font-size:13.5px;color:var(--g700);font-weight:600">${l}</span>${badge?`<span class="nbadge">${badge}</span>`:''}</button>`).join('')}
        </div>
      </div>
    </div>
    <div class="card">
      <div style="padding:14px 20px 10px;border-bottom:1px solid var(--g100);display:flex;justify-content:space-between;align-items:center">
        <h3 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900)">Recent Students</h3>
        <button class="btn btn-ghost btn-xs" onclick="navTo('students')">View All</button>
      </div>
      <div class="tw"><table><thead><tr><th>Student</th><th>Level</th><th>Avg Score</th><th>Attendance</th><th>Status</th></tr></thead>
        <tbody>${S.students.slice(0,7).map(s=>`<tr onclick="S.selStudent='${s.id}';navTo('students')" style="cursor:pointer"><td><div style="display:flex;gap:10px;align-items:center">${av(`${s.firstName} ${s.lastName}`,34)}<div><span style="font-weight:800;font-size:13.5px">${s.firstName} ${s.lastName}</span><br><span style="font-size:11px;color:var(--g400);font-family:var(--font-mono)">${s.id}</span></div></div></td><td style="color:var(--g500);font-size:13px;font-weight:500">${s.level}</td><td><span style="font-weight:800;color:${(+s.avgScore||0)>=80?'var(--green)':(+s.avgScore||0)>=70?'var(--gold)':'var(--red)'}">${s.avgScore||0}%</span></td><td style="color:var(--g500);font-size:13px;font-weight:500">${s.attendance||0}%</td><td>${bdg((s.isActive===true||s.isActive==='true'||s.isActive===1)?'Active':'Inactive')}</td></tr>`).join('')}${!S.students.length?`<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--g400)">No students yet</td></tr>`:''}</tbody>
      </table></div>
    </div>
  </div>`);

}

function renderAApps(){ if(!requireAdmin()) return;
  const filtered=S.appFilter==='all'?S.apps:S.apps.filter(a=>a.status===S.appFilter);
  const counts={pending:S.apps.filter(a=>a.status==='pending').length,approved:S.apps.filter(a=>a.status==='approved').length,rejected:S.apps.filter(a=>a.status==='rejected').length};
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">Enrolment Applications</h2><p class="psub">${counts.pending} pending · ${counts.approved} approved · ${counts.rejected} rejected</p></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">${['all','pending','approved','rejected'].map(f=>`<button class="btn btn-sm ${S.appFilter===f?'btn-navy':'btn-ghost'}" onclick="S.appFilter='${f}';renderAApps()" style="text-transform:capitalize">${f==='all'?`All (${S.apps.length})`:f+` (${counts[f]||0})`}</button>`).join('')}</div>
    </div>
    ${filtered.length?filtered.map((req,i)=>`<div class="rcard ${req.status}"><div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px"><div style="display:flex;gap:14px;align-items:flex-start">${av(`${req.firstName} ${req.lastName}`,50)}<div><h3 style="font-weight:800;font-size:16px;color:var(--g900)">${req.firstName} ${req.lastName}</h3><p style="font-size:13px;color:var(--g400);margin-bottom:6px;font-weight:500">${req.email} · ${req.phone}</p><div style="display:flex;gap:5px;flex-wrap:wrap"><span class="chip" style="font-size:11px">${req.level}</span>${safeArr(req.subjects).map(s=>`<span class="badge b-blue" style="font-size:10px">${s}</span>`).join('')}</div></div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">${bdg(req.status)}<button class="btn btn-ghost btn-sm" onclick="openAppModal(${i})">${IC.eye} Details</button></div></div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid var(--g100)">${[[IC.card,'Ref',req.paymentRef],[IC.card,'Amount',` Naira ${req.paymentAmt}`],[IC.cal,'Pay Date',req.paymentDate],[IC.clock,'Applied',req.applied]].map(([icon,l,v])=>`<div style="display:flex;gap:8px;align-items:center;font-size:13px"><span style="color:var(--g300)">${icon}</span><span style="color:var(--g400);font-weight:500">${l}:</span><strong style="color:var(--g700)">${v||'—'}</strong></div>`).join('')}</div>
    ${req.status==='pending'?`<div style="display:flex;gap:10px;margin-top:14px;padding-top:14px;border-top:1px solid var(--g100)"><button class="btn btn-ok btn-sm" style="flex:1" onclick="approveApp('${req.id}')">${IC.chk} Approve & Create Account</button><button class="btn btn-err btn-sm" style="flex:1" onclick="rejectApp('${req.id}')">${IC.x} Reject Application</button></div>`:''}</div>`).join(''):`<div class="card cp" style="text-align:center;padding:48px"><div style="font-size:48px;margin-bottom:16px">📋</div><h3 style="font-family:var(--font-display);font-weight:700;color:var(--g700);margin-bottom:8px">No ${S.appFilter==='all'?'':S.appFilter+' '}applications</h3><p style="color:var(--g400);font-size:14px">Applications submitted via the enrolment form appear here.</p></div>`}
  </div>`);
}

function openAppModal(idx){
  const req=S.apps[idx]; if(!req) return;
  openModal(`Application — ${req.firstName} ${req.lastName}`,`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px">
      ${infoRow(IC.user,'Full Name',`${req.firstName} ${req.lastName}`)}
      ${infoRow(IC.mail,'Email',req.email)}
      ${infoRow(IC.phone,'Phone',req.phone)}
      ${infoRow('🎓','Level',req.level)}
      ${infoRow(IC.card,'Payment Ref',req.paymentRef)}
      ${infoRow(IC.card,'Amount',` Naira ${req.paymentAmt}`)}
      ${infoRow(IC.cal,'Pay Date',req.paymentDate)}
      ${infoRow(IC.card,'Method',req.paymentMethod)}
      ${infoRow(IC.user,'Guardian',req.guardian||'—')}
    </div>
    <div style="margin-bottom:14px"><label class="fl">Subjects</label><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${safeArr(req.subjects).map(s=>`<span class="badge b-blue">${s}</span>`).join('')||'None'}</div></div>
    ${req.notes?`<div class="fg"><label class="fl">Notes</label><p style="font-size:14px;color:var(--g500)">${req.notes}</p></div>`:''}
    ${req.status==='pending'?`<div style="display:flex;gap:10px;padding-top:8px"><button class="btn btn-ok" style="flex:1" onclick="approveApp('${req.id}');closeModal()">${IC.chk} Approve & Send Credentials</button><button class="btn btn-err" onclick="rejectApp('${req.id}');closeModal()">${IC.x} Reject</button></div>`:req.status==='approved'?'<div class="al al-s">✅ Application has been <strong>approved</strong>. Credentials were emailed.</div>':'<div class="al al-e">❌ Application was <strong>rejected</strong>.</div>'}
  `,true);
}

async function approveApp(id){
  if(!confirm('Approve this application and email credentials to the student?')) return;
  const btns=document.querySelectorAll(`button[onclick*="${id}"]`);
  btns.forEach(b=>{b.disabled=true;});
  await API.approveApp(id);
  toast('Application approved! Student credentials emailed. ✅','s');
  S.apps=await API.getApps(); S.students=await API.getStudents();
  renderAApps();
}
async function rejectApp(id){
  if(!confirm('Reject this application? The student will be notified by email.')) return;
  await API.rejectApp(id);
  toast('Application rejected. Student notified.','s');
  S.apps=await API.getApps();
  renderAApps();
}

function renderAStudents(){ if(!requireAdmin()) return;
  if(S.selStudent){ renderStudentDetail(); return; }
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">Student Management</h2><p class="psub">${S.students.length} registered students</p></div>
      <div style="display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderAStudents)">${IC.refresh}</button><button class="btn btn-gold" onclick="openAddStudentModal()">${IC.plus} Add Student</button></div>
    </div>
    <div class="card"><div class="tw"><table><thead><tr><th>Student</th><th>ID</th><th>Level</th><th>Subjects</th><th>Score</th><th>Attend.</th><th>Status</th><th></th></tr></thead>
      <tbody>${S.students.length?S.students.map(s=>`<tr><td><div style="display:flex;gap:10px;align-items:center">${av(`${s.firstName} ${s.lastName}`,34)}<span style="font-weight:800;font-size:13.5px">${s.firstName} ${s.lastName}</span></div></td><td><code style="font-size:11px;background:var(--g50);border:1px solid var(--g100);padding:2px 7px;border-radius:6px;font-family:var(--font-mono)">${s.id}</code></td><td style="color:var(--g500);font-size:13px;font-weight:500">${s.level}</td><td><div style="display:flex;gap:4px;flex-wrap:wrap">${safeArr(s.subjects).slice(0,2).map(sub=>`<span class="badge b-blue" style="font-size:10px">${sub}</span>`).join('')}${safeArr(s.subjects).length>2?`<span class="badge b-gray" style="font-size:10px">+${safeArr(s.subjects).length-2}</span>`:''}</div></td><td><span style="font-weight:800;color:${(+s.avgScore||0)>=80?'var(--green)':(+s.avgScore||0)>=70?'var(--gold)':'var(--red)'}">${s.avgScore||0}%</span></td><td style="color:var(--g500);font-size:13px;font-weight:500">${s.attendance||0}%</td><td>${bdg((s.isActive===true||s.isActive==='true'||s.isActive===1)?'Active':'Inactive')}</td><td><div style="display:flex;gap:5px"><button class="btn btn-ghost btn-ico" title="View" onclick="S.selStudent='${s.id}';renderAStudents()">${IC.eye}</button><button class="btn btn-ghost btn-ico" title="Edit" onclick="openEditStudentModal('${s.id}')">${IC.edit}</button><button class="btn btn-err btn-ico" title="Delete" onclick="deleteStudent('${s.id}','${s.firstName} ${s.lastName}')">${IC.trash}</button></div></td></tr>`).join(''):`<tr><td colspan="8" style="text-align:center;padding:48px;color:var(--g400)">No students yet. Students appear once applications are approved.</td></tr>`}
      </tbody>
    </table></div></div>
  </div>`);
}

async function renderStudentDetail(){
  const s=S.students.find(x=>x.id===S.selStudent); if(!s){ S.selStudent=null; renderAStudents(); return; }
  const notes=await API.getNotes(s.id);
  html('portal-pages',`<div class="pg on fi">
    <button class="btn btn-ghost btn-sm" style="margin-bottom:20px" onclick="S.selStudent=null;renderAStudents()">${IC.al} Back to Students</button>
    <div class="gsdet">
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card cp" style="text-align:center">
          ${av(`${s.firstName} ${s.lastName}`,72).replace('class="av"','class="av" style="margin:0 auto 16px"')}
          <h2 style="font-family:var(--font-display);font-weight:700;font-size:22px;color:var(--g900)">${s.firstName} ${s.lastName}</h2>
          <p style="font-size:13px;color:var(--g400);margin-bottom:4px;font-family:var(--font-mono)">${s.id}</p>
          <span class="chip chip-gold" style="font-size:11px;margin-bottom:8px">${s.level}</span>
          <div style="margin:8px 0">${bdg((s.isActive===true||s.isActive==='true'||s.isActive===1)?'Active':'Inactive')}</div>
          <div style="display:flex;justify-content:space-around;padding:14px 0;border-top:1px solid var(--g100);margin-top:8px;margin-bottom:8px">
            <div><div style="font-family:var(--font-display);font-size:22px;font-weight:800;color:var(--g900)">${s.avgScore||0}%</div><div style="font-size:11px;color:var(--g400);font-weight:600">Avg Score</div></div>
            <div><div style="font-family:var(--font-display);font-size:22px;font-weight:800;color:var(--g900)">${s.attendance||0}%</div><div style="font-size:11px;color:var(--g400);font-weight:600">Attendance</div></div>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-bottom:14px">${safeArr(s.subjects).map(sub=>`<span class="badge b-blue">${sub}</span>`).join('')||'<span style="color:var(--g400);font-size:13px">No subjects</span>'}</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" style="flex:1" onclick="resetStudentPassword('${s.id}','${s.email}')">${IC.lock} Reset PW</button>
            <button class="btn btn-sm ${(s.isActive===true||s.isActive==='true'||s.isActive===1)?'btn-err':'btn-ok'}" style="flex:1" onclick="toggleStudentStatus('${s.id}')">${(s.isActive===true||s.isActive==='true'||s.isActive===1)?'Deactivate':'Activate'}</button>
          </div>
          <button class="btn btn-err btn-sm btn-w" style="margin-top:8px" onclick="deleteStudent('${s.id}','${s.firstName} ${s.lastName}')">${IC.trash} Delete Student</button>
        </div>
        <div class="card cp">
          ${infoRow(IC.mail,'Email',s.email)}
          ${infoRow(IC.phone,'Phone',s.phone)}
          ${infoRow(IC.user,'Guardian',s.guardian)}
          ${infoRow(IC.phone,'Contact',s.guardianContact)}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card cp"><h4 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900);margin-bottom:18px">Score Growth</h4><canvas id="chart-stu" height="200"></canvas></div>
        <div class="card cp">
          <h4 style="font-family:var(--font-display);font-weight:700;font-size:17px;color:var(--g900);margin-bottom:14px">Update Performance</h4>
          <div class="frow">
            <div class="fg"><label class="fl">Avg Score (%)</label><input class="fi-el" id="upd-score" type="number" min="0" max="100" value="${s.avgScore||0}"></div>
            <div class="fg"><label class="fl">Attendance (%)</label><input class="fi-el" id="upd-attend" type="number" min="0" max="100" value="${s.attendance||0}"></div>
          </div>
          <button class="btn btn-gold btn-sm" onclick="updateStudentPerformance('${s.id}')">Save & Notify Student</button>
        </div>
        <div class="card cp">
          <h4 style="font-family:var(--font-display);font-weight:700;font-size:17px;color:var(--g900);margin-bottom:14px">Admin Notes</h4>
          <div id="notes-list">${notes.length?notes.map(n=>`<div style="background:var(--g50);border:1px solid var(--g100);border-radius:var(--r);padding:10px 14px;margin-bottom:9px"><p style="font-size:13px;color:var(--g700);line-height:1.55;font-weight:400">${typeof n==='string'?n:(n.note||'')}</p><p style="font-size:11px;color:var(--g400);margin-top:4px;font-weight:600">${n.date||''}</p></div>`).join(''):'<p style="color:var(--g400);font-size:13.5px;margin-bottom:12px;font-weight:500">No notes yet.</p>'}</div>
          <textarea class="fi-el" id="note-ta" placeholder="Add a note about this student..." rows="3" style="margin-top:4px;margin-bottom:10px"></textarea>
          <button class="btn btn-gold btn-sm" onclick="addNote('${s.id}')">Add Note</button>
        </div>
      </div>
    </div>
  </div>`);
  setTimeout(()=>makeStudentChart('chart-stu'),50);
}

async function updateStudentPerformance(sid){
  const score=$id('upd-score')?.value, attend=$id('upd-attend')?.value;
  if(score===undefined||attend===undefined){ toast('Values not found','e'); return; }
  await API.updateStudent({id:sid,avgScore:+score,attendance:+attend});
  toast('Performance updated! Student portal refreshed automatically. ✅','s');
  S.students=await API.getStudents();
  const s=S.students.find(x=>x.id===sid); if(s){ s.avgScore=+score; s.attendance=+attend; }
}

async function resetStudentPassword(sid,email){
  if(!confirm(`Send a password reset link to ${email}?`)) return;
  await API.resetPassword({studentId:sid,email});
  toast('Password reset email sent to '+email+' ✅','s');
}

async function deleteStudent(sid, name){
  if(!confirm('⚠️ DELETE student "'+name+'"?\n\nThis permanently removes all their data. This cannot be undone.')) return;
  await API.post('deleteStudent',{id:sid});
  toast('Student "'+name+'" has been deleted.','s');
  S.students=await API.getStudents();
  S.selStudent=null;
  renderAStudents();
}
async function toggleStudentStatus(sid){
  const s=S.students.find(x=>x.id===sid); if(!s) return;
  const cur=s.isActive===true||s.isActive==='true'||s.isActive===1;
  await API.updateStudent({id:sid,isActive:!cur});
  toast(!cur?'Student activated ✅':'Student deactivated','s');
  S.students=await API.getStudents();
  renderStudentDetail();
}

async function addNote(sid){
  const ta=$id('note-ta'); if(!ta||!ta.value.trim()) return;
  const note=ta.value.trim();
  await API.saveNote(sid,note);
  toast('Note saved ✅','s');
  const list=$id('notes-list');
  if(list){
    const el=document.createElement('div');
    el.style.cssText='background:var(--g50);border:1px solid var(--g100);border-radius:var(--r);padding:10px 14px;margin-bottom:9px';
    el.innerHTML=`<p style="font-size:13px;color:var(--g700);line-height:1.55;font-weight:400">${note}</p><p style="font-size:11px;color:var(--g400);margin-top:4px;font-weight:600">Just now</p>`;
    list.insertBefore(el,list.firstChild);
  }
  ta.value='';
}

function renderAClasses(){ if(!requireAdmin()) return;
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">Class Management</h2><p class="psub">${S.classes.length} active classes</p></div>
      <div style="display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderAClasses)">${IC.refresh}</button><button class="btn btn-gold" onclick="openAddClassModal()">${IC.plus} Create Class</button></div>
    </div>
    ${S.classes.length?`<div class="gcls">${S.classes.map(cls=>`<div class="card"><div style="height:3px;background:linear-gradient(90deg,var(--gold),var(--gold-b))"></div><div class="cp"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px"><div style="display:flex;gap:12px;align-items:flex-start"><div style="width:44px;height:44px;border-radius:12px;background:rgba(212,160,23,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:22px">📹</div><div><h3 style="font-family:var(--font-display);font-weight:700;font-size:17px;color:var(--g900);margin-bottom:3px">${cls.subject}</h3><p style="font-size:13px;color:var(--g400);font-weight:500">${cls.tutor}</p></div></div><div style="display:flex;gap:5px"><button class="btn btn-ghost btn-ico btn-xs" onclick="openEditClassModal('${cls.id}')">${IC.edit}</button></div></div>${infoRow(IC.cal,'Schedule',`${cls.day} at ${cls.time}`)}${infoRow(IC.clock,'Duration',cls.duration)}${infoRow(IC.video,'Platform',cls.platform||'Online')}<div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;margin-bottom:14px;padding-bottom:14px;border-bottom:1px solid var(--g100)">${S.students.filter(s=>safeArr(cls.students).includes(s.id)).map(s=>av(`${s.firstName} ${s.lastName}`,26)).join('')}<span style="font-size:12px;color:var(--g400);margin-left:4px;font-weight:600">${safeArr(cls.students).length} student${safeArr(cls.students).length!==1?'s':''}</span></div><div style="display:flex;gap:8px"><button class="btn btn-gold btn-sm" style="flex:1" onclick="markAttendanceModal('${cls.id}')">Mark Attendance</button><button class="btn btn-ghost btn-sm" onclick="openAssignStudentsModal('${cls.id}')">Assign Students</button></div></div></div>`).join('')}</div>`:
    `<div class="card cp" style="text-align:center;padding:48px"><div style="font-size:48px;margin-bottom:16px">🎬</div><h3 style="font-family:var(--font-display);font-weight:700;color:var(--g700)">No classes yet</h3><p style="color:var(--g400);font-size:14px;margin-top:8px">Create your first class to get started.</p></div>`}
  </div>`);
}

function renderAAssignments(){ if(!requireAdmin()) return;
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">Assignments</h2><p class="psub">Manage and grade student work</p></div>
      <div style="display:flex;gap:8px"><button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderAAssignments)">${IC.refresh}</button><button class="btn btn-gold" onclick="openAddAssignModal()">${IC.plus} New Assignment</button></div>
    </div>
    ${S.assignments.length?`<div class="card"><div class="tw"><table><thead><tr><th>Assignment</th><th>Subject</th><th>Due</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody>${S.assignments.map(a=>`<tr><td><p style="font-weight:800;font-size:14px;color:var(--g900)">${a.title}</p><p style="font-size:12px;color:var(--g400);margin-top:2px;font-weight:400">${(a.instructions||'').slice(0,55)}${(a.instructions||'').length>55?'...':''}</p></td><td><span class="chip" style="font-size:11px">${a.subject}</span></td><td style="font-size:13px;color:var(--g500);font-weight:500">${a.dueDate||'TBD'}</td><td>${bdg(a.status||'Pending')}</td><td><div style="display:flex;gap:6px">${a.status==='Submitted'?`<button class="btn btn-gold btn-xs" onclick="gradeModal('${a.id}')">${IC.edit} Grade</button>`:''}${a.status==='Graded'?`<button class="btn btn-ghost btn-xs" onclick="gradeModal('${a.id}')">${IC.edit} Update</button>`:''}<button class="btn btn-err btn-xs" onclick="deleteAssignment('${a.id}','${a.title}')">🗑 Delete</button></div></td></tr>`).join('')}
      </tbody></table></div></div>`:
    `<div class="card cp" style="text-align:center;padding:48px"><div style="font-size:48px;margin-bottom:16px">📝</div><h3 style="font-family:var(--font-display);font-weight:700;color:var(--g700)">No assignments yet</h3><p style="color:var(--g400);font-size:14px;margin-top:8px">Create your first assignment.</p></div>`}
  </div>`);
}

async function deleteAssignment(aid, title){
  if(!confirm('Delete assignment "'+title+'"?\n\nThis cannot be undone.')) return;
  await API.post('deleteAssignment',{assignmentId:aid});
  toast('Assignment deleted.','s');
  S.assignments=await API.getAssignments();
  renderAAssignments();
}
function gradeModal(aid){
  const a=S.assignments.find(x=>x.id===aid); if(!a) return;
  openModal(`Grade: ${a.title}`,`<div class="fg"><label class="fl">Grade (out of 100) <span class="freq">*</span></label><input class="fi-el" id="grade-score" type="number" min="0" max="100" placeholder="e.g. 85" value="${a.grade||''}"></div><div class="fg"><label class="fl">Feedback for Student</label><textarea class="fi-el" id="grade-fb" rows="4" placeholder="Specific feedback...">${a.feedback||''}</textarea></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="submitGrade('${aid}')">Submit Grade & Notify</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function submitGrade(aid){
  const a=S.assignments.find(x=>x.id===aid); if(!a) return;
  const score=$id('grade-score')?.value, fb=$id('grade-fb')?.value;
  if(!score){ toast('Please enter a grade','e'); return; }
  await API.gradeAssignment({assignmentId:aid,grade:+score,feedback:fb||''});
  a.grade=+score; a.feedback=fb||''; a.status='Graded';
  toast('Grade submitted — student notified by email! ✅','s');
  closeModal(); renderAAssignments();
}

// ════════════════════════════════════════════════════════════════
//  FEATURE 1 — DARK MODE
// ════════════════════════════════════════════════════════════════
function toggleDarkMode(){
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  const next=isDark?'light':'dark';
  document.documentElement.setAttribute('data-theme',next);
  try{localStorage.setItem('dm_theme',next);}catch(e){}
  const btn=document.getElementById('dm-toggle');
  if(btn) btn.textContent=next==='dark'?'☀️':'🌙';
}
function initDarkMode(){
  let theme='light';
  try{theme=localStorage.getItem('dm_theme')||'light';}catch(e){}
  document.documentElement.setAttribute('data-theme',theme);
  const btn=document.getElementById('dm-toggle');
  if(btn) btn.textContent=theme==='dark'?'☀️':'🌙';
}

// ════════════════════════════════════════════════════════════════
//  FEATURE 2 — NOTIFICATION BELL
// ════════════════════════════════════════════════════════════════
const _bellRead = new Set((() => {
  try{ return JSON.parse(localStorage.getItem('dm_bell_read')||'[]'); }catch(e){ return []; }
})());

function saveBellRead(){
  try{ localStorage.setItem('dm_bell_read', JSON.stringify([..._bellRead])); }catch(e){}
}

function openBell(){
  const wrap=document.getElementById('bell-wrap');
  const drop=document.getElementById('bell-drop');
  const list=document.getElementById('bell-drop-list');
  if(!wrap||!drop||!list) return;

  const notices=S.notices||[];
  const myNotices=S.role==='student'
    ? notices.filter(n=>n.target==='all'||safeArr(S.user?.subjects).includes(n.target))
    : notices;

  if(!myNotices.length){
    list.innerHTML='<div style="padding:28px;text-align:center;color:var(--g400);font-size:13.5px;font-weight:500">No notifications yet</div>';
  } else {
    list.innerHTML=myNotices.slice().reverse().map(n=>{
      const read=_bellRead.has(n.id);
      return `<div class="bell-item${read?'':' unread'}" onclick="markRead('${n.id}')">
        <div class="bell-item-title">${sanitize(n.title||'Notice')}</div>
        <div class="bell-item-msg">${sanitize(n.message||'')}</div>
        <div class="bell-item-date">${n.date||''}</div>
      </div>`;
    }).join('');
  }
  drop.classList.toggle('open');
}

function toggleBell(){
  const drop=document.getElementById('bell-drop');
  if(drop){
    if(drop.classList.contains('open')) drop.classList.remove('open');
    else openBell();
  }
}

function markRead(nid){
  _bellRead.add(nid); saveBellRead(); updateBellBadge();
  document.querySelectorAll('.bell-item.unread').forEach(el=>{
    if((el.getAttribute('onclick')||'').includes(nid)) el.classList.remove('unread');
  });
}

function markAllRead(){
  (S.notices||[]).forEach(n=>_bellRead.add(n.id));
  saveBellRead(); updateBellBadge();
  document.querySelectorAll('.bell-item.unread').forEach(el=>el.classList.remove('unread'));
}

function updateBellBadge(){
  const notices=S.notices||[];
  const myNotices=S.role==='student'
    ? notices.filter(n=>n.target==='all'||safeArr(S.user?.subjects).includes(n.target))
    : notices;
  const unread=myNotices.filter(n=>!_bellRead.has(n.id)).length;
  const badge=document.getElementById('bell-badge');
  const wrap=document.getElementById('bell-wrap');
  if(wrap) wrap.style.display='block';
  if(badge){ badge.textContent=unread>9?'9+':unread; badge.style.display=unread?'block':'none'; }
  // Also show dark mode & search buttons
  const dm=document.getElementById('dm-toggle');
  const sb=document.getElementById('search-btn');
  if(dm) dm.style.display='flex';
  if(sb) sb.style.display='flex';
}

// Close bell when clicking outside
document.addEventListener('click',function(e){
  const wrap=document.getElementById('bell-wrap');
  if(wrap&&!wrap.contains(e.target)){
    const drop=document.getElementById('bell-drop');
    if(drop) drop.classList.remove('open');
  }
});

// ════════════════════════════════════════════════════════════════
//  FEATURE 3 — GLOBAL SEARCH
// ════════════════════════════════════════════════════════════════
function openSearch(){
  const ov=document.getElementById('search-overlay');
  if(ov){ ov.classList.add('open'); setTimeout(()=>{const inp=document.getElementById('search-input');if(inp)inp.focus();},60); }
}
function closeSearch(){
  const ov=document.getElementById('search-overlay');
  if(ov){ ov.classList.remove('open'); }
}
document.addEventListener('keydown',function(e){
  if((e.key==='k'&&(e.ctrlKey||e.metaKey))||(e.key==='/'&&document.activeElement===document.body)){
    e.preventDefault(); openSearch();
  }
  if(e.key==='Escape') closeSearch();
});

function runSearch(q){
  const box=document.getElementById('search-results');
  const empty=document.getElementById('search-empty');
  if(!box) return;
  q=(q||'').trim().toLowerCase();
  if(!q){ box.innerHTML='<div id="search-empty" style="padding:28px;text-align:center;color:var(--g400);font-size:14px">Start typing to search…</div>'; return; }

  const isAdmin=S.role==='admin';
  const results=[];

  // Students (admin only)
  if(isAdmin){
    (S.students||[]).filter(s=>`${s.firstName} ${s.lastName} ${s.id} ${s.email}`.toLowerCase().includes(q)).slice(0,5).forEach(s=>{
      results.push({type:'student',icon:'👤',color:'var(--blue-bg)',label:`${s.firstName} ${s.lastName}`,sub:`${s.id} · ${s.level}`,action:`navTo('students');setTimeout(()=>renderStudentDetail('${s.id}'),100)`});
    });
  }
  // Assignments
  (S.assignments||[]).filter(a=>`${a.title} ${a.subject}`.toLowerCase().includes(q)).slice(0,5).forEach(a=>{
    results.push({type:'assignment',icon:'📝',color:'var(--amber-bg)',label:a.title,sub:`${a.subject} · ${a.status}`,action:`navTo('assignments')`});
  });
  // Classes
  (S.classes||[]).filter(c=>`${c.subject} ${c.tutor}`.toLowerCase().includes(q)).slice(0,4).forEach(c=>{
    results.push({type:'class',icon:'📚',color:'var(--green-bg)',label:c.subject,sub:`${c.tutor} · ${c.day} ${c.time}`,action:`navTo('classes')`});
  });
  // Notices
  (S.notices||[]).filter(n=>`${n.title} ${n.message}`.toLowerCase().includes(q)).slice(0,4).forEach(n=>{
    results.push({type:'notice',icon:'📣',color:'var(--purple-bg)',label:n.title,sub:n.date,action:`navTo('notices')`});
  });

  if(!results.length){
    box.innerHTML='<div style="padding:36px;text-align:center;color:var(--g400);font-size:14px;font-weight:500">No results for "<strong>'+q+'</strong>"</div>';
    return;
  }

  // Group by type
  const groups={student:'Students',assignment:'Assignments',class:'Classes',notice:'Notices'};
  let html=''; let lastType='';
  results.forEach(r=>{
    if(r.type!==lastType){ html+=`<div class="sr-section">${groups[r.type]}</div>`; lastType=r.type; }
    html+=`<div class="sr-item" onclick="${r.action};closeSearch()"><div class="sr-icon" style="background:${r.color}">${r.icon}</div><div><div class="sr-name">${sanitize(r.label)}</div><div class="sr-sub">${sanitize(r.sub)}</div></div></div>`;
  });
  box.innerHTML=html;
}

// ════════════════════════════════════════════════════════════════
//  FEATURE 4 — CBT COUNTDOWN TIMERS
// ════════════════════════════════════════════════════════════════
const _cdTimers=new Map();

function startCBTCountdowns(){
  _cdTimers.forEach(t=>clearInterval(t));
  _cdTimers.clear();
  document.querySelectorAll('[data-aid]').forEach(card=>{
    const aid=card.getAttribute('data-aid');
    const a=(S.assignments||[]).find(x=>x.id===aid);
    if(!a||a.type!=='CBT'||!a.cbtStart) return;
    const start=new Date(a.cbtStart);
    if(isNaN(start)) return;
    const now=new Date();
    if(now>=start) return; // already open or past
    const cdEl=document.createElement('div');
    cdEl.className='cbt-countdown';
    cdEl.id='cd-'+aid;
    cdEl.innerHTML=`<span style="font-size:13px;font-weight:700;color:var(--amber-t)">⏱ Opens in</span>
      <div class="cbt-countdown-inner">
        <div class="cbt-cd-unit"><span class="cbt-cd-num" id="cd-h-${aid}">--</span><span class="cbt-cd-label">hrs</span></div>
        <span class="cbt-cd-sep">:</span>
        <div class="cbt-cd-unit"><span class="cbt-cd-num" id="cd-m-${aid}">--</span><span class="cbt-cd-label">min</span></div>
        <span class="cbt-cd-sep">:</span>
        <div class="cbt-cd-unit"><span class="cbt-cd-num" id="cd-s-${aid}">--</span><span class="cbt-cd-label">sec</span></div>
      </div>`;
    // inject before the existing amber "opens on" notice if present
    const existingNotice=card.querySelector('.cbt-countdown');
    if(!existingNotice){
      const ref=card.querySelector('.btn-gold');
      if(ref) ref.before(cdEl); else card.querySelector('[style*="margin-top:12px"]')?.before(cdEl);
    }
    function tick(){
      const diff=new Date(a.cbtStart)-new Date();
      if(diff<=0){ clearInterval(timer); cdEl.remove(); return; }
      const h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000);
      const pad=n=>String(n).padStart(2,'0');
      const hEl=document.getElementById('cd-h-'+aid);
      const mEl=document.getElementById('cd-m-'+aid);
      const sEl=document.getElementById('cd-s-'+aid);
      if(hEl) hEl.textContent=pad(h);
      if(mEl) mEl.textContent=pad(m);
      if(sEl) sEl.textContent=pad(s);
    }
    tick();
    const timer=setInterval(tick,1000);
    _cdTimers.set(aid,timer);
  });
}

// ════════════════════════════════════════════════════════════════
//  FEATURE 5 — PRINT / EXPORT PROGRESS
// ════════════════════════════════════════════════════════════════
function printProgress(){
  const u=S.user;
  const printWin=window.open('','_blank','width=900,height=700');
  if(!printWin){ window.print(); return; }
  const myA=(S.assignments||[]).filter(a=>safeArr(a.assignedTo).length===0||safeArr(a.assignedTo).includes(u.id));
  const rows=myA.map(a=>`<tr>
    <td>${a.title||''}</td><td>${a.subject||''}</td><td>${a.dueDate||'—'}</td>
    <td><span style="padding:2px 8px;border-radius:4px;font-size:12px;font-weight:700;background:${a.status==='Graded'?'#D1FAE5':a.status==='Submitted'?'#DBEAFE':'#FEF3C7'};color:${a.status==='Graded'?'#064E3B':a.status==='Submitted'?'#1E3A8A':'#78350F'}">${a.status||'Pending'}</span></td>
    <td style="font-weight:700">${a.status==='Graded'?a.grade+'/100':'—'}</td>
    <td style="font-size:12px">${a.feedback||''}</td>
  </tr>`).join('');
  printWin.document.write(`<!DOCTYPE html><html><head><title>D-Maths Progress Report — ${u.firstName} ${u.lastName}</title>
  <style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Georgia,serif;padding:32px;color:#0F172A}
  h1{font-size:26px;margin-bottom:4px}h2{font-size:18px;margin:24px 0 12px;border-bottom:2px solid #D4A017;padding-bottom:6px}
  .meta{font-size:13px;color:#64748B;margin-bottom:28px}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:28px}
  .stat{border:1px solid #E2E8F0;border-radius:8px;padding:14px;text-align:center}
  .stat-val{font-size:28px;font-weight:700;color:#D4A017}.stat-lab{font-size:11px;color:#94A3B8;margin-top:4px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th{background:#0A1628;color:#fff;padding:10px 12px;text-align:left;font-size:12px}
  td{padding:9px 12px;border-bottom:1px solid #E2E8F0}tr:nth-child(even){background:#F8FAFC}
  .footer{margin-top:28px;font-size:11px;color:#94A3B8;text-align:center;border-top:1px solid #E2E8F0;padding-top:14px}
  @media print{@page{margin:1cm}}</style></head><body>
  <h1>D-Maths Tuition Centre</h1>
  <div class="meta">Progress Report · ${u.firstName} ${u.lastName} · ${u.id} · Generated ${new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}</div>
  <div class="stats">
    <div class="stat"><div class="stat-val">${u.avgScore||0}%</div><div class="stat-lab">Average Score</div></div>
    <div class="stat"><div class="stat-val">${u.attendance||0}%</div><div class="stat-lab">Attendance</div></div>
    <div class="stat"><div class="stat-val">${myA.filter(a=>a.status==='Graded').length}</div><div class="stat-lab">Graded Assignments</div></div>
  </div>
  <h2>Assignment History</h2>
  <table><thead><tr><th>Title</th><th>Subject</th><th>Due</th><th>Status</th><th>Grade</th><th>Feedback</th></tr></thead><tbody>${rows}</tbody></table>
  <div class="footer">D-Maths Tuition Centre · Confidential Student Record · ${new Date().getFullYear()}</div>
  <script>window.onload=function(){window.print();}<\/script></body></html>`);
  printWin.document.close();
}

// ════════════════════════════════════════════════════════════════
//  FEATURE 6 — ACHIEVEMENT BADGES (computed from existing data)
// ════════════════════════════════════════════════════════════════
function computeBadges(u){
  const myA=(S.assignments||[]).filter(a=>safeArr(a.assignedTo).length===0||safeArr(a.assignedTo).includes(u.id));
  const graded=myA.filter(a=>a.status==='Graded');
  const submitted=myA.filter(a=>a.status==='Submitted'||a.status==='Graded');
  const scores=graded.map(a=>+a.grade||0);
  const avg=scores.length?Math.round(scores.reduce((s,n)=>s+n,0)/scores.length):0;
  const cbtDone=myA.filter(a=>a.type==='CBT'&&a.status==='Graded');
  const subjects=[...new Set(graded.map(a=>a.subject).filter(Boolean))];

  return [
    {icon:'🌟',name:'First Submission',desc:'Submitted your first assignment',color:'gold',
      earned:submitted.length>=1,hint:'Submit an assignment to earn this'},
    {icon:'🎯',name:'Perfect Score',desc:'Scored 100% on an assignment',color:'green',
      earned:scores.some(s=>s===100),hint:'Score 100% on any graded assignment'},
    {icon:'🔥',name:'On a Roll',desc:'Submitted 5 or more assignments',color:'amber',
      earned:submitted.length>=5,hint:'Submit 5 or more assignments'},
    {icon:'🏆',name:'High Achiever',desc:'Maintained average score above 80%',color:'gold',
      earned:avg>=80&&graded.length>=2,hint:'Keep your average score above 80%'},
    {icon:'💎',name:'Distinction',desc:'Average score above 90%',color:'purple',
      earned:avg>=90&&graded.length>=2,hint:'Achieve an average score above 90%'},
    {icon:'🖥️',name:'CBT Champion',desc:'Completed a computer-based test',color:'blue',
      earned:cbtDone.length>=1,hint:'Complete a CBT assignment'},
    {icon:'🧠',name:'Multi-Subject',desc:'Graded in 3 or more subjects',color:'blue',
      earned:subjects.length>=3,hint:'Get graded assignments in 3+ subjects'},
    {icon:'👑',name:'Top Student',desc:'Activity score above 85',color:'gold',
      earned:(+u.activity||0)>=85,hint:'Build your activity score to 85+'},
    {icon:'📅',name:'Consistent',desc:'90%+ attendance record',color:'green',
      earned:(+u.attendance||0)>=90,hint:'Maintain 90% or higher attendance'},
    {icon:'⚡',name:'Speed Learner',desc:'10 or more graded assignments',color:'amber',
      earned:graded.length>=10,hint:'Complete 10 graded assignments'},
  ];
}

// ════════════════════════════════════════════════════════════════
//  FEATURE 7 — ASSIGNMENT NOTES / COMMENT THREAD
// ════════════════════════════════════════════════════════════════
const _notes=(() => {
  try{ return JSON.parse(localStorage.getItem('dm_notes')||'{}'); }catch(e){ return {}; }
})();

function saveNotes(){ try{ localStorage.setItem('dm_notes',JSON.stringify(_notes)); }catch(e){} }

function getNotes(aid){
  return Array.isArray(_notes[aid])?_notes[aid]:[];
}

function addNote(aid){
  const ta=document.getElementById('ni-'+aid);
  if(!ta||!ta.value.trim()) return;
  const text=ta.value.trim();
  if(!_notes[aid]) _notes[aid]=[];
  const note={text,ts:Date.now(),role:S.role||'student'};
  _notes[aid].push(note);
  saveNotes();
  ta.value='';
  // Append bubble to DOM immediately
  const listEl=document.querySelector(`#notes-body-${aid} .notes-list`);
  if(listEl){
    const bubble=document.createElement('div');
    bubble.style.cssText='display:flex;flex-direction:column;margin-bottom:4px';
    bubble.innerHTML=`<div class="note-bubble ${note.role==='admin'?'admin':'student'}">${sanitize(text)}<div class="note-bubble-meta">${new Date(note.ts).toLocaleString()}</div></div>`;
    listEl.appendChild(bubble);
    listEl.scrollTop=listEl.scrollHeight;
  }
  // Update count badge
  const nc=document.getElementById('nc-'+aid);
  if(nc) nc.textContent=getNotes(aid).length;
}

function toggleNotes(aid){
  const body=document.getElementById('notes-body-'+aid);
  const arr=document.getElementById('nc-arr-'+aid);
  if(!body) return;
  const open=body.style.display==='none'||body.style.display==='';
  body.style.display=open?'flex':'none';
  body.style.flexDirection='column';
  if(arr) arr.style.transform=open?'rotate(180deg)':'rotate(0deg)';
  if(open){
    const listEl=body.querySelector('.notes-list');
    if(listEl){ listEl.scrollTop=listEl.scrollHeight; }
    const ta=document.getElementById('ni-'+aid);
    if(ta) ta.focus();
  }
}

// ════════════════════════════════════════════════════════════════
//  FEATURE 8 — SEARCH PAGE (for navTo routing)
// ════════════════════════════════════════════════════════════════
function renderSearch(){
  openSearch();
  // Return to previous page in nav since search is an overlay
  navTo(S.activePg||'dashboard');
}

// ════════════════════════════════════════════════════════════════
//  BOOT — init dark mode + bell on portal load
// ════════════════════════════════════════════════════════════════
const _origInitPortal = initPortal;
initPortal = async function(){
  await _origInitPortal.apply(this, arguments);
  initDarkMode();
  updateBellBadge();
};


function calcActivity(s){
  const stuAssigns=S.assignments.filter(a=>safeArr(a.assignedTo).includes(s.id)||safeArr(s.subjects||[]).some(sub=>a.subject===sub));
  const stuSub=stuAssigns.filter(a=>a.status==='Submitted'||a.status==='Graded').length;
  const subRate=stuAssigns.length?Math.round((stuSub/stuAssigns.length)*100):0;
  const sub={total:stuAssigns.length,submitted:stuSub,rate:subRate};
  const actScore=Math.round(((+s.avgScore||0)*0.5)+((+s.attendance||0)*0.3)+(subRate*0.2));
  return {actScore,sub};
}
function starsHtml(n){let h='';for(let i=0;i<5;i++) h+=i<n?'⭐':'☆';return h;}

function renderReports(){ if(!requireAdmin()) return;
  const avgScore=S.students.length?Math.round(S.students.reduce((s,st)=>s+(+st.avgScore||0),0)/S.students.length):0;
  const totalA=S.assignments.length;
  const subA=S.assignments.filter(a=>a.status==='Submitted'||a.status==='Graded').length;
  const cbtA=S.assignments.filter(a=>a.type==='CBT').length;
  const subRate=totalA?Math.round((subA/totalA)*100):0;
  const top=[...S.students].sort((a,b)=>(+b.avgScore||0)-(+a.avgScore||0));
  const needs=[...S.students].sort((a,b)=>(+a.avgScore||0)-(+b.avgScore||0));
  const actRanked=[...S.students].map(s=>{const r=calcActivity(s);return{...s,...r};}).sort((a,b)=>b.actScore-a.actScore);
  html('portal-pages',`<div class="pg on fi">
    <div class="phdr"><div><h2 class="ptitle">Reports & Analytics</h2><p class="psub">Student activity, submissions & rewards</p></div>
      <button class="btn btn-ghost btn-sm" onclick="syncFromSheets().then(renderReports)">${IC.refresh} Sync</button>
    </div>
    <div class="g4" style="margin-bottom:22px">
      ${statCard('👥','Total Students',S.students.length,null,'var(--blue)')}
      ${statCard('📊','Class Average',avgScore+'%',null,'var(--green)')}
      ${statCard('📤','Submit Rate',subRate+'%',subA+'/'+totalA+' submitted','var(--amber)')}
      ${statCard('🖥️','CBT Tests',cbtA,null,'var(--purple)')}
    </div>


    <div class="card" style="margin-bottom:22px;overflow:hidden">
      <div class="cp" style="border-bottom:1px solid var(--g100);padding-bottom:14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
        <div><h3 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900)">📊 Student Activity & Rewards</h3>
        <p style="font-size:12px;color:var(--g400);margin-top:3px;font-weight:500">Activity = Avg Score (50%) + Attendance (30%) + Submission Rate (20%)</p></div>
      </div>
      <div class="tw"><table>
        <thead><tr><th>#</th><th>Student</th><th>Avg Score</th><th>Attend.</th><th>Submissions</th><th>Activity</th><th>Stars</th><th>Reward</th></tr></thead>
        <tbody>${actRanked.length?actRanked.map((s,i)=>{
          const rankColor=i===0?'var(--gold)':i===1?'#94A3B8':i===2?'var(--amber)':'var(--g300)';
          const stars=s.actScore>=90?5:s.actScore>=75?4:s.actScore>=60?3:s.actScore>=45?2:s.actScore>=25?1:0;
          return `<tr>
            <td style="font-weight:900;font-size:13px;color:${rankColor}">#${i+1}</td>
            <td><div style="display:flex;align-items:center;gap:9px">${av(`${s.firstName} ${s.lastName}`,32)}<div><p style="font-weight:700;font-size:13px">${s.firstName} ${s.lastName}</p><p style="font-size:11px;color:var(--g400);font-family:var(--font-mono)">${s.id}</p></div></div></td>
            <td><span style="font-weight:800;color:${(+s.avgScore||0)>=80?'var(--green)':(+s.avgScore||0)>=60?'var(--gold)':'var(--red)'}">${s.avgScore||0}%</span></td>
            <td><span style="font-weight:700;color:${(+s.attendance||0)>=80?'var(--green)':'var(--amber)'}">${s.attendance||0}%</span></td>
            <td style="font-size:13px;font-weight:600">${s.sub.submitted}/${s.sub.total} <span style="color:var(--g400)">(${s.sub.rate}%)</span></td>
            <td><div style="display:flex;align-items:center;gap:8px"><div class="pt" style="width:72px"><div class="pf" style="width:${s.actScore}%"></div></div><strong>${s.actScore}</strong></div></td>
            <td style="font-size:14px;letter-spacing:1px">${starsHtml(stars)}</td>
            <td><button class="btn btn-gold btn-xs" onclick="rewardStudent('${s.id}','${s.firstName} ${s.lastName}',${stars})">${IC.edit} Reward</button></td>
          </tr>`;
        }).join(''):`<tr><td colspan="8" style="text-align:center;padding:32px;color:var(--g400)">No student data yet.</td></tr>`}</tbody>
      </table></div>
    </div>

    <div class="g2">
      ${[{title:'🏆 Top Performers',list:top},{title:'⚠️ Needs Attention',list:needs}].map(({title,list})=>`<div class="card cp"><h3 style="font-family:var(--font-display);font-weight:700;font-size:18px;color:var(--g900);margin-bottom:16px">${title}</h3>${list.slice(0,5).map((s,i)=>`<div style="display:flex;align-items:center;gap:12px;margin-bottom:13px;cursor:pointer" onclick="S.selStudent='${s.id}';navTo('students')"><span style="width:24px;font-size:13px;font-weight:900;color:${i===0&&title.includes('Top')?'var(--gold)':'var(--g300)'};text-align:center">#${i+1}</span>${av(`${s.firstName} ${s.lastName}`,34)}<div style="flex:1;min-width:0"><p style="font-size:13px;font-weight:700;color:var(--g900);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.firstName} ${s.lastName}</p><div class="pt" style="margin-top:5px"><div class="pf" style="width:${s.avgScore||0}%;${(+s.avgScore||0)<70&&title.includes('Attention')?'background:linear-gradient(90deg,var(--red),#f87171)':''}"></div></div></div><span style="font-weight:900;color:${(+s.avgScore||0)>=80?'var(--green)':(+s.avgScore||0)>=70?'var(--gold)':'var(--red)'}">${s.avgScore||0}%</span></div>`).join('')}${!list.length?'<p style="color:var(--g400);text-align:center;font-size:13.5px">No student data</p>':''}</div>`).join('')}
    </div>
  </div>`);

}

function rewardStudent(sid, name, currentStars){
  const starsRow=[1,2,3,4,5].map(n=>`<button type="button" class="star-rwd-btn" data-n="${n}" style="flex:1;padding:10px 0;border:2px solid ${n<=currentStars?'var(--gold)':'var(--g200)'};border-radius:var(--r);font-size:18px;cursor:pointer;background:${n<=currentStars?'var(--gold-pale)':'#fff'};font-family:var(--font-body);transition:all .15s" onclick="document.querySelectorAll('.star-rwd-btn').forEach((b,i)=>{const sel=i<${n};b.style.borderColor=sel?'var(--gold)':'var(--g200)';b.style.background=sel?'var(--gold-pale)':'#fff'});document.getElementById('reward-stars').value='${n}'">⭐</button>`).join('');
  openModal('⭐ Reward Student — '+name,`<div style="text-align:center;margin-bottom:16px;font-size:36px">${starsHtml(currentStars)}<p style="font-size:13px;color:var(--g400);margin-top:6px;font-weight:500">Current rating: ${currentStars}/5 stars</p></div><div class="fg"><label class="fl">New Star Rating</label><div style="display:flex;gap:6px;margin-top:6px">${starsRow}</div><input type="hidden" id="reward-stars" value="${currentStars}"></div><div class="fg"><label class="fl">Message to Student</label><textarea class="fi-el" id="reward-msg" rows="3" placeholder="e.g. Excellent work this month! Keep it up! 🏆"></textarea></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="submitReward('${sid}','${name}')">Send Reward ⭐</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function submitReward(sid, name){
  const stars=+($id('reward-stars')?.value||1);
  const msg=$id('reward-msg')?.value||'';
  if(!msg){ toast('Please add a reward message','e'); return; }
  await API.post('rewardStudent',{studentId:sid,stars,message:msg,date:new Date().toISOString().split('T')[0]});
  toast('Reward sent to '+name+'! ⭐','s');
  closeModal();
}

// ════════════════════════════════════════════════════════════════
//  MODAL FORMS
// ════════════════════════════════════════════════════════════════
function openAddNoticeModal(){
  openModal('Post Announcement',`<div class="fg"><label class="fl">Title <span class="freq">*</span></label><input class="fi-el" id="nt-t" placeholder="Notice title..."></div><div class="fg"><label class="fl">Target</label><select class="fi-el" id="nt-tg"><option value="all">All Students</option>${['Algebra','Calculus','Statistics','Geometry','Further Mathematics','Physics','JavaScript','Python','External Examinations'].map(s=>`<option value="${s}">${s} Students</option>`).join('')}</select></div><div class="fg"><label class="fl">Message <span class="freq">*</span></label><textarea class="fi-el" id="nt-b" rows="5" placeholder="Write your announcement here..."></textarea></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="submitNotice()">Post & Notify Students</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function submitNotice(){
  const t=$id('nt-t')?.value.trim(), b=$id('nt-b')?.value.trim();
  if(!t||!b){ toast('Please fill in all fields','e'); return; }
  await API.addNotice({title:t,body:b,target:$id('nt-tg')?.value||'all',date:new Date().toISOString().split('T')[0]});
  toast('Announcement posted & students notified! 🔔','s');
  S.notices=await API.getNotices();
  closeModal(); renderNotices();
}

function openAddClassModal(){
  const stuOptions=S.students.length?S.students.map(s=>`<label style="display:flex;align-items:center;gap:10px;padding:9px 12px;border:1.5px solid var(--g200);border-radius:var(--r);cursor:pointer;background:#fff;transition:border-color .15s"><input type="checkbox" value="${s.id}" class="cl-stu-cb" style="width:16px;height:16px;accent-color:var(--gold);flex-shrink:0" onchange="this.closest('label').style.borderColor=this.checked?'var(--gold)':'var(--g200)';this.closest('label').style.background=this.checked?'var(--gold-pale)':'#fff'">${av(`${s.firstName} ${s.lastName}`,28)}<span style="font-size:13px;font-weight:700;color:var(--g900)">${s.firstName} ${s.lastName}</span><span class="badge b-gray" style="font-size:10px;margin-left:auto">${s.level}</span></label>`).join(''):'<p style="color:var(--g400);font-size:13.5px;padding:12px 0">No registered students yet.</p>';
  openModal('Create New Class',`<div class="fg"><label class="fl">Subject Name <span class="freq">*</span></label><input class="fi-el" id="cl-subj" placeholder="e.g. Algebra Fundamentals"></div><div class="frow"><div class="fg"><label class="fl">Tutor Name <span class="freq">*</span></label><input class="fi-el" id="cl-tutor" placeholder="e.g. Mr. D. Bakare"></div><div class="fg"><label class="fl">Platform</label><select class="fi-el" id="cl-plat"><option>Zoom</option><option>Google Meet</option><option>Microsoft Teams</option></select></div></div><div class="frow"><div class="fg"><label class="fl">Day</label><select class="fi-el" id="cl-day">${['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].map(d=>`<option>${d}</option>`).join('')}</select></div><div class="fg"><label class="fl">Time</label><input class="fi-el" id="cl-time" type="time"></div></div><div class="frow"><div class="fg"><label class="fl">Duration</label><input class="fi-el" id="cl-dur" placeholder="e.g. 1.5 hrs"></div><div class="fg"><label class="fl">Class Link <span class="freq">*</span></label><input class="fi-el" id="cl-link" placeholder="https://zoom.us/..."></div></div><div class="fg"><label class="fl" style="display:flex;justify-content:space-between">Assign Students <button type="button" style="background:none;border:none;color:var(--gold);font-weight:700;cursor:pointer;font-size:12px;font-family:var(--font-body)" onclick="document.querySelectorAll('.cl-stu-cb').forEach(cb=>{cb.checked=!cb.checked;cb.closest('label').style.borderColor=cb.checked?'var(--gold)':'var(--g200)';cb.closest('label').style.background=cb.checked?'var(--gold-pale)':'#fff'})">Toggle All</button></label><div style="max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding:4px;border:1px solid var(--g100);border-radius:var(--r)">${stuOptions}</div></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="submitClass()">Create Class</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`,true);
}
async function submitClass(){
  const subj=$id('cl-subj')?.value.trim(), tutor=$id('cl-tutor')?.value.trim();
  if(!subj||!tutor){ toast('Please fill in required fields','e'); return; }
  const selStudents=[...document.querySelectorAll('.cl-stu-cb:checked')].map(cb=>cb.value);
  await API.addClass({subject:subj,tutor,day:$id('cl-day')?.value,time:$id('cl-time')?.value,duration:$id('cl-dur')?.value||'',platform:$id('cl-plat')?.value,link:$id('cl-link')?.value||'',students:selStudents});
  toast(`Class created — ${selStudents.length} student(s) assigned! 🎬`,'s'); S.classes=await API.getClasses(); closeModal(); renderAClasses();
}

function openAddStudentModal(){
  openModal('Add Student Manually',`<div class="al al-i">${IC.warn} A Student ID and temporary password will be auto-generated and emailed to the student.</div><div class="frow"><div class="fg"><label class="fl">First Name <span class="freq">*</span></label><input class="fi-el" id="as-fn" placeholder="e.g. Akua"></div><div class="fg"><label class="fl">Last Name <span class="freq">*</span></label><input class="fi-el" id="as-ln" placeholder="e.g. Boateng"></div></div><div class="fg"><label class="fl">Email <span class="freq">*</span></label><input class="fi-el" id="as-em" type="email" placeholder="student@email.com"></div><div class="frow"><div class="fg"><label class="fl">Level</label><select class="fi-el" id="as-lvl">${['JSS 1','JSS 2','JSS 3','SSS 1','SSS 2','SSS 3'].map(l=>`<option>${l}</option>`).join('')}</select></div><div class="fg"><label class="fl">Phone</label><input class="fi-el" id="as-ph" placeholder=" +234 XX XXX XXXX"></div></div><div class="fg"><label class="fl">Guardian Name</label><input class="fi-el" id="as-gn" placeholder="Parent/Guardian full name"></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="submitAddStudent()">Create Account & Email Credentials</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function submitAddStudent(){
  const fn=$id('as-fn')?.value.trim(), ln=$id('as-ln')?.value.trim(), em=$id('as-em')?.value.trim();
  if(!fn||!ln||!em){ toast('Please fill in required fields','e'); return; }
  await API.addStudent({firstName:fn,lastName:ln,email:em,phone:$id('as-ph')?.value||'',guardian:$id('as-gn')?.value||'',level:$id('as-lvl')?.value||'JSS 1',subjects:[],isActive:true,avgScore:0,attendance:0});
  toast('Student account created! Credentials emailed. ✅','s'); S.students=await API.getStudents(); closeModal(); renderAStudents();
}

function openAddAssignModal(){
  const subs=['Algebra','Calculus','Statistics','Geometry','Further Mathematics','Core Maths Revision','Physics','JavaScript','Python','External Examinations'];
  const stuOptions=S.students.length?S.students.map(s=>`<label style="display:flex;align-items:center;gap:10px;padding:9px 12px;border:1.5px solid var(--g200);border-radius:var(--r);cursor:pointer;background:#fff;transition:border-color .15s"><input type="checkbox" value="${s.id}" class="aa-stu-cb" style="width:16px;height:16px;accent-color:var(--gold);flex-shrink:0" onchange="this.closest('label').style.borderColor=this.checked?'var(--gold)':'var(--g200)';this.closest('label').style.background=this.checked?'var(--gold-pale)':'#fff'">${av(`${s.firstName} ${s.lastName}`,28)}<span style="font-size:13px;font-weight:700;color:var(--g900)">${s.firstName} ${s.lastName}</span><span class="badge b-gray" style="font-size:10px;margin-left:auto">${s.level}</span></label>`).join(''):'<p style="color:var(--g400);font-size:13.5px;padding:12px 0">No registered students yet.</p>';
  openModal('New Assignment',`<div class="fg"><label class="fl">Title <span class="freq">*</span></label><input class="fi-el" id="aa-t" placeholder="e.g. Differentiation Practice Set 3"></div><div class="frow"><div class="fg"><label class="fl">Subject</label><select class="fi-el" id="aa-s">${subs.map(s=>`<option>${s}</option>`).join('')}</select></div><div class="fg"><label class="fl">Due Date</label><input class="fi-el" id="aa-d" type="date"></div></div><div class="fg"><label class="fl">Type <span class="freq">*</span></label><div style="display:flex;gap:8px;margin-top:6px"><label id="lbl-written" style="flex:1;display:flex;align-items:center;gap:8px;padding:10px 14px;border:2px solid var(--gold);border-radius:var(--r);cursor:pointer;background:var(--gold-pale)"><input type="radio" name="aa-type" id="aa-type-written" value="Written" checked style="accent-color:var(--gold)" onchange="toggleCBTRow(false)"><span style="font-size:13px;font-weight:700">✏️ Written</span></label><label id="lbl-cbt" style="flex:1;display:flex;align-items:center;gap:8px;padding:10px 14px;border:2px solid var(--g200);border-radius:var(--r);cursor:pointer;background:#fff"><input type="radio" name="aa-type" id="aa-type-cbt" value="CBT" style="accent-color:var(--blue)" onchange="toggleCBTRow(true)"><span style="font-size:13px;font-weight:700;color:var(--blue)">🖥️ CBT</span></label></div></div><div id="aa-cbt-row" style="display:none"><div class="fg"><label class="fl">CBT Test Link <span class="freq">*</span></label><input class="fi-el" id="aa-cbt-link" placeholder="Paste CBT platform link (e.g. https://...)"></div><div class="frow"><div class="fg"><label class="fl">Available From (Date &amp; Time)</label><input class="fi-el" id="aa-cbt-start" type="datetime-local"></div><div class="fg"><label class="fl">Available Until (Date &amp; Time)</label><input class="fi-el" id="aa-cbt-end" type="datetime-local"></div></div></div><div class="fg"><label class="fl">Instructions</label><textarea class="fi-el" id="aa-i" rows="3" placeholder="Detailed instructions for students..."></textarea></div><div class="fg"><label class="fl" style="display:flex;justify-content:space-between">Assign to Students <span style="font-weight:400;color:var(--g400);font-size:11px">(blank = all)</span></label><button type="button" style="background:none;border:none;color:var(--gold);font-weight:700;cursor:pointer;font-size:12px;font-family:var(--font-body);text-align:left;margin-bottom:6px" onclick="document.querySelectorAll('.aa-stu-cb').forEach(cb=>{cb.checked=!cb.checked;cb.closest('label').style.borderColor=cb.checked?'var(--gold)':'var(--g200)';cb.closest('label').style.background=cb.checked?'var(--gold-pale)':'#fff'})">Toggle All</button><div style="max-height:170px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;padding:4px;border:1px solid var(--g100);border-radius:var(--r)">${stuOptions}</div></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="submitAssign()">Create & Notify</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`,true);
}
function toggleCBTRow(show){
  const row=$id('aa-cbt-row'); if(row) row.style.display=show?'block':'none';
  const lblW=$id('lbl-written'),lblC=$id('lbl-cbt');
  if(lblW){lblW.style.borderColor=show?'var(--g200)':'var(--gold)';lblW.style.background=show?'#fff':'var(--gold-pale)';}
  if(lblC){lblC.style.borderColor=show?'var(--blue)':'var(--g200)';lblC.style.background=show?'var(--blue-bg)':'#fff';}
}
async function submitAssign(){
  const t=$id('aa-t')?.value.trim(); if(!t){ toast('Please enter a title','e'); return; }
  const isCBT=document.getElementById('aa-type-cbt')?.checked;
  let cbtLink=isCBT?($id('aa-cbt-link')?.value.trim()||''):'';
  if(isCBT&&cbtLink&&!cbtLink.startsWith('http')){ cbtLink='https://'+cbtLink; }
  if(isCBT&&!cbtLink){ toast('Please enter the CBT test link','e'); return; }
  const selStudents=[...document.querySelectorAll('.aa-stu-cb:checked')].map(cb=>cb.value);
  const cbtStart=$id('aa-cbt-start')?.value||''; const cbtEnd=$id('aa-cbt-end')?.value||''; await API.addAssignment({title:t,subject:$id('aa-s')?.value||'Algebra',dueDate:$id('aa-d')?.value||'',instructions:$id('aa-i')?.value||'',type:isCBT?'CBT':'Written',cbtLink,cbtStart,cbtEnd,assignedTo:selStudents,status:'Pending'});
  toast(selStudents.length?`Sent to ${selStudents.length} student(s)! 📝`:'Created & all students notified! 📝','s');
  S.assignments=await API.getAssignments(); closeModal(); renderAAssignments();
}

function openEditStudentModal(sid){
  const s=S.students.find(x=>x.id===sid); if(!s) return;
  openModal('Edit Student',`<div class="frow"><div class="fg"><label class="fl">First Name</label><input class="fi-el" id="es-fn" value="${s.firstName}"></div><div class="fg"><label class="fl">Last Name</label><input class="fi-el" id="es-ln" value="${s.lastName}"></div></div><div class="fg"><label class="fl">Email</label><input class="fi-el" id="es-em" type="email" value="${s.email}"></div><div class="frow"><div class="fg"><label class="fl">Level</label><select class="fi-el" id="es-lvl">${['JSS 1','JSS 2','JSS 3','SSS 1','SSS 2','SSS 3'].map(l=>`<option ${s.level===l?'selected':''}>${l}</option>`).join('')}</select></div><div class="fg"><label class="fl">Phone</label><input class="fi-el" id="es-ph" value="${s.phone}"></div></div><div class="fg"><label class="fl">Guardian</label><input class="fi-el" id="es-gn" value="${s.guardian}"></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="saveEditStudent('${sid}')">Save Changes</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function saveEditStudent(sid){
  await API.updateStudent({id:sid,firstName:$id('es-fn')?.value||'',lastName:$id('es-ln')?.value||'',email:$id('es-em')?.value||'',level:$id('es-lvl')?.value||'',phone:$id('es-ph')?.value||'',guardian:$id('es-gn')?.value||''});
  toast('Student updated! ✅','s'); S.students=await API.getStudents(); closeModal(); renderAStudents();
}

function openAssignStudentsModal(classId){
  const cls=S.classes.find(c=>c.id===classId); if(!cls) return;
  const assigned=safeArr(cls.students);
  openModal(`Assign Students — ${cls.subject}`,`<p style="color:var(--g400);font-size:13.5px;margin-bottom:16px;font-weight:500">Check students to assign to this class.</p><div style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto">${S.students.map(s=>`<label style="display:flex;align-items:center;gap:12px;padding:10px 14px;border:1.5px solid ${assigned.includes(s.id)?'var(--gold)':'var(--g200)'};border-radius:var(--r);cursor:pointer;transition:all .18s;background:${assigned.includes(s.id)?'var(--gold-pale)':'#fff'}"><input type="checkbox" value="${s.id}" ${assigned.includes(s.id)?'checked':''} style="width:16px;height:16px;accent-color:var(--gold)">${av(`${s.firstName} ${s.lastName}`,32)}<div><p style="font-size:13.5px;font-weight:700;color:var(--g900)">${s.firstName} ${s.lastName}</p><p style="font-size:11.5px;color:var(--g400);font-family:var(--font-mono)">${s.id}</p></div><span class="badge b-gray" style="margin-left:auto;font-size:10px">${s.level}</span></label>`).join('')}${!S.students.length?'<p style="text-align:center;color:var(--g400);padding:20px">No students registered yet.</p>':''}</div><div style="display:flex;gap:10px;padding-top:16px"><button class="btn btn-gold" style="flex:1" onclick="saveClassStudents('${classId}')">Save Assignment</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function saveClassStudents(classId){
  const checked=[...document.querySelectorAll('input[type=checkbox]:checked')].map(cb=>cb.value);
  await API.post('updateClass',{id:classId,students:checked});
  toast(`Class updated — ${checked.length} students assigned! ✅`,'s'); S.classes=await API.getClasses(); closeModal(); renderAClasses();
}

function markAttendanceModal(classId){
  const cls=S.classes.find(c=>c.id===classId); if(!cls) return;
  const classStudents=S.students.filter(s=>safeArr(cls.students).includes(s.id));
  openModal(`Attendance — ${cls.subject}`,`<p style="color:var(--g400);font-size:13.5px;margin-bottom:16px;font-weight:500">Mark attendance for today (${new Date().toLocaleDateString()}).</p><div style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto">${classStudents.map(s=>`<label style="display:flex;align-items:center;gap:12px;padding:10px 14px;border:1.5px solid var(--g200);border-radius:var(--r);cursor:pointer;transition:all .15s"><input type="checkbox" value="${s.id}" checked style="width:16px;height:16px;accent-color:var(--green)">${av(`${s.firstName} ${s.lastName}`,32)}<span style="font-weight:700;color:var(--g900)">${s.firstName} ${s.lastName}</span></label>`).join('')}${!classStudents.length?'<p style="text-align:center;color:var(--g400);padding:20px">No students assigned to this class.</p>':''}</div><div style="display:flex;gap:10px;padding-top:16px"><button class="btn btn-ok" style="flex:1" onclick="submitAttendance('${classId}')">Save Attendance</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function submitAttendance(classId){
  const present=[...document.querySelectorAll('input[type=checkbox]:checked')].map(cb=>cb.value);
  const absent=[...document.querySelectorAll('input[type=checkbox]:not(:checked)')].map(cb=>cb.value);
  await API.markAttendance({classId,date:new Date().toISOString().split('T')[0],present,absent});
  toast(`Attendance saved — ${present.length} present, ${absent.length} absent. ✅`,'s'); S.students=await API.getStudents(); closeModal();
}

function openEditClassModal(classId){
  const cls=S.classes.find(c=>c.id===classId); if(!cls) return;
  openModal('Edit Class',`<div class="fg"><label class="fl">Subject Name</label><input class="fi-el" id="ec-subj" value="${cls.subject}"></div><div class="frow"><div class="fg"><label class="fl">Tutor</label><input class="fi-el" id="ec-tutor" value="${cls.tutor}"></div><div class="fg"><label class="fl">Platform</label><select class="fi-el" id="ec-plat"><option ${cls.platform==='Zoom'?'selected':''}>Zoom</option><option ${cls.platform==='Google Meet'?'selected':''}>Google Meet</option><option ${cls.platform==='Microsoft Teams'?'selected':''}>Microsoft Teams</option></select></div></div><div class="frow"><div class="fg"><label class="fl">Day</label><select class="fi-el" id="ec-day">${['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].map(d=>`<option ${cls.day===d?'selected':''}>${d}</option>`).join('')}</select></div><div class="fg"><label class="fl">Time</label><input class="fi-el" id="ec-time" type="time" value="${cls.time}"></div></div><div class="fg"><label class="fl">Class Link</label><input class="fi-el" id="ec-link" value="${cls.link||''}"></div><div style="display:flex;gap:10px;padding-top:4px"><button class="btn btn-gold" style="flex:1" onclick="saveEditClass('${classId}')">Save Changes</button><button class="btn btn-ghost" onclick="closeModal()">Cancel</button></div>`);
}
async function saveEditClass(classId){
  await API.post('updateClass',{id:classId,subject:$id('ec-subj')?.value,tutor:$id('ec-tutor')?.value,platform:$id('ec-plat')?.value,day:$id('ec-day')?.value,time:$id('ec-time')?.value,link:$id('ec-link')?.value});
  toast('Class updated! ✅','s'); S.classes=await API.getClasses(); closeModal(); renderAClasses();
}

// ════════════════════════════════════════════════════════════════
//  CHARTS
// ════════════════════════════════════════════════════════════════
const FONT="'Nunito',sans-serif";
const CHART_DEFAULTS={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{font:{family:FONT,size:12},color:'#64748B',boxWidth:12}},tooltip:{backgroundColor:'#0A1628',titleColor:'#fff',bodyColor:'rgba(255,255,255,.8)',borderColor:'rgba(255,255,255,.1)',borderWidth:1,padding:10,titleFont:{family:FONT,size:13},bodyFont:{family:FONT,size:12}}},scales:{x:{grid:{display:false},ticks:{font:{family:FONT,size:11},color:'#94A3B8'},border:{display:false}},y:{grid:{color:'#F1F5F9'},ticks:{font:{family:FONT,size:11},color:'#94A3B8'},border:{display:false}}}};
function destroyChart(id){if(S.charts[id]){S.charts[id].destroy();delete S.charts[id];}}
function getScoreData(){return[{m:'Sep',A:72,C:68,S:80},{m:'Oct',A:78,C:74,S:83},{m:'Nov',A:82,C:79,S:86},{m:'Dec',A:85,C:83,S:89},{m:'Jan',A:88,C:87,S:91},{m:'Feb',A:87,C:90,S:92}];}
function getEnrollData(){const mo=['Jan','Feb','Mar','Apr','May','Jun'];return mo.map((m,i)=>({m,n:Math.max(6,S.students.length-5+i)}));}

function makeScoreChart(canvasId){
  const el=$id(canvasId); if(!el)return; destroyChart(canvasId);
  const d=getScoreData();
  S.charts[canvasId]=new Chart(el,{type:'line',data:{labels:d.map(x=>x.m),datasets:[{label:'Algebra',data:d.map(x=>x.A),borderColor:'#F2BC3B',backgroundColor:'rgba(242,188,59,.12)',fill:true,tension:.4,borderWidth:2.5,pointRadius:4},{label:'Calculus',data:d.map(x=>x.C),borderColor:'#60A5FA',backgroundColor:'rgba(96,165,250,.1)',fill:true,tension:.4,borderWidth:2.5,pointRadius:4},{label:'Statistics',data:d.map(x=>x.S),borderColor:'#34D399',backgroundColor:'rgba(52,211,153,.1)',fill:true,tension:.4,borderWidth:2.5,pointRadius:4}]},options:{...CHART_DEFAULTS,scales:{...CHART_DEFAULTS.scales,y:{...CHART_DEFAULTS.scales.y,min:60,max:100}}}});
}
function makeProgressChart(canvasId){
  const el=$id(canvasId); if(!el)return; destroyChart(canvasId);
  const d=getScoreData();
  S.charts[canvasId]=new Chart(el,{type:'line',data:{labels:d.map(x=>x.m),datasets:[{label:'Algebra',data:d.map(x=>x.A),borderColor:'#F2BC3B',tension:.4,borderWidth:2.5,pointRadius:3},{label:'Calculus',data:d.map(x=>x.C),borderColor:'#60A5FA',tension:.4,borderWidth:2.5,pointRadius:3},{label:'Statistics',data:d.map(x=>x.S),borderColor:'#34D399',tension:.4,borderWidth:2.5,pointRadius:3}]},options:{...CHART_DEFAULTS,scales:{...CHART_DEFAULTS.scales,y:{...CHART_DEFAULTS.scales.y,min:60,max:100}}}});
}
function makeStudentChart(canvasId){
  const el=$id(canvasId); if(!el)return; destroyChart(canvasId);
  const d=getScoreData();
  S.charts[canvasId]=new Chart(el,{type:'line',data:{labels:d.map(x=>x.m),datasets:[{label:'Score',data:d.map(x=>x.A),borderColor:'#D4A017',backgroundColor:'rgba(212,160,23,.12)',fill:true,tension:.4,borderWidth:2.5,pointRadius:4}]},options:{...CHART_DEFAULTS,scales:{...CHART_DEFAULTS.scales,y:{...CHART_DEFAULTS.scales.y,min:0,max:100}}}});
}
function makeEnrollChart(canvasId){
  const el=$id(canvasId); if(!el)return; destroyChart(canvasId);
  const d=getEnrollData();
  S.charts[canvasId]=new Chart(el,{type:'line',data:{labels:d.map(x=>x.m),datasets:[{label:'Students',data:d.map(x=>x.n),borderColor:'#D4A017',backgroundColor:'rgba(212,160,23,.12)',fill:true,tension:.4,borderWidth:2.5,pointRadius:4}]},options:CHART_DEFAULTS});
}
function makeSubjectChart(canvasId){
  const el=$id(canvasId); if(!el)return; destroyChart(canvasId);
  const subs=['Algebra','Calculus','Statistics','Geometry','Further Mathematics'];
  const vals=subs.map(sub=>{const g=S.assignments.filter(a=>a.subject===sub&&a.status==='Graded');return g.length?Math.round(g.reduce((s,a)=>s+(+a.grade||0),0)/g.length):Math.floor(68+Math.random()*22);});
  S.charts[canvasId]=new Chart(el,{type:'bar',data:{labels:subs,datasets:[{data:vals,backgroundColor:['rgba(212,160,23,.82)','rgba(96,165,250,.82)','rgba(52,211,153,.82)','rgba(244,114,182,.82)','rgba(167,139,250,.82)'],borderRadius:5,borderSkipped:false,barThickness:26}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#0A1628',padding:8,titleFont:{family:"'Nunito',sans-serif",size:12},bodyFont:{family:"'Nunito',sans-serif",size:12},callbacks:{label:ctx=>`Avg: ${ctx.raw}%`}}},scales:{x:{grid:{display:false},ticks:{font:{family:"'Nunito',sans-serif",size:11},color:'#94A3B8'},border:{display:false}},y:{display:false,min:0,max:110}}}});
}

// ════════════════════════════════════════════════════════════════
//  BOOT — GUARANTEED LANDING PAGE FIX
// ════════════════════════════════════════════════════════════════
function bootLanding(){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  const vl=document.getElementById('vl'); if(vl) vl.classList.add('on');
  try{ initLanding(); }catch(e){ console.error('initLanding error:',e); }
  const lov=document.getElementById('lov');
  if(lov){ lov.classList.add('fade'); setTimeout(()=>{ try{ lov.remove(); }catch(e){} },520); }
}

window.addEventListener('DOMContentLoaded', () => {
  // Hard safety — loader always gone within 4 seconds
  setTimeout(()=>{ const l=document.getElementById('lov'); if(l) l.remove(); }, 4000);
  // ── SESSION RESTORE ──────────────────────────────────────────
  try {
    const raw=sessionStorage.getItem('dm_sess');
    if(raw){
      const sess=JSON.parse(raw);
      if(sess&&sess.user&&['student','admin'].includes(sess.role)&&(Date.now()-sess.ts)<8*60*60*1000){
        S.user=sess.user; S.role=sess.role; S.token=sess.token||null;
        S.activePg=sessionStorage.getItem('dm_pg')||'dashboard';
        document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
        const vpt=document.getElementById('vpt'); if(vpt) vpt.classList.add('on');
        initPortal().then(()=>{ const lov=document.getElementById('lov'); if(lov){ lov.classList.add('fade'); setTimeout(()=>{ try{ lov.remove(); }catch(e){} },520); } }).catch(()=>{ sessionStorage.removeItem('dm_sess'); sessionStorage.removeItem('dm_pg'); S.user=null; S.role=null; bootLanding(); });
        return;
      }else{sessionStorage.removeItem('dm_sess');sessionStorage.removeItem('dm_pg');}
    }
  }catch(e){console.warn('Session err:',e);}
  bootLanding();
});
// Failsafe: if DOMContentLoaded already fired
if (document.readyState === 'complete' || document.readyState === 'interactive') {
  const vl = document.getElementById('vl');
  if (vl && !vl.classList.contains('on')) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('on'));
    vl.classList.add('on');
    try { initLanding(); } catch(e) {}
    const lov = document.getElementById('lov');
    if (lov) { lov.classList.add('fade'); setTimeout(() => { try { lov.remove(); } catch(e) {} }, 520); }
  }
}
window.addEventListener('beforeunload', e => {
  if(S.role&&S.user){ e.preventDefault(); e.returnValue=''; }
});
window.addEventListener('resize', () => {
  const w=window.innerWidth;
  const ag=$id('about-grid');if(ag)ag.style.gridTemplateColumns=w<860?'1fr':'1fr 1fr';
  const cg=$id('contact-grid');if(cg)cg.style.gridTemplateColumns=w<860?'1fr':'1fr 1fr';
  const fg=$id('footer-g');if(fg)fg.style.gridTemplateColumns=w<540?'1fr':w<860?'repeat(2,1fr)':'1.8fr 1fr 1fr 1.2fr';
  const sg=$id('stats-grid');if(sg)sg.style.gridTemplateColumns=w<600?'repeat(2,1fr)':'repeat(3,1fr)';
},{passive:true});
</script>

<script>
/* ══════════════════════════════════════════════════════════════
   D-MATHS LANDING — Visual Enhancement Script
   PURELY VISUAL: scroll animations, cursor, counters, progress
   Zero logic touched.
   ══════════════════════════════════════════════════════════════ */
(function(){
  'use strict';

  /* ── Only activate on the landing view ── */
  function isLanding(){
    var vl=document.getElementById('vl');
    return vl&&(vl.classList.contains('on')||vl.style.display!=='none');
  }

  /* ── SCROLL PROGRESS BAR ── */
  var prog=document.getElementById('scroll-progress');
  function updateProgress(){
    if(!isLanding()||!prog){return;}
    var scrolled=window.scrollY;
    var total=document.documentElement.scrollHeight-window.innerHeight;
    var pct=total>0?Math.min(100,scrolled/total*100):0;
    prog.style.width=pct+'%';
  }

  /* ── SCROLL-TO-TOP ── */
  var scrollTopBtn=document.getElementById('scroll-top');
  function updateScrollTop(){
    if(!scrollTopBtn)return;
    if(window.scrollY>500){scrollTopBtn.classList.add('visible');}
    else{scrollTopBtn.classList.remove('visible');}
  }

  /* ── NAV SCROLL STATE ── */
  function updateNav(){
    var nav=document.getElementById('lnav');
    if(!nav)return;
    if(window.scrollY>60){nav.classList.add('scrolled');}
    else{nav.classList.remove('scrolled');}
  }

  /* ── CURSOR GLOW ── */
  var cg=document.getElementById('cursor-glow');
  var cgX=0,cgY=0,cgTX=0,cgTY=0;
  var cgActive=false;
  if(window.matchMedia('(pointer:fine)').matches&&cg){
    document.addEventListener('mousemove',function(e){
      if(!isLanding()){cg.style.opacity='0';return;}
      cgTX=e.clientX;cgTY=e.clientY;
      if(!cgActive){cg.style.opacity='1';cgActive=true;}
    });
    document.addEventListener('mouseleave',function(){cg.style.opacity='0';cgActive=false;});
    function animCursor(){
      cgX+=(cgTX-cgX)*.08;
      cgY+=(cgTY-cgY)*.08;
      if(cg)cg.style.transform='translate('+cgX+'px,'+cgY+'px) translate(-50%,-50%)';
      requestAnimationFrame(animCursor);
    }
    animCursor();
  }

  /* ── INTERSECTION OBSERVER REVEAL ── */
  var revealObs=null;
  if('IntersectionObserver' in window){
    revealObs=new IntersectionObserver(function(entries){
      entries.forEach(function(entry){
        if(entry.isIntersecting){
          entry.target.classList.add('revealed');
          revealObs.unobserve(entry.target);
        }
      });
    },{threshold:.12,rootMargin:'0px 0px -40px 0px'});
  }

  /* ── APPLY REVEAL CLASSES TO LANDING SECTIONS ── */
  function applyRevealClasses(){
    var vl=document.getElementById('vl');
    if(!vl)return;

    /* About section */
    var aboutGrid=document.getElementById('about-grid');
    if(aboutGrid){
      var kids=aboutGrid.children;
      if(kids[0]){kids[0].classList.add('reveal-left');}
      if(kids[1]){kids[1].classList.add('reveal-right');}
    }

    /* Subjects grid — stagger each card */
    var subsGrid=document.getElementById('subs-grid');
    if(subsGrid){
      var cards=subsGrid.children;
      for(var i=0;i<cards.length;i++){
        cards[i].classList.add('reveal-scale');
        if(i<6)cards[i].classList.add('stagger-'+(i+1));
      }
    }

    /* How it works steps */
    var stepsGrid=document.getElementById('steps-grid');
    if(stepsGrid){
      var steps=stepsGrid.children;
      for(var j=0;j<steps.length;j++){
        steps[j].classList.add('reveal');
        if(j<6)steps[j].classList.add('stagger-'+(j+1));
      }
    }

    /* Stats grid */
    var statsGrid=document.getElementById('stats-grid');
    if(statsGrid){
      var sts=statsGrid.children;
      for(var k=0;k<sts.length;k++){
        sts[k].classList.add('reveal');
        sts[k].classList.add('stagger-'+(k+1));
      }
    }

    /* Testimonials */
    var testGrid=document.getElementById('test-grid');
    if(testGrid){
      var tests=testGrid.children;
      for(var m=0;m<tests.length;m++){
        tests[m].classList.add('reveal');
        tests[m].classList.add('stagger-'+(m%6+1));
      }
    }

    /* Programs */
    var progGrid=document.getElementById('programs-grid');
    if(progGrid){
      var progs=progGrid.children;
      for(var n=0;n<progs.length;n++){
        progs[n].classList.add('reveal-scale');
        if(n<4)progs[n].classList.add('stagger-'+(n+1));
      }
    }

    /* Section headings */
    vl.querySelectorAll('.stitle,.eyebrow,.ssub').forEach(function(el){
      if(!el.closest('#lnav')&&!el.classList.contains('reveal')&&!el.classList.contains('reveal-scale')){
        el.classList.add('reveal');
      }
    });

    /* Observe all reveal elements */
    if(revealObs){
      vl.querySelectorAll('.reveal,.reveal-left,.reveal-right,.reveal-scale').forEach(function(el){
        revealObs.observe(el);
      });
    } else {
      /* Fallback: show everything immediately */
      vl.querySelectorAll('.reveal,.reveal-left,.reveal-right,.reveal-scale').forEach(function(el){
        el.classList.add('revealed');
      });
    }
  }

  /* ── ANIMATED COUNTER ── */
  function animateCounter(el,target,duration){
    var start=performance.now();
    var startVal=0;
    function step(now){
      var elapsed=now-start;
      var progress=Math.min(elapsed/duration,1);
      /* ease out cubic */
      var eased=1-Math.pow(1-progress,3);
      var current=Math.round(startVal+(target-startVal)*eased);
      el.textContent=current;
      if(progress<1)requestAnimationFrame(step);
      else el.textContent=target;
    }
    requestAnimationFrame(step);
  }

  function initCounters(){
    var statsGrid=document.getElementById('stats-grid');
    if(!statsGrid)return;
    var counterObs=new IntersectionObserver(function(entries){
      entries.forEach(function(entry){
        if(!entry.isIntersecting)return;
        /* find number elements */
        entry.target.querySelectorAll('.scount').forEach(function(el){
          var txt=el.textContent.replace(/[^0-9]/g,'');
          var num=parseInt(txt,10);
          if(!isNaN(num)&&num>0){
            el.dataset.target=num;
            el.dataset.suffix=el.textContent.replace(/[0-9]/g,'');
            animateCounter(el,num,1800);
            setTimeout(function(){
              if(el.dataset.suffix)el.textContent=num+el.dataset.suffix;
            },1850);
          }
        });
        counterObs.unobserve(entry.target);
      });
    },{threshold:.5});
    counterObs.observe(statsGrid);
  }

  /* ── ACTIVE NAV LINK ON SCROLL ── */
  function updateActiveNav(){
    if(!isLanding())return;
    var sections=document.querySelectorAll('#vl section[id]');
    var current='';
    sections.forEach(function(sec){
      var rect=sec.getBoundingClientRect();
      if(rect.top<=120&&rect.bottom>120)current=sec.id;
    });
    document.querySelectorAll('.llink').forEach(function(link){
      var onclick=link.getAttribute('onclick')||'';
      var isActive=onclick.indexOf("'"+current+"'")!==-1||onclick.indexOf('"'+current+'"')!==-1;
      link.classList.toggle('active',isActive);
    });
  }

  /* ── PARALLAX SUBTLE (hero only) ── */
  function updateParallax(){
    if(!isLanding())return;
    var hero=document.querySelector('#home');
    if(!hero)return;
    var scroll=window.scrollY;
    var orbs=document.querySelectorAll('#hero-aurora .orb');
    orbs.forEach(function(orb,i){
      var speed=0.03*(i+1);
      orb.style.transform='translateY('+scroll*speed+'px)';
    });
    var msyms=document.querySelectorAll('.msym');
    msyms.forEach(function(sym,i){
      var speed=0.015*(i%3+1);
      sym.style.transform='translateY('+scroll*speed+'px)';
    });
  }

  /* ── SCROLL HANDLER ── */
  var ticking=false;
  window.addEventListener('scroll',function(){
    if(!ticking){
      requestAnimationFrame(function(){
        updateProgress();
        updateScrollTop();
        updateNav();
        updateActiveNav();
        updateParallax();
        ticking=false;
      });
      ticking=true;
    }
  },{passive:true});

  /* ── INIT ON DOMCONTENTLOADED ── */
  function init(){
    updateProgress();
    updateScrollTop();
    updateNav();

    /* init counters */
    if('IntersectionObserver' in window) initCounters();

    /* Apply reveal classes — run after initLanding populates the DOM */
    /* Use MutationObserver to detect when dynamic content is injected */
    var subsGrid=document.getElementById('subs-grid');
    if(subsGrid&&subsGrid.children.length>0){
      applyRevealClasses();
    } else {
      /* Wait for initLanding to run — observe subs-grid for first child */
      if('MutationObserver' in window){
        var mo=new MutationObserver(function(mutations,obs){
          var sg=document.getElementById('subs-grid');
          if(sg&&sg.children.length>0){
            obs.disconnect();
            applyRevealClasses();
          }
        });
        mo.observe(document.body,{childList:true,subtree:true});
        /* Fallback timeout */
        setTimeout(function(){applyRevealClasses();},800);
      } else {
        setTimeout(function(){applyRevealClasses();},600);
      }
    }
  }

  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded',init);
  } else {
    init();
  }

  /* ── RE-APPLY when landing becomes visible again ── */
  /* Watch for the 'on' class being added to #vl */
  if('MutationObserver' in window){
    var vlObs=new MutationObserver(function(mutations){
      mutations.forEach(function(mut){
        if(mut.target.id==='vl'&&mut.target.classList.contains('on')){
          setTimeout(function(){
            applyRevealClasses();
            updateProgress();
            updateNav();
          },100);
        }
      });
    });
    var vl=document.getElementById('vl');
    if(vl)vlObs.observe(vl,{attributes:true,attributeFilter:['class']});
  }

})();
</script>


<!-- ═══════ GLOBAL SEARCH OVERLAY ═══════ -->
<div id="search-overlay" onclick="if(event.target===this)closeSearch()">
  <div id="search-box">
    <div id="search-input-wrap">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--g400)" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input id="search-input" placeholder="Search students, assignments, classes, notices…" oninput="runSearch(this.value)" autocomplete="off">
      <button onclick="closeSearch()" style="background:var(--g100);border:none;border-radius:99px;width:26px;height:26px;cursor:pointer;color:var(--g500);font-size:16px;display:flex;align-items:center;justify-content:center">×</button>
    </div>
    <div id="search-results"><div id="search-empty" style="display:none">No results found</div></div>
  </div>
</div>
</body>
</html>
